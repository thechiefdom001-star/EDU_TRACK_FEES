<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edu-Track CBE Pro | Junior School Fees Management</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <style>
        :root {
            --primary-color: #1a5f7a;
            --secondary-color: #57cc99;
            --accent-color: #ff9a3c;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --danger-color: #dc3545;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --border-radius: 8px;
            --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --sidebar-width: 250px;
            --header-height: 70px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            min-height: 100vh;
        }
        
        /* Login Screen */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            background: linear-gradient(135deg, var(--primary-color) 0%, #2c3e50 100%);
        }
        
        .login-box {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 40px;
            width: 100%;
            max-width: 400px;
            box-shadow: var(--box-shadow);
        }
        
        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .login-logo {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            color: white;
            font-size: 2.5rem;
        }
        
        .login-header h1 {
            color: var(--primary-color);
            margin-bottom: 5px;
        }
        
        .login-header p {
            color: #666;
            font-size: 0.9rem;
        }
        
        .login-form .form-group {
            margin-bottom: 20px;
        }
        
        .login-form label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }
        
        .login-form input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 1rem;
        }
        
        .login-form input:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        .login-btn {
            width: 100%;
            padding: 12px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .login-btn:hover {
            background-color: #15455c;
        }
        
        /* Button Notification Icons */
        .btn-notification {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0;
            transition: all 0.3s ease;
        }
        
        .btn-success .btn-notification {
            color: white;
        }
        
        .btn-show-notification .btn-notification {
            opacity: 1;
            animation: bounceIn 0.5s ease;
        }
        
        .btn-success.btn-show-notification {
            background-color: var(--success-color);
        }
        
        .btn-danger.btn-show-notification {
            background-color: var(--danger-color);
        }
        
        @keyframes bounceIn {
            0% {
                transform: translateY(-50%) scale(0);
                opacity: 0;
            }
            50% {
                transform: translateY(-50%) scale(1.2);
            }
            100% {
                transform: translateY(-50%) scale(1);
                opacity: 1;
            }
        }
        
        /* Main Container */
        .container {
            display: flex;
            min-height: 100vh;
        }
        
        /* Sidebar Styles */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--primary-color);
            color: white;
            display: flex;
            flex-direction: column;
            box-shadow: var(--box-shadow);
            z-index: 100;
            transition: transform 0.3s ease;
        }
        
        .logo-area {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
            height: var(--header-height);
        }
        
        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .logo-img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            background-color: white;
            padding: 3px;
        }
        
        .logo-text h2 {
            font-size: 1.2rem;
            font-weight: 700;
        }
        
        .logo-text p {
            font-size: 0.7rem;
            opacity: 0.8;
        }
        
        .menu {
            flex: 1;
            padding: 20px 0;
            overflow-y: auto;
        }
        
        .menu-item {
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }
        
        .menu-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .menu-item.active {
            background-color: rgba(255, 255, 255, 0.15);
            border-left: 4px solid var(--secondary-color);
        }
        
        .menu-item i {
            width: 20px;
            text-align: center;
        }
        
        .user-area {
            padding: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--secondary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .mobile-menu-toggle {
            display: none;
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 1001;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            width: 45px;
            height: 45px;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            cursor: pointer;
        }
        
        /* Main Content Styles */
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eaeaea;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .header h1 {
            color: var(--primary-color);
            font-size: 1.5rem;
        }
        
        .date-display {
            font-weight: 600;
            color: #666;
        }
        
        /* Alarm Badge */
        .alarm-badge {
            position: relative;
            margin-left: 10px;
        }
        
        .alarm-count {
            position: absolute;
            top: -8px;
            right: -8px;
            background-color: var(--danger-color);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        /* Stats Container */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--box-shadow);
            display: flex;
            align-items: center;
            gap: 15px;
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        
        .stat-1 .stat-icon {
            background-color: rgba(87, 204, 153, 0.2);
            color: var(--success-color);
        }
        
        .stat-2 .stat-icon {
            background-color: rgba(255, 154, 60, 0.2);
            color: var(--accent-color);
        }
        
        .stat-3 .stat-icon {
            background-color: rgba(26, 95, 122, 0.2);
            color: var(--primary-color);
        }
        
        .stat-4 .stat-icon {
            background-color: rgba(220, 53, 69, 0.2);
            color: var(--danger-color);
        }
        
        .stat-info h3 {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }
        
        .stat-info p {
            color: #666;
            font-size: 0.9rem;
        }
        
        /* Content Area Styles */
        .content-area {
            display: none;
        }
        
        .content-area.active {
            display: block;
        }
        
        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
            min-width: 150px;
            flex: 1;
        }
        
        .filter-group label {
            font-size: 0.85rem;
            font-weight: 600;
            color: #555;
        }
        
        select, input, button, textarea {
            padding: 10px 15px;
            border-radius: var(--border-radius);
            border: 1px solid #ddd;
            font-size: 0.9rem;
        }
        
        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-weight: 600;
            white-space: nowrap;
            position: relative;
            overflow: hidden;
        }
        
        button:hover {
            background-color: #15455c;
        }
        
        .btn-success {
            background-color: var(--success-color);
        }
        
        .btn-success:hover {
            background-color: #218838;
        }
        
        .btn-danger {
            background-color: var(--danger-color);
        }
        
        .btn-danger:hover {
            background-color: #c82333;
        }
        
        .btn-warning {
            background-color: var(--warning-color);
            color: #212529;
        }
        
        .btn-warning:hover {
            background-color: #e0a800;
        }
        
        .btn-info {
            background-color: var(--info-color);
        }
        
        .btn-info:hover {
            background-color: #138496;
        }
        
        .btn-secondary {
            background-color: #6c757d;
        }
        
        .btn-secondary:hover {
            background-color: #5a6268;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 0.8rem;
        }
        
        .btn-icon {
            padding: 8px 12px;
            font-size: 0.9rem;
        }
        
        /* Table Styles */
        .table-container {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow: hidden;
            margin-bottom: 20px;
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }
        
        thead {
            background-color: var(--primary-color);
            color: white;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        .actions {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        
        .badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .badge-success {
            background-color: rgba(40, 167, 69, 0.2);
            color: var(--success-color);
        }
        
        .badge-warning {
            background-color: rgba(255, 193, 7, 0.2);
            color: #e0a800;
        }
        
        .badge-danger {
            background-color: rgba(220, 53, 69, 0.2);
            color: var(--danger-color);
        }
        
        .badge-info {
            background-color: rgba(23, 162, 184, 0.2);
            color: var(--info-color);
        }
        
        .badge-primary {
            background-color: rgba(26, 95, 122, 0.2);
            color: var(--primary-color);
        }
        
        .table-footer {
            padding: 15px;
            background-color: #f8f9fa;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid #eee;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .total-amount {
            font-weight: 700;
            color: var(--primary-color);
            font-size: 1.1rem;
        }
        
        /* Form Styles */
        .form-container {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 25px;
            margin: 0 auto;
        }
        
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .form-group {
            flex: 1;
            min-width: 200px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .form-group label {
            font-weight: 600;
            color: #555;
            font-size: 0.9rem;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 0.9rem;
        }
        
        /* Fee Items Cards - FIXED VISIBILITY */
        .fee-items-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .fee-item-card {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--box-shadow);
            border-left: 4px solid var(--primary-color);
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .fee-item-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
        }
        
        .fee-item-card.required {
            border-left-color: var(--danger-color);
        }
        
        .fee-item-card.inactive {
            opacity: 0.8;
            border-left-color: #ccc;
        }
        
        .fee-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }
        
        .fee-item-name {
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--primary-color);
        }
        
        .fee-item-card.required .fee-item-name {
            color: var(--danger-color);
        }
        
        .fee-item-card.inactive .fee-item-name {
            color: #666;
        }
        
        .fee-item-amount {
            font-weight: 700;
            font-size: 1.2rem;
            color: var(--success-color);
        }
        
        .fee-item-details {
            margin: 10px 0;
            color: #666;
            font-size: 0.9rem;
            line-height: 1.4;
        }
        
        .fee-item-actions {
            display: flex;
            gap: 8px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        /* Fee Selection in Student Registration */
        .fee-selection-container {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #eee;
            border-radius: var(--border-radius);
            background-color: #f8f9fa;
        }
        
        .fee-selection-title {
            margin-bottom: 15px;
            color: var(--primary-color);
            font-size: 1.1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .fee-selection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .fee-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            background-color: white;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .fee-option:hover {
            border-color: var(--primary-color);
            background-color: #f8f9fa;
        }
        
        .fee-option.required {
            border-left: 4px solid var(--danger-color);
        }
        
        .fee-option input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .fee-option label {
            flex: 1;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background-color: white;
            border-radius: var(--border-radius);
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--primary-color);
            color: white;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
        }
        
        .modal-header h2 {
            color: white;
            font-size: 1.5rem;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: white;
            cursor: pointer;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 30px;
            height: 30px;
        }
        
        /* School Logo Styles */
        .school-logo-display {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: contain;
            border: 3px solid var(--primary-color);
            background-color: white;
            padding: 5px;
        }
        
        .logo-preview-small {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: contain;
            background-color: white;
            border: 1px solid #ddd;
        }
        
        .print-logo {
            width: 80px;
            height: 80px;
            object-fit: contain;
        }
        
        /* Print Styles */
        @media print {
            * {
                color: #000 !important;
                background: #fff !important;
                box-shadow: none !important;
                text-shadow: none !important;
            }
            
            .sidebar, .header, .filters, .actions, .table-footer button, .mobile-menu-toggle,
            .reminder-actions, .modal-footer, .close-modal, button, .no-print {
                display: none !important;
            }
            
            .container {
                display: block;
            }
            
            .main-content {
                padding: 0 !important;
                margin: 0 !important;
            }
            
            .table-container {
                box-shadow: none !important;
                border: 1px solid #000 !important;
            }
            
            table {
                border: 1px solid #000 !important;
            }
            
            th, td {
                border: 1px solid #000 !important;
                color: #000 !important;
            }
            
            th {
                background-color: #f2f2f2 !important;
                color: #000 !important;
                -webkit-print-color-adjust: exact !important;
            }
            
            .print-header {
                display: flex !important;
                flex-direction: column;
                align-items: center;
                text-align: center;
                margin-bottom: 30px;
                padding-bottom: 20px;
                border-bottom: 2px solid #000;
                page-break-after: avoid;
            }
            
            .print-footer {
                display: block !important;
                text-align: center;
                margin-top: 30px;
                padding-top: 20px;
                border-top: 2px solid #000;
                font-size: 0.8rem;
                color: #000 !important;
                page-break-before: avoid;
            }
            
            .print-logo-container {
                display: flex !important;
                align-items: center;
                justify-content: center;
                margin-bottom: 10px;
            }
            
            .print-title {
                font-size: 20px !important;
                font-weight: bold !important;
                margin: 10px 0 !important;
                color: #000 !important;
            }
            
            .print-date {
                font-size: 14px !important;
                margin-bottom: 20px !important;
            }
            
            /* Prevent page breaks inside important elements */
            .stat-card, .reminder-card, .fee-item-card {
                page-break-inside: avoid;
            }
            
            tr {
                page-break-inside: avoid;
            }
            
            /* Print-specific spacing */
            .content-area {
                margin-top: 0 !important;
            }
        }
        
        /* Reminder Cards */
        .reminder-card {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--box-shadow);
            margin-bottom: 20px;
            border-left: 4px solid var(--warning-color);
        }
        
        .reminder-card.overdue {
            border-left-color: var(--danger-color);
            animation: pulse-border 2s infinite;
        }
        
        @keyframes pulse-border {
            0% { border-left-color: var(--danger-color); }
            50% { border-left-color: #ff8a8a; }
            100% { border-left-color: var(--danger-color); }
        }
        
        .reminder-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .reminder-student {
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .reminder-amount {
            font-weight: 700;
            color: var(--danger-color);
        }
        
        .reminder-details {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: var(--border-radius);
            margin: 15px 0;
        }
        
        .reminder-message {
            color: #666;
            line-height: 1.5;
            margin-bottom: 15px;
        }
        
        /* Fee Balance Details */
        .fee-balance-details {
            margin: 15px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: var(--border-radius);
        }
        
        .fee-balance-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        
        .fee-balance-item:last-child {
            border-bottom: none;
        }
        
        /* Data Management Styles */
        .data-management-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .sync-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
        }
        
        .sync-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        .sync-indicator.synced {
            background-color: var(--success-color);
        }
        
        .sync-indicator.pending {
            background-color: var(--warning-color);
            animation: pulse 1.5s infinite;
        }
        
        .sync-indicator.error {
            background-color: var(--danger-color);
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        /* Utility Classes */
        .currency {
            font-family: 'Courier New', monospace;
            font-weight: 600;
        }
        
        .text-center {
            text-align: center;
        }
        
        .mt-20 {
            margin-top: 20px;
        }
        
        .mb-20 {
            margin-bottom: 20px;
        }
        
        .hidden {
            display: none;
        }
        
        .print-header, .print-footer {
            display: none;
        }
        
        /* Receipt Styles */
        .receipt-container {
            padding: 30px;
            font-family: 'Arial', sans-serif;
        }
        
        .receipt-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 20px;
        }
        
        .receipt-logo {
            width: 100px;
            height: 100px;
            margin: 0 auto 15px;
            display: block;
            object-fit: contain;
        }
        
        .receipt-details {
            margin: 20px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: var(--border-radius);
        }
        
        .receipt-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        .receipt-table th {
            background-color: var(--primary-color);
            color: white;
            padding: 10px;
            text-align: left;
        }
        
        .receipt-table td {
            padding: 10px;
            border-bottom: 1px solid #ddd;
        }
        
        .receipt-totals {
            margin-top: 20px;
            text-align: right;
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .receipt-footer {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px dashed #ddd;
            text-align: center;
            font-size: 0.9rem;
            color: #666;
        }
        
        /* Hidden Form for Fee Items */
        .fee-form-container {
            display: none;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 25px;
            margin-bottom: 20px;
            animation: slideDown 0.3s ease;
        }
        
        .fee-form-container.active {
            display: block;
        }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Fee Item Status Badges */
        .fee-item-status {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        
        /* Responsive Styles */
        @media (max-width: 992px) {
            .sidebar {
                position: fixed;
                top: 0;
                left: 0;
                height: 100vh;
                transform: translateX(-100%);
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .mobile-menu-toggle {
                display: flex;
            }
            
            .main-content {
                padding-top: 80px;
            }
            
            .header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .fee-items-list {
                grid-template-columns: 1fr;
            }
            
            .fee-selection-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .filters {
                flex-direction: column;
            }
            
            .filter-group {
                min-width: 100%;
            }
            
            .actions {
                flex-direction: column;
            }
            
            .form-row {
                flex-direction: column;
            }
            
            .form-group {
                min-width: 100%;
            }
            
            .stats-container {
                grid-template-columns: 1fr;
            }
            
            .login-box {
                padding: 30px 20px;
            }
            
            .receipt-container {
                padding: 15px;
            }
            
            .fee-item-actions {
                flex-direction: column;
            }
            
            .fee-item-actions button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="login-screen" class="login-container">
        <div class="login-box">
            <div class="login-header">
                <div class="login-logo">
                    <i class="fas fa-graduation-cap"></i>
                </div>
                <h1>Edu-Track CBE Pro</h1>
                <p>Junior School Fees Management System</p>
            </div>
            <form class="login-form" id="login-form">
                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" placeholder="Enter username" required>
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" placeholder="Enter password" required>
                </div>
                <button type="submit" class="login-btn" id="login-submit-btn">
                    <i class="fas fa-sign-in-alt"></i> Login
                    <span class="btn-notification"><i class="fas fa-check"></i></span>
                </button>
                <div class="form-group mt-20">
                    <p class="text-center">Default credentials: admin / admin002</p>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Main Application -->
    <div id="app-container" class="container hidden">
        <!-- Mobile Menu Toggle -->
        <button class="mobile-menu-toggle" id="mobile-menu-toggle">
            <i class="fas fa-bars"></i>
            <span class="btn-notification"><i class="fas fa-check"></i></span>
        </button>
        
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="logo-area">
                <div class="logo">
                    <div class="logo-icon" style="display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; background-color: var(--secondary-color); color: white; border-radius: 50%;">
                        <i class="fas fa-graduation-cap"></i>
                    </div>
                    <div class="logo-text">
                        <h2>Edu-Track CBE Pro</h2>
                        <p>Junior School (G7-9)</p>
                    </div>
                </div>
            </div>
            
            <div class="menu">
                <div class="menu-item active" data-target="dashboard">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </div>
                <div class="menu-item" data-target="student-register">
                    <i class="fas fa-user-graduate"></i>
                    <span>Student Register</span>
                </div>
                <div class="menu-item" data-target="fee-register">
                    <i class="fas fa-file-invoice-dollar"></i>
                    <span>Fee Register</span>
                </div>
                <div class="menu-item" data-target="fee-reminders">
                    <i class="fas fa-bell"></i>
                    <span>Fee Reminders</span>
                    <div class="alarm-badge">
                        <div class="alarm-count" id="alarm-count">0</div>
                    </div>
                </div>
                <div class="menu-item" data-target="fee-setting">
                    <i class="fas fa-cog"></i>
                    <span>Fee Setting</span>
                </div>
                <div class="menu-item" data-target="app-setting">
                    <i class="fas fa-sliders-h"></i>
                    <span>App Setting</span>
                </div>
                <div class="menu-item" data-target="data-management">
                    <i class="fas fa-database"></i>
                    <span>Data Management</span>
                </div>
            </div>
            
            <div class="user-area">
                <div class="user-avatar">AD</div>
                <div>
                    <div class="user-name">Administrator</div>
                    <div class="user-role">Administrator</div>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Print Header for All Pages -->
            <div class="print-header" id="print-header">
                <div class="print-logo-container">
                    <img id="print-logo" class="print-logo" src="" alt="School Logo">
                </div>
                <div class="print-title" id="print-school-name">Edu-Track Junior Academy</div>
                <div id="print-school-address">P.O. Box 12345, Nairobi, Kenya</div>
                <div id="print-school-contact">Tel: +254 712 345 678 | Email: info@edutrack.ac.ke</div>
                <div class="print-date" id="print-current-date"></div>
                <hr style="border-top: 2px solid #000; margin: 10px 0;">
            </div>
            
            <div class="header">
                <h1 id="page-title">Dashboard Overview</h1>
                <div class="date-display" id="current-date"></div>
            </div>
            
            <!-- Dashboard Content -->
            <div id="dashboard" class="content-area active">
                <div class="sync-status" id="sync-status">
                    <div class="sync-indicator synced" id="sync-indicator"></div>
                    <span id="sync-message">All data synced locally</span>
                </div>
                
                <div class="stats-container">
                    <div class="stat-card stat-1">
                        <div class="stat-icon">
                            <i class="fas fa-user-graduate"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="total-students-count">0</h3>
                            <p>Total Students</p>
                        </div>
                    </div>
                    
                    <div class="stat-card stat-2">
                        <div class="stat-icon">
                            <i class="fas fa-hand-holding-usd"></i>
                        </div>
                        <div class="stat-info">
                            <h3 class="currency" id="total-fees-collected">KES 0</h3>
                            <p>Total Fees Collected</p>
                        </div>
                    </div>
                    
                    <div class="stat-card stat-3">
                        <div class="stat-icon">
                            <i class="fas fa-exclamation-circle"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="students-with-arrears">0</h3>
                            <p>Students with Arrears</p>
                        </div>
                    </div>
                    
                    <div class="stat-card stat-4">
                        <div class="stat-icon">
                            <i class="fas fa-credit-card"></i>
                        </div>
                        <div class="stat-info">
                            <h3 class="currency" id="total-arrears">KES 0</h3>
                            <p>Total Fee Arrears</p>
                        </div>
                    </div>
                </div>
                
                <div class="content-header">
                    <h2>Recent Fee Transactions</h2>
                    <button id="print-dashboard">
                        <i class="fas fa-print"></i> Print Report
                        <span class="btn-notification"><i class="fas fa-check"></i></span>
                    </button>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Receipt No</th>
                                <th>Student Name</th>
                                <th>Class</th>
                                <th>Fee Type</th>
                                <th>Amount (KES)</th>
                                <th>Date Paid</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="dashboard-table-body">
                            <!-- Data will be loaded dynamically -->
                        </tbody>
                    </table>
                    <div class="table-footer">
                        <div class="total-amount">Total Collected: <span class="currency" id="dashboard-total">KES 0</span></div>
                        <button id="print-dashboard-table">
                            <i class="fas fa-print"></i> Print Table
                            <span class="btn-notification"><i class="fas fa-check"></i></span>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Student Register Content -->
            <div id="student-register" class="content-area">
                <div class="content-header">
                    <h2>Student Register</h2>
                    <button id="add-student-btn">
                        <i class="fas fa-user-plus"></i> Add New Student
                        <span class="btn-notification"><i class="fas fa-check"></i></span>
                    </button>
                </div>
                
                <div class="filters">
                    <div class="filter-group">
                        <label for="student-class-filter">Filter by Class</label>
                        <select id="student-class-filter">
                            <option value="all">All Classes</option>
                            <option value="grade7">Grade 7</option>
                            <option value="grade8">Grade 8</option>
                            <option value="grade9">Grade 9</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="student-search">Search Student</label>
                        <input type="text" id="student-search" placeholder="Enter name or ID">
                    </div>
                    
                    <button id="apply-student-filter" class="btn-secondary">
                        <i class="fas fa-filter"></i> Apply Filter
                        <span class="btn-notification"><i class="fas fa-check"></i></span>
                    </button>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Student ID</th>
                                <th>Full Name</th>
                                <th>Class</th>
                                <th>Parent Name</th>
                                <th>Contact</th>
                                <th>Total Fees</th>
                                <th>Paid</th>
                                <th>Balance</th>
                                <th>Due Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="student-table-body">
                            <!-- Data will be loaded dynamically -->
                        </tbody>
                    </table>
                    <div class="table-footer">
                        <div>Total Students: <strong id="total-students">0</strong></div>
                        <button id="print-student-register">
                            <i class="fas fa-print"></i> Print Register
                            <span class="btn-notification"><i class="fas fa-check"></i></span>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Fee Register Content -->
            <div id="fee-register" class="content-area">
                <div class="content-header">
                    <h2>Fee Register</h2>
                    <button id="add-fee-transaction">
                        <i class="fas fa-plus-circle"></i> Add Fee Payment
                        <span class="btn-notification"><i class="fas fa-check"></i></span>
                    </button>
                </div>
                
                <div class="filters">
                    <div class="filter-group">
                        <label for="fee-class-filter">Filter by Class</label>
                        <select id="fee-class-filter">
                            <option value="all">All Classes</option>
                            <option value="grade7">Grade 7</option>
                            <option value="grade8">Grade 8</option>
                            <option value="grade9">Grade 9</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="fee-student-filter">Filter by Student</label>
                        <select id="fee-student-filter">
                            <option value="all">All Students</option>
                        </select>
                    </div>
                    
                    <button id="apply-fee-filter" class="btn-secondary">
                        <i class="fas fa-filter"></i> Apply Filter
                        <span class="btn-notification"><i class="fas fa-check"></i></span>
                    </button>
                </div>
                
                <div class="table-container">
                    <table id="fee-register-table">
                        <thead>
                            <tr>
                                <th>Student Name</th>
                                <th>Class</th>
                                <th>Total Fees</th>
                                <th>Total Paid</th>
                                <th>Balance</th>
                                <th>Admission</th>
                                <th>Caution</th>
                                <th>Term 1</th>
                                <th>Term 2</th>
                                <th>Term 3</th>
                                <th>PTA</th>
                                <th>Assessment</th>
                                <th>Project</th>
                                <th>Badge & Tie</th>
                                <th>School ID</th>
                                <th>Uniform</th>
                                <th>Academic Welfare</th>
                                <th>Activity</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="fee-table-body">
                            <!-- Data will be loaded dynamically -->
                        </tbody>
                        <tfoot id="fee-table-footer">
                            <!-- Footer totals will be loaded dynamically -->
                        </tfoot>
                    </table>
                    <div class="table-footer">
                        <div class="total-amount">Grand Total: <span class="currency" id="fee-grand-total">KES 0</span></div>
                        <div>
                            <button id="print-fee-register">
                                <i class="fas fa-print"></i> Print Register
                                <span class="btn-notification"><i class="fas fa-check"></i></span>
                            </button>
                            <button id="export-fee-register" class="btn-secondary">
                                <i class="fas fa-file-export"></i> Export
                                <span class="btn-notification"><i class="fas fa-check"></i></span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Fee Reminders Content -->
            <div id="fee-reminders" class="content-area">
                <div class="content-header">
                    <h2>Fee Reminders</h2>
                    <div>
                        <button id="print-all-reminders" class="btn-warning">
                            <i class="fas fa-print"></i> Print All Reminders
                            <span class="btn-notification"><i class="fas fa-check"></i></span>
                        </button>
                        <button id="print-overdue-reminders" class="btn-danger">
                            <i class="fas fa-print"></i> Print Overdue Only
                            <span class="btn-notification"><i class="fas fa-check"></i></span>
                        </button>
                        <button id="send-all-reminders">
                            <i class="fas fa-paper-plane"></i> Send All Reminders
                            <span class="btn-notification"><i class="fas fa-check"></i></span>
                        </button>
                    </div>
                </div>
                
                <div class="filters">
                    <div class="filter-group">
                        <label for="reminder-class-filter">Filter by Class</label>
                        <select id="reminder-class-filter">
                            <option value="all">All Classes</option>
                            <option value="grade7">Grade 7</option>
                            <option value="grade8">Grade 8</option>
                            <option value="grade9">Grade 9</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="reminder-student-filter">Filter by Student</label>
                        <select id="reminder-student-filter">
                            <option value="all">All Students</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="reminder-status-filter">Filter by Status</label>
                        <select id="reminder-status-filter">
                            <option value="all">All</option>
                            <option value="overdue">Overdue</option>
                            <option value="due_soon">Due Soon</option>
                            <option value="paid">Paid</option>
                        </select>
                    </div>
                    
                    <button id="apply-reminder-filter" class="btn-secondary">
                        <i class="fas fa-filter"></i> Apply Filter
                        <span class="btn-notification"><i class="fas fa-check"></i></span>
                    </button>
                </div>
                
                <div id="reminders-container">
                    <!-- Reminders will be loaded dynamically -->
                </div>
            </div>
            
            <!-- Fee Setting Content - FIXED VISIBILITY -->
            <div id="fee-setting" class="content-area">
                <div class="content-header">
                    <h2>Fee Structure Management</h2>
                    <div>
                        <button id="save-fee-settings" class="btn-success">
                            <i class="fas fa-save"></i> Save All Changes
                            <span class="btn-notification"><i class="fas fa-check"></i></span>
                        </button>
                        <button id="add-new-fee-item" class="btn-info">
                            <i class="fas fa-plus"></i> Add New Fee Item
                            <span class="btn-notification"><i class="fas fa-check"></i></span>
                        </button>
                    </div>
                </div>
                
                <!-- Hidden Fee Item Form -->
                <div id="fee-item-form-container" class="fee-form-container">
                    <h3 class="text-center mb-20">Add/Edit Fee Item</h3>
                    
                    <form id="fee-item-form">
                        <input type="hidden" id="fee-item-id">
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="fee-item-name">Fee Item Name *</label>
                                <input type="text" id="fee-item-name" placeholder="e.g., Admission Fee, Tuition Fee" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="fee-item-amount">Amount (KES) *</label>
                                <input type="number" id="fee-item-amount" placeholder="0" min="0" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="fee-item-category">Category</label>
                                <select id="fee-item-category">
                                    <option value="tuition">Tuition</option>
                                    <option value="admission">Admission</option>
                                    <option value="activity">Activity</option>
                                    <option value="uniform">Uniform & Equipment</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="fee-item-description">Description</label>
                                <input type="text" id="fee-item-description" placeholder="Brief description of the fee">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="fee-item-due-days">Due Days (After Registration)</label>
                                <input type="number" id="fee-item-due-days" placeholder="30" min="0">
                                <small style="color: #666;">Number of days after registration when fee is due</small>
                            </div>
                            
                            <div class="form-group">
                                <label for="fee-item-term">Term Applicable</label>
                                <select id="fee-item-term">
                                    <option value="all">All Terms</option>
                                    <option value="term1">Term 1 Only</option>
                                    <option value="term2">Term 2 Only</option>
                                    <option value="term3">Term 3 Only</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="fee-item-required">
                                    <input type="checkbox" id="fee-item-required">
                                    Mark as Required Fee
                                </label>
                                <small style="color: #666;">Required fees are automatically selected for all students</small>
                            </div>
                            
                            <div class="form-group">
                                <label for="fee-item-active">
                                    <input type="checkbox" id="fee-item-active" checked>
                                    Active (Available for selection)
                                </label>
                            </div>
                        </div>
                        
                        <div class="text-center mt-20">
                            <button type="submit" id="save-fee-item" class="btn-success">
                                <i class="fas fa-save"></i> Save Fee Item
                                <span class="btn-notification"><i class="fas fa-check"></i></span>
                            </button>
                            <button type="button" id="clear-fee-form" class="btn-secondary">
                                <i class="fas fa-times"></i> Clear Form
                                <span class="btn-notification"><i class="fas fa-times"></i></span>
                            </button>
                        </div>
                    </form>
                </div>
                
                <div class="mt-20">
                    <h3>Current Fee Items</h3>
                    <div class="fee-items-list" id="fee-items-list">
                        <!-- Fee items will be loaded dynamically -->
                    </div>
                </div>
            </div>
            
            <!-- App Setting Content -->
            <div id="app-setting" class="content-area">
                <div class="content-header">
                    <h2>Application Settings</h2>
                    <button id="save-app-settings" class="btn-success">
                        <i class="fas fa-save"></i> Save All Settings
                        <span class="btn-notification"><i class="fas fa-check"></i></span>
                    </button>
                </div>
                
                <div class="form-container">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="school-name">School Name</label>
                            <input type="text" id="school-name" value="Edu-Track Junior Academy">
                        </div>
                        <div class="form-group">
                            <label for="school-address">School Address</label>
                            <input type="text" id="school-address" value="P.O. Box 12345, Nairobi, Kenya">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="school-phone">School Phone</label>
                            <input type="text" id="school-phone" value="+254 712 345 678">
                        </div>
                        <div class="form-group">
                            <label for="school-email">School Email</label>
                            <input type="email" id="school-email" value="info@edutrack.ac.ke">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="school-logo">School Logo URL</label>
                            <input type="text" id="school-logo" placeholder="Enter logo URL or upload">
                            <input type="file" id="logo-upload" accept="image/*" class="mt-10" style="display: none;">
                            <button type="button" id="upload-logo-btn" class="btn-secondary btn-small mt-10">
                                <i class="fas fa-upload"></i> Upload Logo
                                <span class="btn-notification"><i class="fas fa-check"></i></span>
                            </button>
                        </div>
                        <div class="form-group">
                            <label>Logo Preview</label>
                            <div id="logo-preview" class="school-logo-display">
                                <i class="fas fa-school" style="font-size: 3rem; color: #ccc;"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Data Management Content -->
            <div id="data-management" class="content-area">
                <div class="content-header">
                    <h2>Data Management</h2>
                    <div>
                        <button id="sync-to-cloud" class="btn-success">
                            <i class="fas fa-cloud-upload-alt"></i> Sync to Cloud
                            <span class="btn-notification"><i class="fas fa-check"></i></span>
                        </button>
                        <button id="backup-data" class="btn-info">
                            <i class="fas fa-download"></i> Backup Data
                            <span class="btn-notification"><i class="fas fa-check"></i></span>
                        </button>
                    </div>
                </div>
                
                <div class="sync-status">
                    <div class="sync-indicator" id="cloud-sync-indicator"></div>
                    <span id="cloud-sync-message">Cloud sync: Not configured</span>
                </div>
                
                <div class="form-container">
                    <h3>Google Sheets Integration</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="google-sheet-id">Google Sheet ID</label>
                            <input type="text" id="google-sheet-id" placeholder="Enter Google Sheet ID">
                            <small style="color: #666;">Get this from your Google Sheet URL</small>
                        </div>
                        <div class="form-group">
                            <label for="web-app-url">Web App URL</label>
                            <input type="text" id="web-app-url" placeholder="Enter Google Apps Script Web App URL">
                            <small style="color: #666;">Paste your deployed web app URL here</small>
                        </div>
                    </div>
                    
                    <div class="data-management-actions">
                        <button id="test-connection" class="btn-warning">
                            <i class="fas fa-plug"></i> Test Connection
                            <span class="btn-notification"><i class="fas fa-check"></i></span>
                        </button>
                        <button id="save-cloud-settings" class="btn-success">
                            <i class="fas fa-save"></i> Save Settings
                            <span class="btn-notification"><i class="fas fa-check"></i></span>
                        </button>
                        <button id="sync-now" class="btn-info">
                            <i class="fas fa-sync"></i> Sync Now
                            <span class="btn-notification"><i class="fas fa-check"></i></span>
                        </button>
                    </div>
                    
                    <div class="mt-20">
                        <h3>Data Operations</h3>
                        <div class="data-management-actions">
                            <button id="export-data" class="btn-secondary">
                                <i class="fas fa-file-export"></i> Export to CSV
                                <span class="btn-notification"><i class="fas fa-check"></i></span>
                            </button>
                            <button id="import-data" class="btn-secondary">
                                <i class="fas fa-file-import"></i> Import from CSV
                                <span class="btn-notification"><i class="fas fa-check"></i></span>
                            </button>
                            <button id="clear-data" class="btn-danger">
                                <i class="fas fa-trash"></i> Clear All Data
                                <span class="btn-notification"><i class="fas fa-times"></i></span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="mt-20">
                        <h3>System Information</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Local Storage Used</label>
                                <div id="storage-usage">0 KB</div>
                            </div>
                            <div class="form-group">
                                <label>Last Backup</label>
                                <div id="last-backup">Never</div>
                            </div>
                            <div class="form-group">
                                <label>Last Sync</label>
                                <div id="last-sync">Never</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Print Footer for All Pages -->
        <div class="print-footer" id="print-footer">
            <p>Generated by Edu-Track CBE Pro Fees Management System</p>
            <p>Date: <span id="print-date"></span> | Page <span class="page-number"></span></p>
        </div>
    </div>
    
    <!-- Student Modal -->
    <div id="student-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="student-modal-title">Add New Student</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="student-form">
                    <input type="hidden" id="student-id">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="first-name">First Name *</label>
                            <input type="text" id="first-name" required>
                        </div>
                        <div class="form-group">
                            <label for="last-name">Last Name *</label>
                            <input type="text" id="last-name" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="student-class">Class *</label>
                            <select id="student-class" required>
                                <option value="">Select Class</option>
                                <option value="grade7">Grade 7</option>
                                <option value="grade8">Grade 8</option>
                                <option value="grade9">Grade 9</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="student-dob">Date of Birth</label>
                            <input type="date" id="student-dob">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="parent-name">Parent/Guardian Name *</label>
                            <input type="text" id="parent-name" required>
                        </div>
                        <div class="form-group">
                            <label for="parent-phone">Parent Phone *</label>
                            <input type="tel" id="parent-phone" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="parent-email">Parent Email</label>
                            <input type="email" id="parent-email">
                        </div>
                        <div class="form-group">
                            <label for="parent-address">Address</label>
                            <input type="text" id="parent-address">
                        </div>
                    </div>
                    
                    <!-- Fee Selection Section -->
                    <div class="fee-selection-container">
                        <div class="fee-selection-title">
                            <span>Select Fee Items to Pay</span>
                            <small>Required fees are pre-selected</small>
                        </div>
                        <div class="fee-selection-grid" id="fee-selection-grid">
                            <!-- Fee items will be loaded dynamically -->
                        </div>
                    </div>
                    
                    <div class="text-center mt-20">
                        <button type="submit" class="btn-success" id="save-student-btn">
                            <i class="fas fa-save"></i> Save Student
                            <span class="btn-notification"><i class="fas fa-check"></i></span>
                        </button>
                        <button type="button" class="btn-secondary close-modal">
                            Cancel
                            <span class="btn-notification"><i class="fas fa-times"></i></span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Fee Payment Modal -->
    <div id="fee-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="fee-modal-title">Record Fee Payment</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="fee-form">
                    <input type="hidden" id="payment-id">
                    <input type="hidden" id="payment-student-id">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="payment-student">Student *</label>
                            <select id="payment-student" required>
                                <option value="">Select Student</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="payment-date">Payment Date *</label>
                            <input type="date" id="payment-date" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="payment-amount">Amount (KES) *</label>
                            <input type="number" id="payment-amount" placeholder="0" min="1" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="payment-method">Payment Method *</label>
                            <select id="payment-method" required>
                                <option value="">Select Method</option>
                                <option value="cash">Cash</option>
                                <option value="mpesa">M-Pesa</option>
                                <option value="bank">Bank Transfer</option>
                                <option value="cheque">Cheque</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="payment-fee-type">Fee Type *</label>
                            <select id="payment-fee-type" required>
                                <option value="">Select Fee Type</option>
                                <!-- Options will be loaded dynamically -->
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="payment-reference">Reference Number</label>
                            <input type="text" id="payment-reference" placeholder="Transaction/Cheque number">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="payment-notes">Notes</label>
                        <textarea id="payment-notes" rows="3"></textarea>
                    </div>
                    
                    <div class="text-center mt-20">
                        <button type="submit" class="btn-success" id="save-payment-btn">
                            <i class="fas fa-save"></i> Save Payment
                            <span class="btn-notification"><i class="fas fa-check"></i></span>
                        </button>
                        <button type="button" class="btn-secondary close-modal">
                            Cancel
                            <span class="btn-notification"><i class="fas fa-times"></i></span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Receipt Modal -->
    <div id="receipt-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Payment Receipt</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="receipt-content">
                    <!-- Receipt content will be loaded dynamically -->
                </div>
            </div>
            <div class="modal-footer" style="padding: 15px 20px; border-top: 1px solid #eee; text-align: right;">
                <button id="print-receipt-btn" class="btn-secondary">
                    <i class="fas fa-print"></i> Print Receipt
                    <span class="btn-notification"><i class="fas fa-check"></i></span>
                </button>
                <button class="btn-secondary close-modal">
                    Close
                    <span class="btn-notification"><i class="fas fa-times"></i></span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 id="confirm-title">Confirm Action</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <p id="confirm-message">Are you sure you want to perform this action?</p>
            </div>
            <div class="modal-footer" style="padding: 15px 20px; border-top: 1px solid #eee; text-align: right;">
                <button id="confirm-cancel" class="btn-secondary">
                    Cancel
                    <span class="btn-notification"><i class="fas fa-times"></i></span>
                </button>
                <button id="confirm-ok" class="btn-danger">
                    Confirm
                    <span class="btn-notification"><i class="fas fa-check"></i></span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <script>
        // ============================================
        // EDU-TRACK CBE PRO - COMPLETE FEES MANAGEMENT SYSTEM
        // ============================================
        
        // Application Configuration
        const APP_CONFIG = {
            APP_NAME: 'Edu-Track CBE Pro',
            VERSION: '1.0.0',
            DEFAULT_CURRENCY: 'KES',
            STORAGE_PREFIX: 'edutrack_',
            NEXT_STUDENT_ID: 1001,
            NEXT_RECEIPT_NO: 1001
        };
        
        // Admin credentials
        const ADMIN_CREDENTIALS = {
            username: 'admin',
            password: 'admin002'
        };
        
        // Initial Data Structure
        let appData = {
            students: [],
            feePayments: [],
            feeItems: [],
            settings: {
                schoolName: 'Edu-Track Junior Academy',
                schoolAddress: 'P.O. Box 12345, Nairobi, Kenya',
                schoolPhone: '+254 712 345 678',
                schoolEmail: 'info@edutrack.ac.ke',
                schoolLogo: '',
                cloudSettings: {
                    googleSheetId: '',
                    webAppUrl: ''
                }
            },
            lastBackup: null,
            lastSync: null
        };
        
        // Default Fee Items with due days
        const DEFAULT_FEE_ITEMS = [
            { id: 'admission', name: 'Admission Fees', amount: 5000, category: 'admission', isRequired: true, active: true, dueDays: 7, term: 'all' },
            { id: 'caution', name: 'Caution Fees (Refundable)', amount: 3000, category: 'admission', isRequired: true, active: true, dueDays: 7, term: 'all' },
            { id: 'term1', name: 'Term 1 Tuition Fees', amount: 20000, category: 'tuition', isRequired: true, active: true, dueDays: 30, term: 'term1' },
            { id: 'term2', name: 'Term 2 Tuition Fees', amount: 20000, category: 'tuition', isRequired: true, active: true, dueDays: 30, term: 'term2' },
            { id: 'term3', name: 'Term 3 Tuition Fees', amount: 20000, category: 'tuition', isRequired: true, active: true, dueDays: 30, term: 'term3' },
            { id: 'pta', name: 'PTA Fees', amount: 1000, category: 'other', isRequired: true, active: true, dueDays: 14, term: 'all' },
            { id: 'assessment', name: 'Assessment Fees', amount: 2500, category: 'other', isRequired: false, active: true, dueDays: 21, term: 'all' },
            { id: 'project', name: 'Project Fees', amount: 1500, category: 'other', isRequired: false, active: true, dueDays: 21, term: 'all' },
            { id: 'badge', name: 'Badge & Tie', amount: 800, category: 'uniform', isRequired: true, active: true, dueDays: 14, term: 'all' },
            { id: 'school-id', name: 'School ID', amount: 500, category: 'uniform', isRequired: true, active: true, dueDays: 14, term: 'all' },
            { id: 'uniform', name: 'Uniform', amount: 7500, category: 'uniform', isRequired: true, active: true, dueDays: 14, term: 'all' },
            { id: 'academic-welfare', name: 'Academic Welfare', amount: 3000, category: 'other', isRequired: false, active: true, dueDays: 30, term: 'all' },
            { id: 'activity', name: 'Activity Fees', amount: 2500, category: 'activity', isRequired: true, active: true, dueDays: 21, term: 'all' }
        ];
        
        // DOM Elements
        const loginScreen = document.getElementById('login-screen');
        const appContainer = document.getElementById('app-container');
        const loginForm = document.getElementById('login-form');
        const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
        const sidebar = document.getElementById('sidebar');
        const menuItems = document.querySelectorAll('.menu-item');
        const contentAreas = document.querySelectorAll('.content-area');
        
        // Initialize Toastr with custom settings
        toastr.options = {
            "closeButton": true,
            "progressBar": true,
            "positionClass": "toast-top-right",
            "timeOut": "3000",
            "showMethod": "slideDown",
            "hideMethod": "slideUp"
        };
        
        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        
        // Format currency
        function formatCurrency(amount) {
            if (amount === undefined || amount === null) return 'KES 0';
            return new Intl.NumberFormat('en-KE', {
                style: 'currency',
                currency: 'KES',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount).replace('KES', 'KES ');
        }
        
        // Generate student ID
        function generateStudentId() {
            let nextId = APP_CONFIG.NEXT_STUDENT_ID + appData.students.length;
            return `ETJA${nextId.toString().padStart(4, '0')}`;
        }
        
        // Generate receipt number
        function generateReceiptNo() {
            let nextNo = APP_CONFIG.NEXT_RECEIPT_NO + appData.feePayments.length;
            return `RCPT-${nextNo.toString().padStart(6, '0')}`;
        }
        
        // Format date
        function formatDate(date) {
            if (!date) return '';
            try {
                const d = new Date(date);
                return d.toLocaleDateString('en-GB', {
                    day: '2-digit',
                    month: 'short',
                    year: 'numeric'
                });
            } catch (e) {
                return '';
            }
        }
        
        // Get current date
        function getCurrentDate() {
            return new Date().toISOString().split('T')[0];
        }
        
        // Add days to date
        function addDaysToDate(date, days) {
            const result = new Date(date);
            result.setDate(result.getDate() + days);
            return result.toISOString().split('T')[0];
        }
        
        // Generate unique ID
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        }
        
        // Calculate total fees for a student
        function calculateTotalFees(student) {
            if (!student || !student.feeItems) return 0;
            
            let total = 0;
            student.feeItems.forEach(feeItemId => {
                const feeItem = appData.feeItems.find(f => f.id === feeItemId);
                if (feeItem && feeItem.active) {
                    total += feeItem.amount;
                }
            });
            
            return total;
        }
        
        // Calculate total paid for a student
        function calculateTotalPaid(studentId) {
            const feePayments = appData.feePayments.filter(p => p.studentId === studentId);
            return feePayments.reduce((sum, payment) => sum + payment.amount, 0);
        }
        
        // Calculate paid amount for specific fee item
        function calculatePaidForFeeItem(studentId, feeItemId) {
            const feePayments = appData.feePayments.filter(p => 
                p.studentId === studentId && p.feeItemId === feeItemId
            );
            return feePayments.reduce((sum, payment) => sum + payment.amount, 0);
        }
        
        // Calculate due date for fee item
        function calculateDueDate(student, feeItemId) {
            if (!student || !student.dateAdded) return null;
            
            const feeItem = appData.feeItems.find(f => f.id === feeItemId);
            if (!feeItem || !feeItem.dueDays) return null;
            
            return addDaysToDate(student.dateAdded, feeItem.dueDays);
        }
        
        // Check if fee is overdue
        function isFeeOverdue(dueDate) {
            if (!dueDate) return false;
            const today = new Date();
            const due = new Date(dueDate);
            return due < today;
        }
        
        // Check if fee is due soon (within 7 days)
        function isFeeDueSoon(dueDate) {
            if (!dueDate) return false;
            const today = new Date();
            const due = new Date(dueDate);
            const diffTime = due - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays <= 7 && diffDays > 0;
        }
        
        // Get active fee items
        function getActiveFeeItems() {
            return appData.feeItems.filter(item => item.active !== false);
        }
        
        // Get required fee items
        function getRequiredFeeItems() {
            return appData.feeItems.filter(item => item.isRequired && item.active !== false);
        }
        
        // Show success message
        function showSuccess(message) {
            toastr.success(message);
        }
        
        // Show error message
        function showError(message) {
            toastr.error(message);
        }
        
        // Show info message
        function showInfo(message) {
            toastr.info(message);
        }
        
        // Show warning message
        function showWarning(message) {
            toastr.warning(message);
        }
        
        // Show button notification
        function showButtonNotification(button, success = true) {
            const notification = button.querySelector('.btn-notification');
            if (notification) {
                const icon = notification.querySelector('i');
                if (success) {
                    icon.className = 'fas fa-check';
                    button.classList.add('btn-success', 'btn-show-notification');
                    button.classList.remove('btn-danger');
                } else {
                    icon.className = 'fas fa-times';
                    button.classList.add('btn-danger', 'btn-show-notification');
                    button.classList.remove('btn-success');
                }
                
                // Remove notification after animation
                setTimeout(() => {
                    button.classList.remove('btn-show-notification');
                    if (success) {
                        button.classList.remove('btn-success');
                    } else {
                        button.classList.remove('btn-danger');
                    }
                }, 1000);
            }
        }
        
        // ============================================
        // STORAGE FUNCTIONS
        // ============================================
        
        // Save data to localStorage
        function saveToLocalStorage() {
            try {
                appData.lastBackup = new Date().toISOString();
                localStorage.setItem(APP_CONFIG.STORAGE_PREFIX + 'appData', JSON.stringify(appData));
                updateStorageInfo();
                return true;
            } catch (error) {
                console.error('Error saving to localStorage:', error);
                showError('Failed to save data. Check storage space.');
                return false;
            }
        }
        
        // Load data from localStorage
        function loadFromLocalStorage() {
            try {
                const savedData = localStorage.getItem(APP_CONFIG.STORAGE_PREFIX + 'appData');
                if (savedData) {
                    appData = JSON.parse(savedData);
                }
                
                // Initialize default fee items if none exist
                if (!appData.feeItems || appData.feeItems.length === 0) {
                    appData.feeItems = DEFAULT_FEE_ITEMS;
                }
                
                // Initialize default settings if none exist
                if (!appData.settings) {
                    appData.settings = {
                        schoolName: 'Edu-Track Junior Academy',
                        schoolAddress: 'P.O. Box 12345, Nairobi, Kenya',
                        schoolPhone: '+254 712 345 678',
                        schoolEmail: 'info@edutrack.ac.ke',
                        schoolLogo: '',
                        cloudSettings: {
                            googleSheetId: '',
                            webAppUrl: ''
                        }
                    };
                }
                
                updateStorageInfo();
                updateSyncStatus();
                return true;
            } catch (error) {
                console.error('Error loading from localStorage:', error);
                showWarning('Loading default data due to storage error');
                // Initialize with default data
                appData = {
                    students: [],
                    feePayments: [],
                    feeItems: DEFAULT_FEE_ITEMS,
                    settings: {
                        schoolName: 'Edu-Track Junior Academy',
                        schoolAddress: 'P.O. Box 12345, Nairobi, Kenya',
                        schoolPhone: '+254 712 345 678',
                        schoolEmail: 'info@edutrack.ac.ke',
                        schoolLogo: '',
                        cloudSettings: {
                            googleSheetId: '',
                            webAppUrl: ''
                        }
                    },
                    lastBackup: null,
                    lastSync: null
                };
                saveToLocalStorage();
                return false;
            }
        }
        
        // Update storage usage info
        function updateStorageInfo() {
            try {
                const data = JSON.stringify(appData);
                const sizeInKB = (data.length / 1024).toFixed(2);
                document.getElementById('storage-usage').textContent = `${sizeInKB} KB`;
                
                document.getElementById('last-backup').textContent = 
                    appData.lastBackup ? formatDate(appData.lastBackup) : 'Never';
                document.getElementById('last-sync').textContent = 
                    appData.lastSync ? formatDate(appData.lastSync) : 'Never';
            } catch (error) {
                console.error('Error updating storage info:', error);
            }
        }
        
        // Update sync status
        function updateSyncStatus() {
            const indicator = document.getElementById('sync-indicator');
            const message = document.getElementById('sync-message');
            const cloudIndicator = document.getElementById('cloud-sync-indicator');
            const cloudMessage = document.getElementById('cloud-sync-message');
            
            // Local sync status
            indicator.className = 'sync-indicator synced';
            message.textContent = 'All data synced locally';
            
            // Cloud sync status
            if (appData.settings.cloudSettings.webAppUrl && appData.settings.cloudSettings.googleSheetId) {
                cloudIndicator.className = 'sync-indicator synced';
                cloudMessage.textContent = 'Cloud sync: Configured';
            } else {
                cloudIndicator.className = 'sync-indicator pending';
                cloudMessage.textContent = 'Cloud sync: Not configured';
            }
        }
        
        // Update alarm count
        function updateAlarmCount() {
            let overdueCount = 0;
            const today = new Date();
            
            appData.students.forEach(student => {
                student.feeItems.forEach(feeItemId => {
                    const dueDate = calculateDueDate(student, feeItemId);
                    if (dueDate && isFeeOverdue(dueDate)) {
                        const paidAmount = calculatePaidForFeeItem(student.id, feeItemId);
                        const feeItem = appData.feeItems.find(f => f.id === feeItemId);
                        if (feeItem && paidAmount < feeItem.amount) {
                            overdueCount++;
                        }
                    }
                });
            });
            
            const alarmCountElement = document.getElementById('alarm-count');
            alarmCountElement.textContent = overdueCount;
            if (overdueCount > 0) {
                alarmCountElement.style.display = 'flex';
            } else {
                alarmCountElement.style.display = 'none';
            }
        }
        
        // ============================================
        // DASHBOARD FUNCTIONS
        // ============================================
        
        // Update dashboard stats
        function updateDashboardStats() {
            const totalStudents = appData.students.length;
            const totalCollected = appData.feePayments.reduce((sum, payment) => sum + payment.amount, 0);
            
            // Calculate students with arrears and total arrears
            let studentsWithArrears = 0;
            let totalArrears = 0;
            
            appData.students.forEach(student => {
                const totalFees = calculateTotalFees(student);
                const totalPaid = calculateTotalPaid(student.id);
                const balance = totalFees - totalPaid;
                
                if (balance > 0) {
                    studentsWithArrears++;
                    totalArrears += balance;
                }
            });
            
            // Update UI
            document.getElementById('total-students-count').textContent = totalStudents;
            document.getElementById('total-fees-collected').textContent = formatCurrency(totalCollected);
            document.getElementById('students-with-arrears').textContent = studentsWithArrears;
            document.getElementById('total-arrears').textContent = formatCurrency(totalArrears);
            
            // Update recent transactions table
            updateRecentTransactions();
            
            // Update alarm count
            updateAlarmCount();
        }
        
        // Update recent transactions table
        function updateRecentTransactions() {
            const tbody = document.getElementById('dashboard-table-body');
            const recentPayments = [...appData.feePayments]
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 10);
            
            let totalCollected = 0;
            tbody.innerHTML = '';
            
            recentPayments.forEach(payment => {
                const student = appData.students.find(s => s.id === payment.studentId);
                const feeItem = appData.feeItems.find(f => f.id === payment.feeItemId);
                
                if (student && feeItem) {
                    totalCollected += payment.amount;
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${payment.receiptNo}</td>
                        <td>${student.firstName} ${student.lastName}</td>
                        <td>${student.class.toUpperCase()}</td>
                        <td>${feeItem.name}</td>
                        <td class="currency">${formatCurrency(payment.amount)}</td>
                        <td>${formatDate(payment.date)}</td>
                        <td><span class="badge badge-success">Paid</span></td>
                    `;
                    tbody.appendChild(row);
                }
            });
            
            document.getElementById('dashboard-total').textContent = formatCurrency(totalCollected);
        }
        
        // ============================================
        // STUDENT REGISTER FUNCTIONS
        // ============================================
        
        // Load students table
        function loadStudentsTable(filterClass = 'all', searchTerm = '') {
            const tbody = document.getElementById('student-table-body');
            let students = [...appData.students];
            
            // Apply filters
            if (filterClass !== 'all') {
                students = students.filter(student => student.class === filterClass);
            }
            
            if (searchTerm) {
                const term = searchTerm.toLowerCase();
                students = students.filter(student => 
                    student.firstName.toLowerCase().includes(term) ||
                    student.lastName.toLowerCase().includes(term) ||
                    student.id.toLowerCase().includes(term) ||
                    student.parentName.toLowerCase().includes(term)
                );
            }
            
            // Update total count
            document.getElementById('total-students').textContent = students.length;
            
            // Clear table
            tbody.innerHTML = '';
            
            // Populate table
            students.forEach(student => {
                const totalFees = calculateTotalFees(student);
                const totalPaid = calculateTotalPaid(student.id);
                const balance = totalFees - totalPaid;
                
                // Calculate earliest due date
                let earliestDueDate = null;
                student.feeItems.forEach(feeItemId => {
                    const dueDate = calculateDueDate(student, feeItemId);
                    if (dueDate && (!earliestDueDate || new Date(dueDate) < new Date(earliestDueDate))) {
                        earliestDueDate = dueDate;
                    }
                });
                
                let status = 'success';
                let statusText = 'Paid';
                
                if (balance > 0) {
                    status = totalPaid > 0 ? 'warning' : 'danger';
                    statusText = totalPaid > 0 ? 'Partial' : 'Unpaid';
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${student.id}</td>
                    <td>${student.firstName} ${student.lastName}</td>
                    <td>${student.class.toUpperCase()}</td>
                    <td>${student.parentName}</td>
                    <td>${student.parentPhone}</td>
                    <td class="currency">${formatCurrency(totalFees)}</td>
                    <td class="currency">${formatCurrency(totalPaid)}</td>
                    <td class="currency">${formatCurrency(balance)}</td>
                    <td>${earliestDueDate ? formatDate(earliestDueDate) : 'N/A'}</td>
                    <td><span class="badge badge-${status}">${statusText}</span></td>
                    <td class="actions">
                        <button class="btn-icon btn-info btn-small view-student" data-id="${student.id}">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn-icon btn-secondary btn-small edit-student" data-id="${student.id}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-icon btn-success btn-small add-payment" data-id="${student.id}">
                            <i class="fas fa-money-bill-wave"></i>
                        </button>
                        <button class="btn-icon btn-danger btn-small delete-student" data-id="${student.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // Add event listeners to action buttons
            addStudentActionListeners();
        }
        
        // Load fee selection for student registration
        function loadFeeSelection() {
            const container = document.getElementById('fee-selection-grid');
            const activeFeeItems = getActiveFeeItems();
            const requiredFeeItems = getRequiredFeeItems();
            
            container.innerHTML = '';
            
            activeFeeItems.forEach(feeItem => {
                const isRequired = requiredFeeItems.some(f => f.id === feeItem.id);
                const optionDiv = document.createElement('div');
                optionDiv.className = `fee-option ${isRequired ? 'required' : ''}`;
                
                optionDiv.innerHTML = `
                    <input type="checkbox" id="fee-${feeItem.id}" value="${feeItem.id}" 
                        ${isRequired ? 'checked disabled' : ''}>
                    <label for="fee-${feeItem.id}">
                        <span>${feeItem.name} ${isRequired ? '<small style="color: var(--danger-color);">(Required)</small>' : ''}</span>
                        <span class="currency">${formatCurrency(feeItem.amount)}</span>
                    </label>
                `;
                
                container.appendChild(optionDiv);
            });
        }
        
        // Add student
        function addStudent(studentData) {
            try {
                const studentId = generateStudentId();
                
                // Get selected fee items
                const feeCheckboxes = document.querySelectorAll('#fee-selection-grid input[type="checkbox"]:checked, #fee-selection-grid input[type="checkbox"]:disabled:checked');
                const selectedFeeItems = Array.from(feeCheckboxes).map(cb => cb.value);
                
                if (selectedFeeItems.length === 0) {
                    showError('Please select at least one fee item for the student');
                    return null;
                }
                
                const newStudent = {
                    id: studentId,
                    ...studentData,
                    feeItems: selectedFeeItems,
                    dateAdded: new Date().toISOString()
                };
                
                appData.students.push(newStudent);
                saveToLocalStorage();
                
                // Update UI
                loadStudentsTable();
                loadFeeRegisterTable();
                updateDashboardStats();
                populateStudentDropdowns();
                populateReminderDropdowns();
                
                showSuccess(`Student ${studentData.firstName} ${studentData.lastName} added successfully`);
                return studentId;
            } catch (error) {
                console.error('Error adding student:', error);
                showError('Failed to add student');
                return null;
            }
        }
        
        // Edit student
        function editStudent(studentId, studentData) {
            try {
                const index = appData.students.findIndex(s => s.id === studentId);
                if (index !== -1) {
                    // Get selected fee items
                    const feeCheckboxes = document.querySelectorAll('#fee-selection-grid input[type="checkbox"]:checked, #fee-selection-grid input[type="checkbox"]:disabled:checked');
                    const selectedFeeItems = Array.from(feeCheckboxes).map(cb => cb.value);
                    
                    if (selectedFeeItems.length === 0) {
                        showError('Please select at least one fee item for the student');
                        return false;
                    }
                    
                    appData.students[index] = {
                        ...appData.students[index],
                        ...studentData,
                        feeItems: selectedFeeItems
                    };
                    
                    saveToLocalStorage();
                    
                    // Update UI
                    loadStudentsTable();
                    loadFeeRegisterTable();
                    updateDashboardStats();
                    populateStudentDropdowns();
                    populateReminderDropdowns();
                    
                    showSuccess('Student updated successfully');
                    return true;
                }
                showError('Student not found');
                return false;
            } catch (error) {
                console.error('Error editing student:', error);
                showError('Failed to update student');
                return false;
            }
        }
        
        // Delete student
        function deleteStudent(studentId) {
            try {
                const index = appData.students.findIndex(s => s.id === studentId);
                if (index !== -1) {
                    const student = appData.students[index];
                    
                    // Check if student has payments
                    const hasPayments = appData.feePayments.some(p => p.studentId === studentId);
                    if (hasPayments) {
                        showError('Cannot delete student with payment history');
                        return false;
                    }
                    
                    appData.students.splice(index, 1);
                    saveToLocalStorage();
                    
                    // Update UI
                    loadStudentsTable();
                    loadFeeRegisterTable();
                    updateDashboardStats();
                    populateStudentDropdowns();
                    populateReminderDropdowns();
                    
                    showSuccess('Student deleted successfully');
                    return true;
                }
                showError('Student not found');
                return false;
            } catch (error) {
                console.error('Error deleting student:', error);
                showError('Failed to delete student');
                return false;
            }
        }
        
        // ============================================
        // FEE REGISTER FUNCTIONS
        // ============================================
        
        // Load fee register table
        function loadFeeRegisterTable(filterClass = 'all', filterStudent = 'all') {
            const tbody = document.getElementById('fee-table-body');
            const tfoot = document.getElementById('fee-table-footer');
            
            // Clear table
            tbody.innerHTML = '';
            
            // Initialize totals
            const totals = {
                totalFees: 0,
                totalPaid: 0,
                totalBalance: 0,
                admission: 0,
                caution: 0,
                term1: 0,
                term2: 0,
                term3: 0,
                pta: 0,
                assessment: 0,
                project: 0,
                badge: 0,
                schoolId: 0,
                uniform: 0,
                academicWelfare: 0,
                activity: 0
            };
            
            // Process each student
            appData.students.forEach(student => {
                // Apply filters
                if (filterClass !== 'all' && student.class !== filterClass) return;
                if (filterStudent !== 'all' && student.id !== filterStudent) return;
                
                const totalFees = calculateTotalFees(student);
                const totalPaid = calculateTotalPaid(student.id);
                const balance = totalFees - totalPaid;
                
                // Calculate paid amounts for each fee item
                const feeItemsPaid = {};
                appData.feeItems.forEach(feeItem => {
                    feeItemsPaid[feeItem.id] = calculatePaidForFeeItem(student.id, feeItem.id);
                });
                
                // Update totals
                totals.totalFees += totalFees;
                totals.totalPaid += totalPaid;
                totals.totalBalance += balance;
                
                // Update individual fee totals
                Object.keys(feeItemsPaid).forEach(feeItemId => {
                    const paidAmount = feeItemsPaid[feeItemId];
                    switch(feeItemId) {
                        case 'admission': totals.admission += paidAmount; break;
                        case 'caution': totals.caution += paidAmount; break;
                        case 'term1': totals.term1 += paidAmount; break;
                        case 'term2': totals.term2 += paidAmount; break;
                        case 'term3': totals.term3 += paidAmount; break;
                        case 'pta': totals.pta += paidAmount; break;
                        case 'assessment': totals.assessment += paidAmount; break;
                        case 'project': totals.project += paidAmount; break;
                        case 'badge': totals.badge += paidAmount; break;
                        case 'school-id': totals.schoolId += paidAmount; break;
                        case 'uniform': totals.uniform += paidAmount; break;
                        case 'academic-welfare': totals.academicWelfare += paidAmount; break;
                        case 'activity': totals.activity += paidAmount; break;
                    }
                });
                
                // Create table row
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${student.firstName} ${student.lastName}</td>
                    <td>${student.class.toUpperCase()}</td>
                    <td class="currency">${formatCurrency(totalFees)}</td>
                    <td class="currency">${formatCurrency(totalPaid)}</td>
                    <td class="currency">${formatCurrency(balance)}</td>
                    <td class="currency">${formatCurrency(feeItemsPaid.admission)}</td>
                    <td class="currency">${formatCurrency(feeItemsPaid.caution)}</td>
                    <td class="currency">${formatCurrency(feeItemsPaid.term1)}</td>
                    <td class="currency">${formatCurrency(feeItemsPaid.term2)}</td>
                    <td class="currency">${formatCurrency(feeItemsPaid.term3)}</td>
                    <td class="currency">${formatCurrency(feeItemsPaid.pta)}</td>
                    <td class="currency">${formatCurrency(feeItemsPaid.assessment)}</td>
                    <td class="currency">${formatCurrency(feeItemsPaid.project)}</td>
                    <td class="currency">${formatCurrency(feeItemsPaid.badge)}</td>
                    <td class="currency">${formatCurrency(feeItemsPaid['school-id'])}</td>
                    <td class="currency">${formatCurrency(feeItemsPaid.uniform)}</td>
                    <td class="currency">${formatCurrency(feeItemsPaid['academic-welfare'])}</td>
                    <td class="currency">${formatCurrency(feeItemsPaid.activity)}</td>
                    <td class="actions">
                        <button class="btn-icon btn-info btn-small view-receipts" data-id="${student.id}">
                            <i class="fas fa-receipt"></i>
                        </button>
                        <button class="btn-icon btn-success btn-small add-student-payment" data-id="${student.id}">
                            <i class="fas fa-plus"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // Update footer with totals
            tfoot.innerHTML = `
                <tr style="background-color: #f8f9fa; font-weight: bold;">
                    <td colspan="2">TOTALS</td>
                    <td class="currency">${formatCurrency(totals.totalFees)}</td>
                    <td class="currency">${formatCurrency(totals.totalPaid)}</td>
                    <td class="currency">${formatCurrency(totals.totalBalance)}</td>
                    <td class="currency">${formatCurrency(totals.admission)}</td>
                    <td class="currency">${formatCurrency(totals.caution)}</td>
                    <td class="currency">${formatCurrency(totals.term1)}</td>
                    <td class="currency">${formatCurrency(totals.term2)}</td>
                    <td class="currency">${formatCurrency(totals.term3)}</td>
                    <td class="currency">${formatCurrency(totals.pta)}</td>
                    <td class="currency">${formatCurrency(totals.assessment)}</td>
                    <td class="currency">${formatCurrency(totals.project)}</td>
                    <td class="currency">${formatCurrency(totals.badge)}</td>
                    <td class="currency">${formatCurrency(totals.schoolId)}</td>
                    <td class="currency">${formatCurrency(totals.uniform)}</td>
                    <td class="currency">${formatCurrency(totals.academicWelfare)}</td>
                    <td class="currency">${formatCurrency(totals.activity)}</td>
                    <td></td>
                </tr>
            `;
            
            // Update grand total
            document.getElementById('fee-grand-total').textContent = formatCurrency(totals.totalPaid);
            
            // Add event listeners
            addFeeRegisterActionListeners();
        }
        
        // Add fee payment
        function addFeePayment(paymentData) {
            try {
                const receiptNo = generateReceiptNo();
                
                const newPayment = {
                    id: generateId(),
                    receiptNo: receiptNo,
                    ...paymentData,
                    amount: parseFloat(paymentData.amount),
                    date: paymentData.date || getCurrentDate(),
                    recordedBy: 'Admin',
                    timestamp: new Date().toISOString()
                };
                
                appData.feePayments.push(newPayment);
                saveToLocalStorage();
                
                // Update UI
                updateDashboardStats();
                loadFeeRegisterTable();
                loadStudentsTable();
                loadFeeReminders();
                
                // Generate receipt
                generateReceipt(newPayment);
                
                showSuccess(`Payment of ${formatCurrency(paymentData.amount)} recorded successfully`);
                return newPayment.id;
            } catch (error) {
                console.error('Error adding fee payment:', error);
                showError('Failed to record payment');
                return null;
            }
        }
        
        // Generate receipt
        function generateReceipt(payment) {
            try {
                const student = appData.students.find(s => s.id === payment.studentId);
                const feeItem = appData.feeItems.find(f => f.id === payment.feeItemId);
                
                if (!student || !feeItem) {
                    showError('Student or fee item not found');
                    return;
                }
                
                const logoHtml = appData.settings.schoolLogo ? 
                    `<img src="${appData.settings.schoolLogo}" class="receipt-logo" alt="School Logo">` :
                    `<div class="receipt-logo" style="background-color: var(--primary-color); color: white; display: flex; align-items: center; justify-content: center; border-radius: 50%;">
                        <i class="fas fa-school" style="font-size: 3rem;"></i>
                    </div>`;
                
                const receiptContent = document.getElementById('receipt-content');
                receiptContent.innerHTML = `
                    <div class="receipt-container">
                        <div class="receipt-header">
                            ${logoHtml}
                            <h2 style="color: var(--primary-color); margin: 10px 0;">${appData.settings.schoolName}</h2>
                            <p>${appData.settings.schoolAddress}</p>
                            <p>Tel: ${appData.settings.schoolPhone} | Email: ${appData.settings.schoolEmail}</p>
                            <h3 style="margin-top: 20px; border-top: 2px solid var(--primary-color); padding-top: 10px;">OFFICIAL PAYMENT RECEIPT</h3>
                        </div>
                        
                        <div class="receipt-details">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                                <div>
                                    <strong>Receipt No:</strong> ${payment.receiptNo}<br>
                                    <strong>Date:</strong> ${formatDate(payment.date)}
                                </div>
                                <div>
                                    <strong>Student ID:</strong> ${student.id}<br>
                                    <strong>Class:</strong> ${student.class.toUpperCase()}
                                </div>
                            </div>
                            
                            <div>
                                <strong>Student:</strong> ${student.firstName} ${student.lastName}<br>
                                <strong>Parent/Guardian:</strong> ${student.parentName}<br>
                                <strong>Contact:</strong> ${student.parentPhone}
                            </div>
                        </div>
                        
                        <table class="receipt-table">
                            <thead>
                                <tr>
                                    <th>Description</th>
                                    <th>Amount (KES)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>${feeItem.name}</td>
                                    <td class="currency">${formatCurrency(payment.amount)}</td>
                                </tr>
                                <tr>
                                    <td colspan="2" style="text-align: right; padding-top: 20px;">
                                        <strong>Payment Method:</strong> ${payment.paymentMethod}<br>
                                        ${payment.reference ? `<strong>Reference:</strong> ${payment.reference}<br>` : ''}
                                        ${payment.notes ? `<strong>Notes:</strong> ${payment.notes}` : ''}
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        
                        <div class="receipt-totals">
                            <div style="font-size: 1.2rem; color: var(--success-color);">
                                TOTAL AMOUNT PAID: ${formatCurrency(payment.amount)}
                            </div>
                            <div style="margin-top: 10px; font-size: 1.5rem; font-weight: bold;">
                                ${formatCurrency(payment.amount)}
                            </div>
                        </div>
                        
                        <div class="receipt-footer">
                            <div>Thank you for your payment</div>
                            <div style="margin-top: 10px;">
                                <strong>Received by:</strong> ${payment.recordedBy}<br>
                                <strong>Date & Time:</strong> ${formatDate(payment.timestamp)} ${new Date(payment.timestamp).toLocaleTimeString()}
                            </div>
                            <div style="margin-top: 20px; font-size: 0.8rem; color: #999;">
                                Generated by Edu-Track CBE Pro Fees Management System
                            </div>
                        </div>
                    </div>
                `;
                
                // Show receipt modal
                document.getElementById('receipt-modal').classList.add('active');
            } catch (error) {
                console.error('Error generating receipt:', error);
                showError('Failed to generate receipt');
            }
        }
        
        // ============================================
        // FEE REMINDERS FUNCTIONS - ENHANCED PRINTING
        // ============================================
        
        // Load fee reminders
        function loadFeeReminders(filterClass = 'all', filterStudent = 'all', filterStatus = 'all') {
            const container = document.getElementById('reminders-container');
            let students = [...appData.students];
            
            // Apply filters
            if (filterClass !== 'all') {
                students = students.filter(student => student.class === filterClass);
            }
            
            if (filterStudent !== 'all') {
                students = students.filter(student => student.id === filterStudent);
            }
            
            // Clear container
            container.innerHTML = '';
            
            let hasReminders = false;
            
            // Process each student
            students.forEach(student => {
                const totalFees = calculateTotalFees(student);
                const totalPaid = calculateTotalPaid(student.id);
                const balance = totalFees - totalPaid;
                
                if (balance <= 0 && filterStatus !== 'paid') {
                    return; // Skip fully paid students unless showing paid status
                }
                
                // Calculate fee balances
                const feeBalances = [];
                let hasOverdue = false;
                let hasDueSoon = false;
                
                student.feeItems.forEach(feeItemId => {
                    const feeItem = appData.feeItems.find(f => f.id === feeItemId);
                    if (feeItem) {
                        const paidAmount = calculatePaidForFeeItem(student.id, feeItemId);
                        const feeBalance = feeItem.amount - paidAmount;
                        
                        if (feeBalance > 0) {
                            const dueDate = calculateDueDate(student, feeItemId);
                            const overdue = dueDate && isFeeOverdue(dueDate);
                            const dueSoon = dueDate && isFeeDueSoon(dueDate);
                            
                            if (overdue) hasOverdue = true;
                            if (dueSoon) hasDueSoon = true;
                            
                            // Apply status filter
                            if (filterStatus === 'overdue' && !overdue) return;
                            if (filterStatus === 'due_soon' && !dueSoon) return;
                            if (filterStatus === 'paid' && feeBalance > 0) return;
                            
                            feeBalances.push({
                                name: feeItem.name,
                                amount: feeItem.amount,
                                paid: paidAmount,
                                balance: feeBalance,
                                dueDate: dueDate,
                                overdue: overdue,
                                dueSoon: dueSoon
                            });
                        }
                    }
                });
                
                if (feeBalances.length === 0 && filterStatus !== 'paid') return;
                
                hasReminders = true;
                
                // Calculate total overdue amount
                const overdueAmount = feeBalances.reduce((sum, fee) => 
                    fee.overdue ? sum + fee.balance : sum, 0);
                
                // Create reminder card
                const reminderCard = document.createElement('div');
                reminderCard.className = `reminder-card ${overdueAmount > 0 ? 'overdue' : ''}`;
                
                // Build fee balance details HTML
                let feeBalanceHTML = '';
                feeBalances.forEach(fee => {
                    let statusBadge = '';
                    if (fee.overdue) {
                        statusBadge = '<span class="badge badge-danger" style="margin-left: 10px;">OVERDUE</span>';
                    } else if (fee.dueSoon) {
                        statusBadge = '<span class="badge badge-warning" style="margin-left: 10px;">DUE SOON</span>';
                    }
                    
                    feeBalanceHTML += `
                        <div class="fee-balance-item">
                            <div>
                                <strong>${fee.name}</strong><br>
                                <small>Due: ${fee.dueDate ? formatDate(fee.dueDate) : 'N/A'} ${statusBadge}</small>
                            </div>
                            <div style="text-align: right;">
                                <div>Amount: <span class="currency">${formatCurrency(fee.amount)}</span></div>
                                <div>Paid: <span class="currency">${formatCurrency(fee.paid)}</span></div>
                                <div>Balance: <span class="currency">${formatCurrency(fee.balance)}</span></div>
                            </div>
                        </div>
                    `;
                });
                
                reminderCard.innerHTML = `
                    <div class="reminder-header">
                        <div class="reminder-student">
                            <strong>${student.firstName} ${student.lastName} (${student.class.toUpperCase()})</strong><br>
                            Parent: ${student.parentName} | Phone: ${student.parentPhone}
                            ${student.parentEmail ? `| Email: ${student.parentEmail}` : ''}
                        </div>
                        <div class="reminder-amount">
                            Total Fees: <span class="currency">${formatCurrency(totalFees)}</span><br>
                            Paid: <span class="currency">${formatCurrency(totalPaid)}</span><br>
                            Balance: <span class="currency">${formatCurrency(balance)}</span><br>
                            ${overdueAmount > 0 ? `Overdue: <span class="currency">${formatCurrency(overdueAmount)}</span>` : ''}
                        </div>
                    </div>
                    
                    <div class="fee-balance-details">
                        <h4 style="margin-bottom: 10px; color: var(--primary-color);">Fee Balances:</h4>
                        ${feeBalanceHTML}
                    </div>
                    
                    <div class="reminder-message">
                        Dear Parent/Guardian,<br><br>
                        This is to remind you that your child <strong>${student.firstName} ${student.lastName}</strong> 
                        has outstanding fee ${overdueAmount > 0 ? `<strong>arrears of ${formatCurrency(overdueAmount)} that are OVERDUE</strong>` : `balances totaling ${formatCurrency(balance)}`}.<br><br>
                        Kindly clear the balance at your earliest convenience to avoid inconveniences. 
                        Contact the accounts office for any clarification.<br><br>
                        Thank you.
                    </div>
                    <div class="actions">
                        <button class="btn-icon btn-success btn-small send-email" data-id="${student.id}">
                            <i class="fas fa-envelope"></i> Email
                        </button>
                        <button class="btn-icon btn-success btn-small send-whatsapp" data-id="${student.id}">
                            <i class="fab fa-whatsapp"></i> WhatsApp
                        </button>
                        <button class="btn-icon btn-success btn-small send-sms" data-id="${student.id}">
                            <i class="fas fa-sms"></i> SMS
                        </button>
                        <button class="btn-icon btn-secondary btn-small print-reminder" data-id="${student.id}">
                            <i class="fas fa-print"></i> Print
                        </button>
                    </div>
                `;
                
                container.appendChild(reminderCard);
            });
            
            if (!hasReminders) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <i class="fas fa-bell-slash" style="font-size: 3rem; margin-bottom: 15px; color: #ddd;"></i>
                        <h3>No Fee Reminders</h3>
                        <p>${filterStatus === 'paid' ? 'No students with fully paid fees found.' : 'All students are up to date with their fee payments.'}</p>
                    </div>
                `;
            }
            
            // Add event listeners to reminder buttons
            addReminderActionListeners();
        }
        
        // Print reminders with school header and logo
        function printReminders(filterType = 'all') {
            try {
                const filterClass = document.getElementById('reminder-class-filter').value;
                const filterStudent = document.getElementById('reminder-student-filter').value;
                const filterStatus = filterType === 'overdue' ? 'overdue' : 
                                  filterType === 'due_soon' ? 'due_soon' : 
                                  filterType === 'paid' ? 'paid' : 'all';
                
                let students = [...appData.students];
                
                // Apply filters
                if (filterClass !== 'all') {
                    students = students.filter(student => student.class === filterClass);
                }
                
                if (filterStudent !== 'all') {
                    students = students.filter(student => student.id === filterStudent);
                }
                
                const studentsWithReminders = students.filter(student => {
                    const totalFees = calculateTotalFees(student);
                    const totalPaid = calculateTotalPaid(student.id);
                    const balance = totalFees - totalPaid;
                    
                    if (balance <= 0 && filterStatus !== 'paid') return false;
                    
                    let hasMatchingFees = false;
                    student.feeItems.forEach(feeItemId => {
                        const feeItem = appData.feeItems.find(f => f.id === feeItemId);
                        if (feeItem) {
                            const paidAmount = calculatePaidForFeeItem(student.id, feeItemId);
                            const feeBalance = feeItem.amount - paidAmount;
                            
                            if (feeBalance > 0) {
                                const dueDate = calculateDueDate(student, feeItemId);
                                const overdue = dueDate && isFeeOverdue(dueDate);
                                const dueSoon = dueDate && isFeeDueSoon(dueDate);
                                
                                // Apply status filter
                                if (filterStatus === 'overdue' && !overdue) return;
                                if (filterStatus === 'due_soon' && !dueSoon) return;
                                if (filterStatus === 'paid' && feeBalance > 0) return;
                                
                                hasMatchingFees = true;
                            }
                        }
                    });
                    
                    return hasMatchingFees || (filterStatus === 'paid' && balance <= 0);
                });
                
                if (studentsWithReminders.length === 0) {
                    showInfo('No reminders to print with current filters');
                    return;
                }
                
                // School logo HTML
                const logoHtml = appData.settings.schoolLogo ? 
                    `<img src="${appData.settings.schoolLogo}" style="width: 80px; height: 80px; object-fit: contain; margin-bottom: 10px;">` :
                    `<div style="width: 80px; height: 80px; background-color: #1a5f7a; color: white; display: flex; align-items: center; justify-content: center; border-radius: 50%; margin: 0 auto 10px;">
                        <i class="fas fa-school" style="font-size: 2rem;"></i>
                    </div>`;
                
                // Create print content with professional header and footer
                let printContent = `
                    <html>
                    <head>
                        <title>Fee Reminders - ${appData.settings.schoolName}</title>
                        <style>
                            @media print {
                                @page {
                                    margin: 20mm;
                                }
                                body {
                                    font-family: 'Arial', sans-serif;
                                    margin: 0;
                                    padding: 0;
                                    color: #000;
                                    background: #fff;
                                }
                                .no-print {
                                    display: none !important;
                                }
                            }
                            body {
                                font-family: 'Arial', sans-serif;
                                margin: 20px;
                                color: #333;
                            }
                            .print-header {
                                text-align: center;
                                margin-bottom: 30px;
                                padding-bottom: 20px;
                                border-bottom: 2px solid #1a5f7a;
                                page-break-after: avoid;
                            }
                            .school-name {
                                font-size: 24px;
                                font-weight: bold;
                                color: #1a5f7a;
                                margin: 10px 0 5px 0;
                            }
                            .school-info {
                                font-size: 14px;
                                color: #666;
                                margin: 5px 0;
                            }
                            .print-title {
                                font-size: 20px;
                                font-weight: bold;
                                margin: 20px 0 10px 0;
                                color: #333;
                            }
                            .print-subtitle {
                                font-size: 16px;
                                color: #666;
                                margin-bottom: 20px;
                            }
                            .reminder-card {
                                margin-bottom: 30px;
                                padding: 20px;
                                border: 1px solid #ddd;
                                border-radius: 8px;
                                page-break-inside: avoid;
                                background-color: #fff;
                            }
                            .reminder-header {
                                display: flex;
                                justify-content: space-between;
                                margin-bottom: 15px;
                                padding-bottom: 10px;
                                border-bottom: 1px solid #eee;
                            }
                            .student-info {
                                flex: 1;
                            }
                            .student-name {
                                font-weight: bold;
                                font-size: 18px;
                                color: #1a5f7a;
                            }
                            .student-details {
                                font-size: 14px;
                                color: #666;
                                margin-top: 5px;
                            }
                            .fee-summary {
                                text-align: right;
                                font-size: 14px;
                            }
                            .fee-balances {
                                margin: 15px 0;
                            }
                            .fee-item {
                                display: flex;
                                justify-content: space-between;
                                padding: 10px;
                                margin: 5px 0;
                                background-color: #f8f9fa;
                                border-radius: 5px;
                                border-left: 4px solid #1a5f7a;
                            }
                            .fee-item.overdue {
                                border-left-color: #dc3545;
                                background-color: #ffe6e6;
                            }
                            .fee-item.due-soon {
                                border-left-color: #ffc107;
                                background-color: #fff9e6;
                            }
                            .reminder-message {
                                margin-top: 20px;
                                padding: 15px;
                                background-color: #f8f9fa;
                                border-radius: 5px;
                                line-height: 1.6;
                                font-size: 14px;
                            }
                            .print-footer {
                                text-align: center;
                                margin-top: 40px;
                                padding-top: 20px;
                                border-top: 2px solid #1a5f7a;
                                font-size: 12px;
                                color: #666;
                                page-break-before: avoid;
                            }
                            .page-number {
                                float: right;
                                font-size: 12px;
                                color: #999;
                            }
                            .total-overdue {
                                color: #dc3545;
                                font-weight: bold;
                            }
                            .currency {
                                font-family: 'Courier New', monospace;
                                font-weight: bold;
                            }
                        </style>
                    </head>
                    <body>
                        <div class="print-header">
                            ${logoHtml}
                            <div class="school-name">${appData.settings.schoolName}</div>
                            <div class="school-info">${appData.settings.schoolAddress}</div>
                            <div class="school-info">Tel: ${appData.settings.schoolPhone} | Email: ${appData.settings.schoolEmail}</div>
                            <div class="print-title">FEE REMINDERS</div>
                            <div class="print-subtitle">
                                Date: ${formatDate(new Date())}
                                ${filterClass !== 'all' ? ` | Class: ${filterClass.toUpperCase()}` : ''}
                                ${filterStudent !== 'all' ? ` | Student: ${studentsWithReminders[0]?.firstName || ''} ${studentsWithReminders[0]?.lastName || ''}` : ''}
                                ${filterStatus !== 'all' ? ` | Status: ${filterStatus.replace('_', ' ').toUpperCase()}` : ''}
                            </div>
                        </div>
                `;
                
                studentsWithReminders.forEach((student, index) => {
                    const totalFees = calculateTotalFees(student);
                    const totalPaid = calculateTotalPaid(student.id);
                    const balance = totalFees - totalPaid;
                    
                    // Calculate fee balances
                    const feeBalances = [];
                    let overdueAmount = 0;
                    
                    student.feeItems.forEach(feeItemId => {
                        const feeItem = appData.feeItems.find(f => f.id === feeItemId);
                        if (feeItem) {
                            const paidAmount = calculatePaidForFeeItem(student.id, feeItemId);
                            const feeBalance = feeItem.amount - paidAmount;
                            
                            if (feeBalance > 0) {
                                const dueDate = calculateDueDate(student, feeItemId);
                                const overdue = dueDate && isFeeOverdue(dueDate);
                                const dueSoon = dueDate && isFeeDueSoon(dueDate);
                                
                                // Apply status filter
                                if (filterStatus === 'overdue' && !overdue) return;
                                if (filterStatus === 'due_soon' && !dueSoon) return;
                                if (filterStatus === 'paid' && feeBalance > 0) return;
                                
                                if (overdue) overdueAmount += feeBalance;
                                
                                feeBalances.push({
                                    name: feeItem.name,
                                    amount: feeItem.amount,
                                    paid: paidAmount,
                                    balance: feeBalance,
                                    dueDate: dueDate,
                                    overdue: overdue,
                                    dueSoon: dueSoon
                                });
                            }
                        }
                    });
                    
                    if (feeBalances.length === 0 && filterStatus !== 'paid') return;
                    
                    printContent += `
                        <div class="reminder-card">
                            <div class="reminder-header">
                                <div class="student-info">
                                    <div class="student-name">${student.firstName} ${student.lastName} (${student.class.toUpperCase()})</div>
                                    <div class="student-details">
                                        Student ID: ${student.id}<br>
                                        Parent: ${student.parentName}<br>
                                        Contact: ${student.parentPhone}
                                        ${student.parentEmail ? `<br>Email: ${student.parentEmail}` : ''}
                                    </div>
                                </div>
                                <div class="fee-summary">
                                    Total Fees: <span class="currency">${formatCurrency(totalFees)}</span><br>
                                    Total Paid: <span class="currency">${formatCurrency(totalPaid)}</span><br>
                                    Balance Due: <span class="currency">${formatCurrency(balance)}</span><br>
                                    ${overdueAmount > 0 ? `<span class="total-overdue">Overdue: ${formatCurrency(overdueAmount)}</span>` : ''}
                                </div>
                            </div>
                    `;
                    
                    if (feeBalances.length > 0) {
                        printContent += `<div class="fee-balances">`;
                        feeBalances.forEach(fee => {
                            const feeClass = fee.overdue ? 'overdue' : fee.dueSoon ? 'due-soon' : '';
                            const statusText = fee.overdue ? ' - OVERDUE' : fee.dueSoon ? ' - DUE SOON' : '';
                            
                            printContent += `
                                <div class="fee-item ${feeClass}">
                                    <div>
                                        <strong>${fee.name}</strong>${statusText}<br>
                                        <small>Due: ${fee.dueDate ? formatDate(fee.dueDate) : 'N/A'}</small>
                                    </div>
                                    <div style="text-align: right;">
                                        <div>Amount: <span class="currency">${formatCurrency(fee.amount)}</span></div>
                                        <div>Paid: <span class="currency">${formatCurrency(fee.paid)}</span></div>
                                        <div>Balance: <span class="currency">${formatCurrency(fee.balance)}</span></div>
                                    </div>
                                </div>
                            `;
                        });
                        printContent += `</div>`;
                    }
                    
                    printContent += `
                            <div class="reminder-message">
                                <strong>Dear Parent/Guardian,</strong><br><br>
                                This is to remind you that your child <strong>${student.firstName} ${student.lastName}</strong> 
                                has outstanding fee ${overdueAmount > 0 ? `<strong class="total-overdue">arrears of ${formatCurrency(overdueAmount)} that are OVERDUE</strong>` : `balances totaling ${formatCurrency(balance)}`}.<br><br>
                                Kindly clear the balance at your earliest convenience to avoid inconveniences. 
                                Contact the accounts office for any clarification.<br><br>
                                <strong>Thank you.</strong>
                            </div>
                        </div>
                    `;
                });
                
                printContent += `
                        <div class="print-footer">
                            <hr>
                            <p><strong>Generated by Edu-Track CBE Pro Fees Management System</strong></p>
                            <p>${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}</p>
                            <div class="page-number">Page <span class="page-number"></span></div>
                        </div>
                        <div class="no-print" style="text-align: center; margin-top: 20px; padding: 20px; background-color: #f8f9fa; border-radius: 8px;">
                            <button onclick="window.print()" style="padding: 10px 20px; background-color: #1a5f7a; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">
                                <i class="fas fa-print"></i> Print Reminders
                            </button>
                            <button onclick="window.close()" style="padding: 10px 20px; background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                <i class="fas fa-times"></i> Close
                            </button>
                        </div>
                    </body>
                    </html>
                `;
                
                // Open print window
                const printWindow = window.open('', '_blank');
                printWindow.document.write(printContent);
                printWindow.document.close();
                printWindow.focus();
                
                // Add page numbers
                setTimeout(() => {
                    const pageNumbers = printWindow.document.querySelectorAll('.page-number');
                    pageNumbers.forEach((el, index) => {
                        el.textContent = index + 1;
                    });
                }, 100);
                
                // Show button notification
                const button = document.getElementById(filterType === 'overdue' ? 'print-overdue-reminders' : 'print-all-reminders');
                showButtonNotification(button, true);
                
            } catch (error) {
                console.error('Error printing reminders:', error);
                showError('Failed to print reminders');
                const button = document.getElementById(filterType === 'overdue' ? 'print-overdue-reminders' : 'print-all-reminders');
                showButtonNotification(button, false);
            }
        }
        
        // Print individual reminder
        function printIndividualReminder(studentId) {
            try {
                const student = appData.students.find(s => s.id === studentId);
                if (!student) {
                    showError('Student not found');
                    return;
                }
                
                const totalFees = calculateTotalFees(student);
                const totalPaid = calculateTotalPaid(student.id);
                const balance = totalFees - totalPaid;
                
                // Calculate fee balances
                const feeBalances = [];
                let overdueAmount = 0;
                
                student.feeItems.forEach(feeItemId => {
                    const feeItem = appData.feeItems.find(f => f.id === feeItemId);
                    if (feeItem) {
                        const paidAmount = calculatePaidForFeeItem(student.id, feeItemId);
                        const feeBalance = feeItem.amount - paidAmount;
                        
                        if (feeBalance > 0) {
                            const dueDate = calculateDueDate(student, feeItemId);
                            const overdue = dueDate && isFeeOverdue(dueDate);
                            const dueSoon = dueDate && isFeeDueSoon(dueDate);
                            
                            if (overdue) overdueAmount += feeBalance;
                            
                            feeBalances.push({
                                name: feeItem.name,
                                amount: feeItem.amount,
                                paid: paidAmount,
                                balance: feeBalance,
                                dueDate: dueDate,
                                overdue: overdue,
                                dueSoon: dueSoon
                            });
                        }
                    }
                });
                
                if (feeBalances.length === 0) {
                    showInfo('No outstanding fees for this student');
                    return;
                }
                
                // School logo HTML
                const logoHtml = appData.settings.schoolLogo ? 
                    `<img src="${appData.settings.schoolLogo}" style="width: 80px; height: 80px; object-fit: contain; margin-bottom: 10px;">` :
                    `<div style="width: 80px; height: 80px; background-color: #1a5f7a; color: white; display: flex; align-items: center; justify-content: center; border-radius: 50%; margin: 0 auto 10px;">
                        <i class="fas fa-school" style="font-size: 2rem;"></i>
                    </div>`;
                
                // Create print content
                let printContent = `
                    <html>
                    <head>
                        <title>Fee Reminder - ${student.firstName} ${student.lastName}</title>
                        <style>
                            @media print {
                                @page {
                                    margin: 20mm;
                                }
                                body {
                                    font-family: 'Arial', sans-serif;
                                    margin: 0;
                                    padding: 0;
                                    color: #000;
                                    background: #fff;
                                }
                                .no-print {
                                    display: none !important;
                                }
                            }
                            body {
                                font-family: 'Arial', sans-serif;
                                margin: 20px;
                                color: #333;
                            }
                            .print-header {
                                text-align: center;
                                margin-bottom: 30px;
                                padding-bottom: 20px;
                                border-bottom: 2px solid #1a5f7a;
                                page-break-after: avoid;
                            }
                            .school-name {
                                font-size: 24px;
                                font-weight: bold;
                                color: #1a5f7a;
                                margin: 10px 0 5px 0;
                            }
                            .school-info {
                                font-size: 14px;
                                color: #666;
                                margin: 5px 0;
                            }
                            .print-title {
                                font-size: 20px;
                                font-weight: bold;
                                margin: 20px 0 10px 0;
                                color: #333;
                            }
                            .reminder-card {
                                margin-bottom: 30px;
                                padding: 20px;
                                border: 1px solid #ddd;
                                border-radius: 8px;
                                page-break-inside: avoid;
                                background-color: #fff;
                            }
                            .reminder-header {
                                display: flex;
                                justify-content: space-between;
                                margin-bottom: 20px;
                                padding-bottom: 15px;
                                border-bottom: 1px solid #eee;
                            }
                            .student-info {
                                flex: 1;
                            }
                            .student-name {
                                font-weight: bold;
                                font-size: 20px;
                                color: #1a5f7a;
                            }
                            .student-details {
                                font-size: 14px;
                                color: #666;
                                margin-top: 5px;
                            }
                            .fee-summary {
                                text-align: right;
                                font-size: 16px;
                            }
                            .fee-balances {
                                margin: 20px 0;
                            }
                            .fee-item {
                                display: flex;
                                justify-content: space-between;
                                padding: 12px;
                                margin: 8px 0;
                                background-color: #f8f9fa;
                                border-radius: 5px;
                                border-left: 4px solid #1a5f7a;
                            }
                            .fee-item.overdue {
                                border-left-color: #dc3545;
                                background-color: #ffe6e6;
                            }
                            .fee-item.due-soon {
                                border-left-color: #ffc107;
                                background-color: #fff9e6;
                            }
                            .reminder-message {
                                margin-top: 25px;
                                padding: 20px;
                                background-color: #f8f9fa;
                                border-radius: 5px;
                                line-height: 1.6;
                                font-size: 15px;
                            }
                            .print-footer {
                                text-align: center;
                                margin-top: 40px;
                                padding-top: 20px;
                                border-top: 2px solid #1a5f7a;
                                font-size: 12px;
                                color: #666;
                                page-break-before: avoid;
                            }
                            .total-overdue {
                                color: #dc3545;
                                font-weight: bold;
                                font-size: 18px;
                            }
                            .currency {
                                font-family: 'Courier New', monospace;
                                font-weight: bold;
                            }
                        </style>
                    </head>
                    <body>
                        <div class="print-header">
                            ${logoHtml}
                            <div class="school-name">${appData.settings.schoolName}</div>
                            <div class="school-info">${appData.settings.schoolAddress}</div>
                            <div class="school-info">Tel: ${appData.settings.schoolPhone} | Email: ${appData.settings.schoolEmail}</div>
                            <div class="print-title">FEE REMINDER</div>
                            <div style="font-size: 14px; color: #666; margin-top: 10px;">
                                Date: ${formatDate(new Date())}
                            </div>
                        </div>
                        
                        <div class="reminder-card">
                            <div class="reminder-header">
                                <div class="student-info">
                                    <div class="student-name">${student.firstName} ${student.lastName} (${student.class.toUpperCase()})</div>
                                    <div class="student-details">
                                        Student ID: ${student.id}<br>
                                        Parent: ${student.parentName}<br>
                                        Contact: ${student.parentPhone}
                                        ${student.parentEmail ? `<br>Email: ${student.parentEmail}` : ''}
                                    </div>
                                </div>
                                <div class="fee-summary">
                                    Total Fees: <span class="currency">${formatCurrency(totalFees)}</span><br>
                                    Total Paid: <span class="currency">${formatCurrency(totalPaid)}</span><br>
                                    Balance Due: <span class="currency">${formatCurrency(balance)}</span><br>
                                    ${overdueAmount > 0 ? `<span class="total-overdue">Overdue: ${formatCurrency(overdueAmount)}</span>` : ''}
                                </div>
                            </div>
                            
                            <div class="fee-balances">
                `;
                
                feeBalances.forEach(fee => {
                    const feeClass = fee.overdue ? 'overdue' : fee.dueSoon ? 'due-soon' : '';
                    const statusText = fee.overdue ? ' - <strong style="color: #dc3545;">OVERDUE</strong>' : 
                                     fee.dueSoon ? ' - <strong style="color: #ffc107;">DUE SOON</strong>' : '';
                    
                    printContent += `
                        <div class="fee-item ${feeClass}">
                            <div>
                                <strong>${fee.name}</strong>${statusText}<br>
                                <small>Due Date: ${fee.dueDate ? formatDate(fee.dueDate) : 'N/A'}</small>
                            </div>
                            <div style="text-align: right;">
                                <div>Amount: <span class="currency">${formatCurrency(fee.amount)}</span></div>
                                <div>Paid: <span class="currency">${formatCurrency(fee.paid)}</span></div>
                                <div>Balance: <span class="currency">${formatCurrency(fee.balance)}</span></div>
                            </div>
                        </div>
                    `;
                });
                
                printContent += `
                            </div>
                            
                            <div class="reminder-message">
                                <strong>Dear Parent/Guardian,</strong><br><br>
                                This is to remind you that your child <strong>${student.firstName} ${student.lastName}</strong> 
                                has outstanding fee ${overdueAmount > 0 ? `<strong class="total-overdue">arrears of ${formatCurrency(overdueAmount)} that are OVERDUE</strong>` : `balances totaling ${formatCurrency(balance)}`}.<br><br>
                                Kindly clear the balance at your earliest convenience to avoid inconveniences. 
                                Contact the accounts office for any clarification.<br><br>
                                <strong>Thank you.</strong>
                            </div>
                        </div>
                        
                        <div class="print-footer">
                            <hr>
                            <p><strong>Generated by Edu-Track CBE Pro Fees Management System</strong></p>
                            <p>${new Date().toLocaleDateString()} ${new Date().toLocaleTimeString()}</p>
                        </div>
                        <div class="no-print" style="text-align: center; margin-top: 20px; padding: 20px; background-color: #f8f9fa; border-radius: 8px;">
                            <button onclick="window.print()" style="padding: 10px 20px; background-color: #1a5f7a; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 10px;">
                                <i class="fas fa-print"></i> Print Reminder
                            </button>
                            <button onclick="window.close()" style="padding: 10px 20px; background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                <i class="fas fa-times"></i> Close
                            </button>
                        </div>
                    </body>
                    </html>
                `;
                
                // Open print window
                const printWindow = window.open('', '_blank');
                printWindow.document.write(printContent);
                printWindow.document.close();
                printWindow.focus();
                
                showSuccess('Reminder printed successfully');
            } catch (error) {
                console.error('Error printing individual reminder:', error);
                showError('Failed to print reminder');
            }
        }
        
        // ============================================
        // FEE SETTING FUNCTIONS - FIXED VISIBILITY
        // ============================================
        
        // Load fee items for management - FIXED VISIBILITY
        function loadFeeItems() {
            try {
                const container = document.getElementById('fee-items-list');
                
                if (!container) {
                    console.error('Fee items list container not found');
                    return;
                }
                
                container.innerHTML = '';
                
                if (!appData.feeItems || appData.feeItems.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #666; grid-column: 1 / -1;">
                            <i class="fas fa-money-bill-wave" style="font-size: 3rem; margin-bottom: 15px; color: #ddd;"></i>
                            <h3>No Fee Items Found</h3>
                            <p>Click "Add New Fee Item" to create your first fee item</p>
                        </div>
                    `;
                    return;
                }
                
                // Sort fee items: required first, then active, then by name
                const sortedFeeItems = [...appData.feeItems].sort((a, b) => {
                    if (a.isRequired && !b.isRequired) return -1;
                    if (!a.isRequired && b.isRequired) return 1;
                    if (a.active && !b.active) return -1;
                    if (!a.active && b.active) return 1;
                    return a.name.localeCompare(b.name);
                });
                
                sortedFeeItems.forEach(feeItem => {
                    const feeCard = document.createElement('div');
                    feeCard.className = `fee-item-card ${feeItem.isRequired ? 'required' : ''} ${!feeItem.active ? 'inactive' : ''}`;
                    feeCard.setAttribute('data-id', feeItem.id);
                    
                    // Build details string
                    let details = '';
                    if (feeItem.category) details += `Category: ${feeItem.category}`;
                    if (feeItem.description) details += details ? ` | ${feeItem.description}` : feeItem.description;
                    if (feeItem.dueDays) details += details ? ` | Due: ${feeItem.dueDays} days` : `Due: ${feeItem.dueDays} days`;
                    if (feeItem.term && feeItem.term !== 'all') details += details ? ` | Term: ${feeItem.term}` : `Term: ${feeItem.term}`;
                    
                    feeCard.innerHTML = `
                        <div class="fee-item-header">
                            <div>
                                <div class="fee-item-name">${feeItem.name}</div>
                                <div class="fee-item-details">
                                    ${details || 'No additional details'}
                                </div>
                            </div>
                            <div class="fee-item-amount">${formatCurrency(feeItem.amount)}</div>
                        </div>
                        
                        <div class="fee-item-status">
                            <span class="badge ${feeItem.isRequired ? 'badge-danger' : 'badge-info'}">
                                ${feeItem.isRequired ? 'Required' : 'Optional'}
                            </span>
                            <span class="badge ${feeItem.active ? 'badge-success' : 'badge-warning'}">
                                ${feeItem.active ? 'Active' : 'Inactive'}
                            </span>
                            <span class="badge badge-primary">
                                ${feeItem.category || 'Uncategorized'}
                            </span>
                        </div>
                        
                        <div class="fee-item-actions">
                            <button class="btn-icon btn-info btn-small edit-fee-item" data-id="${feeItem.id}">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="btn-icon ${feeItem.active ? 'btn-warning' : 'btn-success'} btn-small toggle-fee-active" data-id="${feeItem.id}">
                                <i class="fas ${feeItem.active ? 'fa-times' : 'fa-check'}"></i> 
                                ${feeItem.active ? 'Disable' : 'Enable'}
                            </button>
                            <button class="btn-icon ${feeItem.isRequired ? 'btn-secondary' : 'btn-danger'} btn-small toggle-fee-required" data-id="${feeItem.id}">
                                <i class="fas ${feeItem.isRequired ? 'fa-star' : 'fa-star-o'}"></i> 
                                ${feeItem.isRequired ? 'Mark Optional' : 'Mark Required'}
                            </button>
                            <button class="btn-icon btn-danger btn-small delete-fee-item" data-id="${feeItem.id}">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    `;
                    
                    container.appendChild(feeCard);
                });
                
                // Add event listeners
                addFeeItemActionListeners();
            } catch (error) {
                console.error('Error loading fee items:', error);
                showError('Failed to load fee items');
            }
        }
        
        // Add or update fee item
        function saveFeeItem(feeData) {
            try {
                const feeId = document.getElementById('fee-item-id').value;
                const feeAmount = parseFloat(feeData.amount);
                const dueDays = feeData.dueDays ? parseInt(feeData.dueDays) : null;
                
                if (isNaN(feeAmount) || feeAmount < 0) {
                    showError('Please enter a valid fee amount');
                    return;
                }
                
                if (dueDays !== null && (isNaN(dueDays) || dueDays < 0)) {
                    showError('Please enter a valid due days number');
                    return;
                }
                
                const feeItemData = {
                    ...feeData,
                    amount: feeAmount,
                    dueDays: dueDays,
                    term: feeData.term || 'all'
                };
                
                let success = false;
                if (feeId) {
                    // Update existing fee item
                    const index = appData.feeItems.findIndex(f => f.id === feeId);
                    if (index !== -1) {
                        appData.feeItems[index] = {
                            ...appData.feeItems[index],
                            ...feeItemData
                        };
                        showSuccess('Fee item updated successfully');
                        success = true;
                    }
                } else {
                    // Add new fee item
                    const newFeeItem = {
                        id: generateId(),
                        ...feeItemData
                    };
                    appData.feeItems.push(newFeeItem);
                    showSuccess('Fee item added successfully');
                    success = true;
                }
                
                if (success) {
                    saveToLocalStorage();
                    loadFeeItems(); // Reload to show updated items
                    loadFeeSelection();
                    populateStudentDropdowns();
                    populateReminderDropdowns();
                    clearFeeForm();
                    loadFeeRegisterTable(); // Update fee register with new fee items
                    loadFeeReminders(); // Update reminders with new due dates
                    
                    // Show button notification
                    const button = document.getElementById('save-fee-item');
                    showButtonNotification(button, true);
                } else {
                    showError('Failed to save fee item');
                    const button = document.getElementById('save-fee-item');
                    showButtonNotification(button, false);
                }
            } catch (error) {
                console.error('Error saving fee item:', error);
                showError('Failed to save fee item');
                const button = document.getElementById('save-fee-item');
                showButtonNotification(button, false);
            }
        }
        
        // Edit fee item
        function editFeeItem(feeId) {
            try {
                const feeItem = appData.feeItems.find(f => f.id === feeId);
                if (feeItem) {
                    document.getElementById('fee-item-id').value = feeItem.id;
                    document.getElementById('fee-item-name').value = feeItem.name;
                    document.getElementById('fee-item-amount').value = feeItem.amount;
                    document.getElementById('fee-item-category').value = feeItem.category || 'tuition';
                    document.getElementById('fee-item-description').value = feeItem.description || '';
                    document.getElementById('fee-item-due-days').value = feeItem.dueDays || '';
                    document.getElementById('fee-item-term').value = feeItem.term || 'all';
                    document.getElementById('fee-item-required').checked = feeItem.isRequired || false;
                    document.getElementById('fee-item-active').checked = feeItem.active !== false;
                    
                    // Show form
                    document.getElementById('fee-item-form-container').classList.add('active');
                    
                    // Scroll to form
                    document.getElementById('fee-item-form').scrollIntoView({ behavior: 'smooth' });
                    
                    showInfo('Fee item loaded for editing');
                } else {
                    showError('Fee item not found');
                }
            } catch (error) {
                console.error('Error editing fee item:', error);
                showError('Failed to load fee item for editing');
            }
        }
        
        // Toggle fee item active status
        function toggleFeeItemActive(feeId) {
            try {
                const index = appData.feeItems.findIndex(f => f.id === feeId);
                if (index !== -1) {
                    appData.feeItems[index].active = !appData.feeItems[index].active;
                    saveToLocalStorage();
                    loadFeeItems();
                    loadFeeSelection();
                    loadFeeRegisterTable(); // Update fee register
                    loadFeeReminders(); // Update reminders
                    showSuccess(`Fee item ${appData.feeItems[index].active ? 'enabled' : 'disabled'} successfully`);
                }
            } catch (error) {
                console.error('Error toggling fee item:', error);
                showError('Failed to toggle fee item status');
            }
        }
        
        // Toggle fee item required status
        function toggleFeeItemRequired(feeId) {
            try {
                const index = appData.feeItems.findIndex(f => f.id === feeId);
                if (index !== -1) {
                    appData.feeItems[index].isRequired = !appData.feeItems[index].isRequired;
                    saveToLocalStorage();
                    loadFeeItems();
                    loadFeeSelection();
                    loadFeeRegisterTable(); // Update fee register
                    loadFeeReminders(); // Update reminders
                    showSuccess(`Fee item marked as ${appData.feeItems[index].isRequired ? 'required' : 'optional'} successfully`);
                }
            } catch (error) {
                console.error('Error toggling fee item required status:', error);
                showError('Failed to toggle fee item required status');
            }
        }
        
        // Delete fee item
        function deleteFeeItem(feeId) {
            try {
                const index = appData.feeItems.findIndex(f => f.id === feeId);
                if (index !== -1) {
                    // Check if fee item is used by any student
                    const isUsed = appData.students.some(student => 
                        student.feeItems && student.feeItems.includes(feeId)
                    );
                    
                    if (isUsed) {
                        showError('Cannot delete fee item that is assigned to students');
                        return;
                    }
                    
                    showConfirmation(
                        'Delete Fee Item',
                        'Are you sure you want to delete this fee item? This action cannot be undone.',
                        () => {
                            appData.feeItems.splice(index, 1);
                            saveToLocalStorage();
                            loadFeeItems();
                            loadFeeSelection();
                            loadFeeRegisterTable(); // Update fee register
                            loadFeeReminders(); // Update reminders
                            showSuccess('Fee item deleted successfully');
                        }
                    );
                } else {
                    showError('Fee item not found');
                }
            } catch (error) {
                console.error('Error deleting fee item:', error);
                showError('Failed to delete fee item');
            }
        }
        
        // Clear fee form
        function clearFeeForm() {
            document.getElementById('fee-item-form').reset();
            document.getElementById('fee-item-id').value = '';
            document.getElementById('fee-item-active').checked = true;
            document.getElementById('fee-item-term').value = 'all';
            document.getElementById('fee-item-form-container').classList.remove('active');
            showInfo('Fee form cleared');
            
            // Show button notification for clear button
            const button = document.getElementById('clear-fee-form');
            showButtonNotification(button, true);
        }
        
        // ============================================
        // DATA MANAGEMENT FUNCTIONS
        // ============================================
        
        // Export data to CSV
        function exportDataToCSV() {
            try {
                const data = {
                    students: appData.students,
                    feePayments: appData.feePayments,
                    feeItems: appData.feeItems,
                    settings: appData.settings
                };
                
                const csvContent = "data:text/csv;charset=utf-8," + 
                    encodeURIComponent(JSON.stringify(data, null, 2));
                
                const link = document.createElement("a");
                link.setAttribute("href", csvContent);
                link.setAttribute("download", `edutrack-backup-${new Date().toISOString().split('T')[0]}.json`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showSuccess('Data exported successfully');
                
                // Show button notification
                const button = document.getElementById('export-data');
                showButtonNotification(button, true);
            } catch (error) {
                console.error('Error exporting data:', error);
                showError('Failed to export data');
                const button = document.getElementById('export-data');
                showButtonNotification(button, false);
            }
        }
        
        // Import data from CSV/JSON
        function importDataFromFile(file) {
            try {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        
                        // Validate imported data structure
                        if (!importedData.students || !importedData.feePayments || !importedData.feeItems) {
                            showError('Invalid data format');
                            return;
                        }
                        
                        showConfirmation(
                            'Import Data',
                            'This will replace all current data. Are you sure?',
                            () => {
                                appData = importedData;
                                saveToLocalStorage();
                                initializeUI();
                                showSuccess('Data imported successfully');
                                
                                // Show button notification
                                const button = document.getElementById('import-data');
                                showButtonNotification(button, true);
                            }
                        );
                    } catch (error) {
                        showError('Failed to parse imported file');
                        const button = document.getElementById('import-data');
                        showButtonNotification(button, false);
                    }
                };
                reader.readAsText(file);
            } catch (error) {
                console.error('Error importing data:', error);
                showError('Failed to import data');
                const button = document.getElementById('import-data');
                showButtonNotification(button, false);
            }
        }
        
        // Clear all data
        function clearAllData() {
            showConfirmation(
                'Clear All Data',
                'This will permanently delete ALL data. This action cannot be undone. Are you sure?',
                () => {
                    appData = {
                        students: [],
                        feePayments: [],
                        feeItems: DEFAULT_FEE_ITEMS,
                        settings: {
                            schoolName: 'Edu-Track Junior Academy',
                            schoolAddress: 'P.O. Box 12345, Nairobi, Kenya',
                            schoolPhone: '+254 712 345 678',
                            schoolEmail: 'info@edutrack.ac.ke',
                            schoolLogo: '',
                            cloudSettings: {
                                googleSheetId: '',
                                webAppUrl: ''
                            }
                        },
                        lastBackup: null,
                        lastSync: null
                    };
                    
                    localStorage.removeItem(APP_CONFIG.STORAGE_PREFIX + 'appData');
                    saveToLocalStorage();
                    initializeUI();
                    showSuccess('All data cleared successfully');
                    
                    // Show button notification
                    const button = document.getElementById('clear-data');
                    showButtonNotification(button, true);
                }
            );
        }
        
        // ============================================
        // HELPER FUNCTIONS
        // ============================================
        
        // Populate student dropdowns
        function populateStudentDropdowns() {
            try {
                const paymentStudentSelect = document.getElementById('payment-student');
                const feeStudentFilter = document.getElementById('fee-student-filter');
                const feeTypeSelect = document.getElementById('payment-fee-type');
                
                // Clear existing options
                paymentStudentSelect.innerHTML = '<option value="">Select Student</option>';
                feeStudentFilter.innerHTML = '<option value="all">All Students</option>';
                feeTypeSelect.innerHTML = '<option value="">Select Fee Type</option>';
                
                // Add students
                appData.students.forEach(student => {
                    const option1 = document.createElement('option');
                    option1.value = student.id;
                    option1.textContent = `${student.firstName} ${student.lastName} (${student.class.toUpperCase()})`;
                    paymentStudentSelect.appendChild(option1);
                    
                    const option2 = option1.cloneNode(true);
                    option2.value = student.id;
                    feeStudentFilter.appendChild(option2);
                });
                
                // Add fee types
                getActiveFeeItems().forEach(feeItem => {
                    const option = document.createElement('option');
                    option.value = feeItem.id;
                    option.textContent = feeItem.name;
                    feeTypeSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error populating dropdowns:', error);
            }
        }
        
        // Populate reminder dropdowns
        function populateReminderDropdowns() {
            try {
                const reminderStudentFilter = document.getElementById('reminder-student-filter');
                
                // Clear existing options
                reminderStudentFilter.innerHTML = '<option value="all">All Students</option>';
                
                // Add students
                appData.students.forEach(student => {
                    const option = document.createElement('option');
                    option.value = student.id;
                    option.textContent = `${student.firstName} ${student.lastName} (${student.class.toUpperCase()})`;
                    reminderStudentFilter.appendChild(option);
                });
            } catch (error) {
                console.error('Error populating reminder dropdowns:', error);
            }
        }
        
        // Add student action listeners
        function addStudentActionListeners() {
            // View student
            document.querySelectorAll('.view-student').forEach(button => {
                button.addEventListener('click', function() {
                    try {
                        const studentId = this.getAttribute('data-id');
                        const student = appData.students.find(s => s.id === studentId);
                        if (student) {
                            const totalFees = calculateTotalFees(student);
                            const totalPaid = calculateTotalPaid(student.id);
                            const balance = totalFees - totalPaid;
                            
                            // Calculate fee details
                            let feeDetails = '\nFee Details:\n';
                            student.feeItems.forEach(feeItemId => {
                                const feeItem = appData.feeItems.find(f => f.id === feeItemId);
                                if (feeItem) {
                                    const paidAmount = calculatePaidForFeeItem(student.id, feeItemId);
                                    const feeBalance = feeItem.amount - paidAmount;
                                    const dueDate = calculateDueDate(student, feeItemId);
                                    
                                    feeDetails += `\n${feeItem.name}:\n`;
                                    feeDetails += `  Amount: ${formatCurrency(feeItem.amount)}\n`;
                                    feeDetails += `  Paid: ${formatCurrency(paidAmount)}\n`;
                                    feeDetails += `  Balance: ${formatCurrency(feeBalance)}\n`;
                                    feeDetails += `  Due Date: ${dueDate ? formatDate(dueDate) : 'N/A'}\n`;
                                    if (dueDate && isFeeOverdue(dueDate)) {
                                        feeDetails += `  STATUS: OVERDUE!\n`;
                                    } else if (dueDate && isFeeDueSoon(dueDate)) {
                                        feeDetails += `  STATUS: Due Soon\n`;
                                    }
                                }
                            });
                            
                            alert(`Student Details:\n\n` +
                                  `Name: ${student.firstName} ${student.lastName}\n` +
                                  `ID: ${student.id}\n` +
                                  `Class: ${student.class.toUpperCase()}\n` +
                                  `Date of Birth: ${formatDate(student.dob) || 'Not specified'}\n\n` +
                                  `Parent: ${student.parentName}\n` +
                                  `Phone: ${student.parentPhone}\n` +
                                  `Email: ${student.parentEmail || 'N/A'}\n` +
                                  `Address: ${student.parentAddress || 'N/A'}\n\n` +
                                  `Total Fees: ${formatCurrency(totalFees)}\n` +
                                  `Total Paid: ${formatCurrency(totalPaid)}\n` +
                                  `Balance: ${formatCurrency(balance)}\n` +
                                  feeDetails);
                        } else {
                            showError('Student not found');
                        }
                    } catch (error) {
                        console.error('Error viewing student:', error);
                        showError('Failed to view student details');
                    }
                });
            });
            
            // Edit student
            document.querySelectorAll('.edit-student').forEach(button => {
                button.addEventListener('click', function() {
                    try {
                        const studentId = this.getAttribute('data-id');
                        openStudentModal(studentId);
                    } catch (error) {
                        console.error('Error opening student modal:', error);
                        showError('Failed to open student editor');
                    }
                });
            });
            
            // Add payment for student
            document.querySelectorAll('.add-payment').forEach(button => {
                button.addEventListener('click', function() {
                    try {
                        const studentId = this.getAttribute('data-id');
                        openFeeModal(studentId);
                    } catch (error) {
                        console.error('Error opening fee modal:', error);
                        showError('Failed to open payment form');
                    }
                });
            });
            
            // Delete student
            document.querySelectorAll('.delete-student').forEach(button => {
                button.addEventListener('click', function() {
                    try {
                        const studentId = this.getAttribute('data-id');
                        showConfirmation(
                            'Delete Student',
                            'Are you sure you want to delete this student? This action cannot be undone.',
                            () => {
                                if (deleteStudent(studentId)) {
                                    showSuccess('Student deleted successfully');
                                }
                            }
                        );
                    } catch (error) {
                        console.error('Error deleting student:', error);
                        showError('Failed to delete student');
                    }
                });
            });
        }
        
        // Add fee register action listeners
        function addFeeRegisterActionListeners() {
            // View receipts
            document.querySelectorAll('.view-receipts').forEach(button => {
                button.addEventListener('click', function() {
                    try {
                        const studentId = this.getAttribute('data-id');
                        const student = appData.students.find(s => s.id === studentId);
                        const payments = appData.feePayments.filter(p => p.studentId === studentId);
                        
                        if (payments.length === 0) {
                            showInfo(`No payments found for ${student.firstName} ${student.lastName}`);
                            return;
                        }
                        
                        let message = `Payment History for ${student.firstName} ${student.lastName}:\n\n`;
                        payments.forEach((payment, index) => {
                            const feeItem = appData.feeItems.find(f => f.id === payment.feeItemId);
                            message += `${index + 1}. Receipt: ${payment.receiptNo}\n`;
                            message += `   Fee: ${feeItem ? feeItem.name : 'Unknown'}\n`;
                            message += `   Amount: ${formatCurrency(payment.amount)}\n`;
                            message += `   Date: ${formatDate(payment.date)}\n`;
                            message += `   Method: ${payment.paymentMethod}\n`;
                            if (payment.reference) message += `   Reference: ${payment.reference}\n`;
                            message += '\n';
                        });
                        
                        alert(message);
                    } catch (error) {
                        console.error('Error viewing receipts:', error);
                        showError('Failed to load payment history');
                    }
                });
            });
            
            // Add payment for specific student
            document.querySelectorAll('.add-student-payment').forEach(button => {
                button.addEventListener('click', function() {
                    try {
                        const studentId = this.getAttribute('data-id');
                        openFeeModal(studentId);
                    } catch (error) {
                        console.error('Error opening fee modal:', error);
                        showError('Failed to open payment form');
                    }
                });
            });
        }
        
        // Add reminder action listeners
        function addReminderActionListeners() {
            // Send email
            document.querySelectorAll('.send-email').forEach(button => {
                button.addEventListener('click', function() {
                    const studentId = this.getAttribute('data-id');
                    const student = appData.students.find(s => s.id === studentId);
                    if (student && student.parentEmail) {
                        const totalFees = calculateTotalFees(student);
                        const totalPaid = calculateTotalPaid(student.id);
                        const balance = totalFees - totalPaid;
                        
                        const subject = `Fee Reminder for ${student.firstName} ${student.lastName}`;
                        const body = `Dear ${student.parentName},\n\n` +
                                    `This is a reminder that your child ${student.firstName} ${student.lastName} ` +
                                    `has an outstanding fee balance of ${formatCurrency(balance)}.\n\n` +
                                    `Total Fees: ${formatCurrency(totalFees)}\n` +
                                    `Total Paid: ${formatCurrency(totalPaid)}\n` +
                                    `Balance Due: ${formatCurrency(balance)}\n\n` +
                                    `Please clear the balance at your earliest convenience.\n\n` +
                                    `Thank you.\n\n` +
                                    `${appData.settings.schoolName}\n` +
                                    `${appData.settings.schoolAddress}\n` +
                                    `Tel: ${appData.settings.schoolPhone}`;
                        
                        // In a real app, you would send the email here
                        // For demo purposes, we'll show a message
                        showInfo(`Email would be sent to: ${student.parentEmail}\n\nSubject: ${subject}\n\nBody:\n${body}`);
                    } else {
                        showError('No email address found for this parent');
                    }
                });
            });
            
            // Print individual reminder
            document.querySelectorAll('.print-reminder').forEach(button => {
                button.addEventListener('click', function() {
                    const studentId = this.getAttribute('data-id');
                    printIndividualReminder(studentId);
                });
            });
        }
        
        // Add fee item action listeners - FIXED
        function addFeeItemActionListeners() {
            // Edit fee item
            document.querySelectorAll('.edit-fee-item').forEach(button => {
                button.addEventListener('click', function() {
                    try {
                        const feeId = this.getAttribute('data-id');
                        editFeeItem(feeId);
                    } catch (error) {
                        console.error('Error editing fee item:', error);
                        showError('Failed to edit fee item');
                    }
                });
            });
            
            // Toggle fee item active status
            document.querySelectorAll('.toggle-fee-active').forEach(button => {
                button.addEventListener('click', function() {
                    try {
                        const feeId = this.getAttribute('data-id');
                        toggleFeeItemActive(feeId);
                    } catch (error) {
                        console.error('Error toggling fee item:', error);
                        showError('Failed to toggle fee item status');
                    }
                });
            });
            
            // Toggle fee item required status
            document.querySelectorAll('.toggle-fee-required').forEach(button => {
                button.addEventListener('click', function() {
                    try {
                        const feeId = this.getAttribute('data-id');
                        toggleFeeItemRequired(feeId);
                    } catch (error) {
                        console.error('Error toggling fee item required status:', error);
                        showError('Failed to toggle fee item required status');
                    }
                });
            });
            
            // Delete fee item
            document.querySelectorAll('.delete-fee-item').forEach(button => {
                button.addEventListener('click', function() {
                    try {
                        const feeId = this.getAttribute('data-id');
                        deleteFeeItem(feeId);
                    } catch (error) {
                        console.error('Error deleting fee item:', error);
                        showError('Failed to delete fee item');
                    }
                });
            });
        }
        
        // Show confirmation dialog
        function showConfirmation(title, message, onConfirm) {
            try {
                document.getElementById('confirm-title').textContent = title;
                document.getElementById('confirm-message').textContent = message;
                
                const modal = document.getElementById('confirm-modal');
                const cancelBtn = document.getElementById('confirm-cancel');
                const okBtn = document.getElementById('confirm-ok');
                
                modal.classList.add('active');
                
                const closeModal = function() {
                    modal.classList.remove('active');
                    cancelBtn.removeEventListener('click', closeModal);
                    okBtn.removeEventListener('click', confirmAction);
                    modal.querySelector('.close-modal').removeEventListener('click', closeModal);
                };
                
                const confirmAction = function() {
                    try {
                        onConfirm();
                    } catch (error) {
                        console.error('Error in confirmation action:', error);
                        showError('Action failed');
                    }
                    closeModal();
                };
                
                cancelBtn.addEventListener('click', closeModal);
                okBtn.addEventListener('click', confirmAction);
                modal.querySelector('.close-modal').addEventListener('click', closeModal);
            } catch (error) {
                console.error('Error showing confirmation:', error);
                showError('Failed to show confirmation dialog');
            }
        }
        
        // Open student modal
        function openStudentModal(studentId = null) {
            try {
                const modal = document.getElementById('student-modal');
                const title = document.getElementById('student-modal-title');
                const form = document.getElementById('student-form');
                
                if (studentId) {
                    // Edit mode
                    const student = appData.students.find(s => s.id === studentId);
                    if (!student) {
                        showError('Student not found');
                        return;
                    }
                    
                    title.textContent = 'Edit Student';
                    document.getElementById('student-id').value = student.id;
                    document.getElementById('first-name').value = student.firstName;
                    document.getElementById('last-name').value = student.lastName;
                    document.getElementById('student-class').value = student.class;
                    document.getElementById('student-dob').value = student.dob || '';
                    document.getElementById('parent-name').value = student.parentName;
                    document.getElementById('parent-phone').value = student.parentPhone;
                    document.getElementById('parent-email').value = student.parentEmail || '';
                    document.getElementById('parent-address').value = student.parentAddress || '';
                    
                    // Load fee selection with student's selected items
                    loadFeeSelection();
                    
                    // Check student's selected fee items
                    setTimeout(() => {
                        if (student.feeItems) {
                            student.feeItems.forEach(feeItemId => {
                                const checkbox = document.getElementById(`fee-${feeItemId}`);
                                if (checkbox) {
                                    checkbox.checked = true;
                                }
                            });
                        }
                    }, 100);
                } else {
                    // Add mode
                    title.textContent = 'Add New Student';
                    form.reset();
                    document.getElementById('student-id').value = '';
                    document.getElementById('student-dob').value = getCurrentDate();
                    
                    // Load fee selection with required items checked
                    loadFeeSelection();
                }
                
                modal.classList.add('active');
            } catch (error) {
                console.error('Error opening student modal:', error);
                showError('Failed to open student form');
            }
        }
        
        // Open fee modal
        function openFeeModal(studentId = null) {
            try {
                const modal = document.getElementById('fee-modal');
                const title = document.getElementById('fee-modal-title');
                
                if (studentId) {
                    // Pre-select student
                    document.getElementById('payment-student-id').value = studentId;
                    document.getElementById('payment-student').value = studentId;
                } else {
                    document.getElementById('payment-student-id').value = '';
                }
                
                // Set default date
                document.getElementById('payment-date').value = getCurrentDate();
                
                // Clear form
                document.getElementById('fee-form').reset();
                document.getElementById('payment-id').value = '';
                
                // Restore student selection if provided
                if (studentId) {
                    document.getElementById('payment-student').value = studentId;
                }
                
                // Restore date
                document.getElementById('payment-date').value = getCurrentDate();
                
                modal.classList.add('active');
            } catch (error) {
                console.error('Error opening fee modal:', error);
                showError('Failed to open payment form');
            }
        }
        
        // Initialize the application
        function initializeUI() {
            try {
                // Update current date
                const now = new Date();
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                document.getElementById('current-date').textContent = now.toLocaleDateString('en-US', options);
                document.getElementById('print-date').textContent = now.toLocaleDateString('en-GB');
                document.getElementById('print-current-date').textContent = now.toLocaleDateString('en-US', options);
                
                // Update print header with school info
                document.getElementById('print-school-name').textContent = appData.settings.schoolName;
                document.getElementById('print-school-address').textContent = appData.settings.schoolAddress;
                document.getElementById('print-school-contact').textContent = 
                    `Tel: ${appData.settings.schoolPhone} | Email: ${appData.settings.schoolEmail}`;
                
                // Update logo in print header
                const printLogo = document.getElementById('print-logo');
                if (appData.settings.schoolLogo) {
                    printLogo.src = appData.settings.schoolLogo;
                    printLogo.style.display = 'block';
                } else {
                    printLogo.style.display = 'none';
                }
                
                // Update logo preview
                const logoPreview = document.getElementById('logo-preview');
                if (appData.settings.schoolLogo) {
                    logoPreview.innerHTML = `<img src="${appData.settings.schoolLogo}" class="school-logo-display" alt="School Logo">`;
                }
                
                // Update app settings form
                document.getElementById('school-name').value = appData.settings.schoolName;
                document.getElementById('school-address').value = appData.settings.schoolAddress;
                document.getElementById('school-phone').value = appData.settings.schoolPhone;
                document.getElementById('school-email').value = appData.settings.schoolEmail;
                document.getElementById('school-logo').value = appData.settings.schoolLogo || '';
                document.getElementById('google-sheet-id').value = appData.settings.cloudSettings.googleSheetId || '';
                document.getElementById('web-app-url').value = appData.settings.cloudSettings.webAppUrl || '';
                
                // Hide fee form initially
                document.getElementById('fee-item-form-container').classList.remove('active');
                
                // Update all sections
                updateDashboardStats();
                loadStudentsTable();
                loadFeeRegisterTable();
                loadFeeItems(); // This now properly loads fee items
                populateStudentDropdowns();
                populateReminderDropdowns();
                loadFeeReminders();
                updateStorageInfo();
                updateSyncStatus();
                
                showSuccess('Application loaded successfully');
            } catch (error) {
                console.error('Error initializing UI:', error);
                showError('Failed to initialize application');
            }
        }
        
        // ============================================
        // EVENT LISTENERS INITIALIZATION
        // ============================================
        
        function initializeEventListeners() {
            // Login form
            loginForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                try {
                    const username = document.getElementById('username').value;
                    const password = document.getElementById('password').value;
                    
                    if (username === ADMIN_CREDENTIALS.username && password === ADMIN_CREDENTIALS.password) {
                        // Hide login, show app
                        loginScreen.style.display = 'none';
                        appContainer.classList.remove('hidden');
                        
                        // Load data and initialize UI
                        loadFromLocalStorage();
                        initializeUI();
                        
                        showSuccess('Login successful! Welcome to Edu-Track CBE Pro');
                        
                        // Show button notification
                        const button = document.getElementById('login-submit-btn');
                        showButtonNotification(button, true);
                    } else {
                        showError('Invalid username or password');
                        const button = document.getElementById('login-submit-btn');
                        showButtonNotification(button, false);
                    }
                } catch (error) {
                    console.error('Error during login:', error);
                    showError('Login failed. Please try again.');
                    const button = document.getElementById('login-submit-btn');
                    showButtonNotification(button, false);
                }
            });
            
            // Mobile menu toggle
            mobileMenuToggle.addEventListener('click', function() {
                sidebar.classList.toggle('active');
                showButtonNotification(this, true);
            });
            
            // Menu navigation
            menuItems.forEach(item => {
                item.addEventListener('click', function() {
                    // Remove active class from all menu items
                    menuItems.forEach(menuItem => menuItem.classList.remove('active'));
                    // Add active class to clicked menu item
                    this.classList.add('active');
                    
                    // Get target content area
                    const target = this.getAttribute('data-target');
                    
                    // Hide all content areas
                    contentAreas.forEach(area => area.classList.remove('active'));
                    
                    // Show target content area
                    document.getElementById(target).classList.add('active');
                    
                    // Update page title
                    document.getElementById('page-title').textContent = 
                        this.querySelector('span').textContent + (target === 'dashboard' ? ' Overview' : '');
                    
                    // Close mobile menu if open
                    sidebar.classList.remove('active');
                    
                    // Load specific content if needed
                    if (target === 'fee-reminders') {
                        loadFeeReminders();
                    } else if (target === 'fee-setting') {
                        // Ensure fee items are loaded when navigating to fee setting
                        setTimeout(() => {
                            loadFeeItems();
                        }, 100);
                    }
                    
                    // Show notification for menu click
                    showButtonNotification(this, true);
                });
            });
            
            // Close modals
            document.querySelectorAll('.close-modal').forEach(button => {
                button.addEventListener('click', function() {
                    this.closest('.modal').classList.remove('active');
                    showButtonNotification(this, true);
                });
            });
            
            // Add student button
            document.getElementById('add-student-btn').addEventListener('click', () => {
                openStudentModal();
                showButtonNotification(document.getElementById('add-student-btn'), true);
            });
            
            // Student form submission
            document.getElementById('student-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                try {
                    const studentId = document.getElementById('student-id').value;
                    
                    const studentData = {
                        firstName: document.getElementById('first-name').value.trim(),
                        lastName: document.getElementById('last-name').value.trim(),
                        class: document.getElementById('student-class').value,
                        dob: document.getElementById('student-dob').value,
                        parentName: document.getElementById('parent-name').value.trim(),
                        parentPhone: document.getElementById('parent-phone').value.trim(),
                        parentEmail: document.getElementById('parent-email').value.trim(),
                        parentAddress: document.getElementById('parent-address').value.trim()
                    };
                    
                    // Validate required fields
                    if (!studentData.firstName || !studentData.lastName || !studentData.class || !studentData.parentName || !studentData.parentPhone) {
                        showError('Please fill all required fields');
                        return;
                    }
                    
                    let success = false;
                    if (studentId) {
                        success = editStudent(studentId, studentData);
                    } else {
                        const newId = addStudent(studentData);
                        success = newId !== null;
                    }
                    
                    if (success) {
                        // Close modal on success
                        document.getElementById('student-modal').classList.remove('active');
                        
                        // Show button notification
                        const button = document.getElementById('save-student-btn');
                        showButtonNotification(button, true);
                    } else {
                        const button = document.getElementById('save-student-btn');
                        showButtonNotification(button, false);
                    }
                } catch (error) {
                    console.error('Error saving student:', error);
                    showError('Failed to save student');
                    const button = document.getElementById('save-student-btn');
                    showButtonNotification(button, false);
                }
            });
            
            // Add fee transaction button
            document.getElementById('add-fee-transaction').addEventListener('click', () => {
                openFeeModal();
                showButtonNotification(document.getElementById('add-fee-transaction'), true);
            });
            
            // Fee form submission
            document.getElementById('fee-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                try {
                    const paymentData = {
                        studentId: document.getElementById('payment-student').value,
                        date: document.getElementById('payment-date').value,
                        amount: document.getElementById('payment-amount').value,
                        paymentMethod: document.getElementById('payment-method').value,
                        feeItemId: document.getElementById('payment-fee-type').value,
                        reference: document.getElementById('payment-reference').value,
                        notes: document.getElementById('payment-notes').value
                    };
                    
                    // Validate required fields
                    if (!paymentData.studentId || !paymentData.date || !paymentData.amount || 
                        !paymentData.paymentMethod || !paymentData.feeItemId) {
                        showError('Please fill all required fields');
                        return;
                    }
                    
                    const amount = parseFloat(paymentData.amount);
                    if (isNaN(amount) || amount <= 0) {
                        showError('Please enter a valid amount');
                        return;
                    }
                    
                    const paymentId = addFeePayment(paymentData);
                    if (paymentId) {
                        // Close modal on success
                        document.getElementById('fee-modal').classList.remove('active');
                        
                        // Show button notification
                        const button = document.getElementById('save-payment-btn');
                        showButtonNotification(button, true);
                    } else {
                        const button = document.getElementById('save-payment-btn');
                        showButtonNotification(button, false);
                    }
                } catch (error) {
                    console.error('Error saving payment:', error);
                    showError('Failed to record payment');
                    const button = document.getElementById('save-payment-btn');
                    showButtonNotification(button, false);
                }
            });
            
            // Apply student filter
            document.getElementById('apply-student-filter').addEventListener('click', () => {
                const filterClass = document.getElementById('student-class-filter').value;
                const searchTerm = document.getElementById('student-search').value;
                loadStudentsTable(filterClass, searchTerm);
                showInfo('Filter applied successfully');
                
                // Show button notification
                const button = document.getElementById('apply-student-filter');
                showButtonNotification(button, true);
            });
            
            // Apply fee filter
            document.getElementById('apply-fee-filter').addEventListener('click', () => {
                const filterClass = document.getElementById('fee-class-filter').value;
                const filterStudent = document.getElementById('fee-student-filter').value;
                loadFeeRegisterTable(filterClass, filterStudent);
                showInfo('Filter applied successfully');
                
                // Show button notification
                const button = document.getElementById('apply-fee-filter');
                showButtonNotification(button, true);
            });
            
            // Apply reminder filter
            document.getElementById('apply-reminder-filter').addEventListener('click', () => {
                const filterClass = document.getElementById('reminder-class-filter').value;
                const filterStudent = document.getElementById('reminder-student-filter').value;
                const filterStatus = document.getElementById('reminder-status-filter').value;
                loadFeeReminders(filterClass, filterStudent, filterStatus);
                showInfo('Filter applied successfully');
                
                // Show button notification
                const button = document.getElementById('apply-reminder-filter');
                showButtonNotification(button, true);
            });
            
            // Print all reminders
            document.getElementById('print-all-reminders').addEventListener('click', () => {
                printReminders('all');
            });
            
            // Print overdue reminders
            document.getElementById('print-overdue-reminders').addEventListener('click', () => {
                printReminders('overdue');
            });
            
            // Add new fee item button
            document.getElementById('add-new-fee-item').addEventListener('click', () => {
                document.getElementById('fee-item-form-container').classList.toggle('active');
                if (document.getElementById('fee-item-form-container').classList.contains('active')) {
                    clearFeeForm();
                    showInfo('Add new fee item form opened');
                } else {
                    showInfo('Fee item form hidden');
                }
                
                // Show button notification
                const button = document.getElementById('add-new-fee-item');
                showButtonNotification(button, true);
            });
            
            // Fee item form submission
            document.getElementById('fee-item-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                try {
                    const feeData = {
                        name: document.getElementById('fee-item-name').value.trim(),
                        amount: document.getElementById('fee-item-amount').value,
                        category: document.getElementById('fee-item-category').value,
                        description: document.getElementById('fee-item-description').value.trim(),
                        dueDays: document.getElementById('fee-item-due-days').value,
                        term: document.getElementById('fee-item-term').value,
                        isRequired: document.getElementById('fee-item-required').checked,
                        active: document.getElementById('fee-item-active').checked
                    };
                    
                    if (!feeData.name || !feeData.amount) {
                        showError('Please fill all required fields');
                        return;
                    }
                    
                    saveFeeItem(feeData);
                } catch (error) {
                    console.error('Error saving fee item:', error);
                    showError('Failed to save fee item');
                }
            });
            
            // Clear fee form
            document.getElementById('clear-fee-form').addEventListener('click', () => {
                clearFeeForm();
            });
            
            // Save fee settings
            document.getElementById('save-fee-settings').addEventListener('click', () => {
                saveToLocalStorage();
                showSuccess('Fee settings saved successfully');
                
                // Show button notification
                const button = document.getElementById('save-fee-settings');
                showButtonNotification(button, true);
            });
            
            // Save app settings
            document.getElementById('save-app-settings').addEventListener('click', () => {
                try {
                    appData.settings.schoolName = document.getElementById('school-name').value;
                    appData.settings.schoolAddress = document.getElementById('school-address').value;
                    appData.settings.schoolPhone = document.getElementById('school-phone').value;
                    appData.settings.schoolEmail = document.getElementById('school-email').value;
                    appData.settings.schoolLogo = document.getElementById('school-logo').value;
                    
                    saveToLocalStorage();
                    
                    // Update logo preview
                    const logoPreview = document.getElementById('logo-preview');
                    if (appData.settings.schoolLogo) {
                        logoPreview.innerHTML = `<img src="${appData.settings.schoolLogo}" class="school-logo-display" alt="School Logo">`;
                    } else {
                        logoPreview.innerHTML = `<i class="fas fa-school" style="font-size: 3rem; color: #ccc;"></i>`;
                    }
                    
                    // Update print header
                    document.getElementById('print-school-name').textContent = appData.settings.schoolName;
                    document.getElementById('print-school-address').textContent = appData.settings.schoolAddress;
                    document.getElementById('print-school-contact').textContent = 
                        `Tel: ${appData.settings.schoolPhone} | Email: ${appData.settings.schoolEmail}`;
                    
                    const printLogo = document.getElementById('print-logo');
                    if (appData.settings.schoolLogo) {
                        printLogo.src = appData.settings.schoolLogo;
                        printLogo.style.display = 'block';
                    } else {
                        printLogo.style.display = 'none';
                    }
                    
                    showSuccess('Application settings saved successfully');
                    
                    // Show button notification
                    const button = document.getElementById('save-app-settings');
                    showButtonNotification(button, true);
                } catch (error) {
                    console.error('Error saving app settings:', error);
                    showError('Failed to save application settings');
                    const button = document.getElementById('save-app-settings');
                    showButtonNotification(button, false);
                }
            });
            
            // Upload logo button
            document.getElementById('upload-logo-btn').addEventListener('click', () => {
                document.getElementById('logo-upload').click();
            });
            
            // Logo upload
            document.getElementById('logo-upload').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        appData.settings.schoolLogo = e.target.result;
                        document.getElementById('school-logo').value = e.target.result;
                        
                        // Update logo preview
                        const logoPreview = document.getElementById('logo-preview');
                        logoPreview.innerHTML = `<img src="${e.target.result}" class="school-logo-display" alt="School Logo">`;
                        
                        // Update print logo
                        const printLogo = document.getElementById('print-logo');
                        printLogo.src = e.target.result;
                        printLogo.style.display = 'block';
                        
                        showSuccess('Logo uploaded successfully');
                        
                        // Show button notification
                        const button = document.getElementById('upload-logo-btn');
                        showButtonNotification(button, true);
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            // Data management buttons
            document.getElementById('export-data').addEventListener('click', () => {
                exportDataToCSV();
            });
            
            document.getElementById('import-data').addEventListener('click', () => {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json,.csv';
                input.onchange = (e) => {
                    importDataFromFile(e.target.files[0]);
                };
                input.click();
            });
            
            document.getElementById('clear-data').addEventListener('click', () => {
                clearAllData();
            });
            
            // Print functions
            document.getElementById('print-dashboard').addEventListener('click', () => {
                window.print();
                showButtonNotification(document.getElementById('print-dashboard'), true);
            });
            
            document.getElementById('print-dashboard-table').addEventListener('click', () => {
                window.print();
                showButtonNotification(document.getElementById('print-dashboard-table'), true);
            });
            
            document.getElementById('print-student-register').addEventListener('click', () => {
                window.print();
                showButtonNotification(document.getElementById('print-student-register'), true);
            });
            
            document.getElementById('print-fee-register').addEventListener('click', () => {
                window.print();
                showButtonNotification(document.getElementById('print-fee-register'), true);
            });
            
            document.getElementById('print-receipt-btn').addEventListener('click', () => {
                window.print();
                showButtonNotification(document.getElementById('print-receipt-btn'), true);
            });
            
            // Close modals on escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    document.querySelectorAll('.modal.active').forEach(modal => {
                        modal.classList.remove('active');
                    });
                }
            });
            
            // Close modals on background click
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        this.classList.remove('active');
                    }
                });
            });
        }
        
        // ============================================
        // INITIALIZE APPLICATION
        // ============================================
        
        document.addEventListener('DOMContentLoaded', function() {
            try {
                initializeEventListeners();
                
                // Force login screen on load
                loginScreen.style.display = 'flex';
                appContainer.classList.add('hidden');
                
                // Clear any existing login state
                localStorage.removeItem(APP_CONFIG.STORAGE_PREFIX + 'loggedIn');
            } catch (error) {
                console.error('Error initializing application:', error);
                showError('Failed to initialize application');
            }
        });
    </script>
</body>
</html>