<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edu-Track CBE Pro | School Fees Management</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <style>
        :root {
            --primary-color: #1a5f7a;
            --secondary-color: #57cc99;
            --accent-color: #ff9a3c;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --danger-color: #dc3545;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --border-radius: 8px;
            --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            --sidebar-width: 250px;
            --header-height: 70px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            min-height: 100vh;
        }
        
        /* Login Screen */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            background: linear-gradient(135deg, var(--primary-color) 0%, #2c3e50 100%);
        }
        
        .login-box {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 40px;
            width: 100%;
            max-width: 400px;
            box-shadow: var(--box-shadow);
        }
        
        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .login-logo {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            color: white;
            font-size: 2.5rem;
        }
        
        .login-header h1 {
            color: var(--primary-color);
            margin-bottom: 5px;
        }
        
        .login-header p {
            color: #666;
            font-size: 0.9rem;
        }
        
        .login-form .form-group {
            margin-bottom: 20px;
        }
        
        .login-form label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }
        
        .login-form input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 1rem;
        }
        
        .login-form input:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        .login-btn {
            width: 100%;
            padding: 12px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .login-btn:hover {
            background-color: #15455c;
        }
        
        .btn-notification {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0;
            transition: all 0.3s ease;
        }
        
        .btn-success .btn-notification {
            color: white;
        }
        
        .btn-show-notification .btn-notification {
            opacity: 1;
            animation: bounceIn 0.5s ease;
        }
        
        .btn-success.btn-show-notification {
            background-color: var(--success-color);
        }
        
        .btn-danger.btn-show-notification {
            background-color: var(--danger-color);
        }
        
        @keyframes bounceIn {
            0% {
                transform: translateY(-50%) scale(0);
                opacity: 0;
            }
            50% {
                transform: translateY(-50%) scale(1.2);
            }
            100% {
                transform: translateY(-50%) scale(1);
                opacity: 1;
            }
        }
        
        /* Main Container */
        .container {
            display: flex;
            min-height: 100vh;
        }
        
        /* Sidebar Styles */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--primary-color);
            color: white;
            display: flex;
            flex-direction: column;
            box-shadow: var(--box-shadow);
            z-index: 100;
            transition: transform 0.3s ease;
        }
        
        .logo-area {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
            height: var(--header-height);
        }
        
        .logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .logo-img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            background-color: white;
            padding: 3px;
        }
        
        .logo-text h2 {
            font-size: 1.2rem;
            font-weight: 700;
        }
        
        .logo-text p {
            font-size: 0.7rem;
            opacity: 0.8;
        }
        
        .menu {
            flex: 1;
            padding: 20px 0;
            overflow-y: auto;
        }
        
        .menu-item {
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 4px solid transparent;
        }
        
        .menu-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .menu-item.active {
            background-color: rgba(255, 255, 255, 0.15);
            border-left: 4px solid var(--secondary-color);
        }
        
        .menu-item i {
            width: 20px;
            text-align: center;
        }
        
        .user-area {
            padding: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--secondary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .mobile-menu-toggle {
            display: none;
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 1001;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            width: 45px;
            height: 45px;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            cursor: pointer;
        }
        
        /* Main Content Styles */
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eaeaea;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .header h1 {
            color: var(--primary-color);
            font-size: 1.5rem;
        }
        
        .date-display {
            font-weight: 600;
            color: #666;
        }
        
        /* Alarm Badge */
        .alarm-badge {
            position: relative;
            margin-left: 10px;
        }
        
        .alarm-count {
            position: absolute;
            top: -8px;
            right: -8px;
            background-color: var(--danger-color);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        /* Stats Container */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--box-shadow);
            display: flex;
            align-items: center;
            gap: 15px;
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        
        .stat-1 .stat-icon {
            background-color: rgba(87, 204, 153, 0.2);
            color: var(--success-color);
        }
        
        .stat-2 .stat-icon {
            background-color: rgba(255, 154, 60, 0.2);
            color: var(--accent-color);
        }
        
        .stat-3 .stat-icon {
            background-color: rgba(26, 95, 122, 0.2);
            color: var(--primary-color);
        }
        
        .stat-4 .stat-icon {
            background-color: rgba(220, 53, 69, 0.2);
            color: var(--danger-color);
        }
        
        .stat-info h3 {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }
        
        .stat-info p {
            color: #666;
            font-size: 0.9rem;
        }
        
        /* Content Area Styles */
        .content-area {
            display: none;
        }
        
        .content-area.active {
            display: block;
        }
        
        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
            min-width: 150px;
            flex: 1;
        }
        
        .filter-group label {
            font-size: 0.85rem;
            font-weight: 600;
            color: #555;
        }
        
        select, input, button, textarea {
            padding: 10px 15px;
            border-radius: var(--border-radius);
            border: 1px solid #ddd;
            font-size: 0.9rem;
        }
        
        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-weight: 600;
            white-space: nowrap;
            position: relative;
            overflow: hidden;
        }
        
        button:hover {
            background-color: #15455c;
        }
        
        .btn-success {
            background-color: var(--success-color);
        }
        
        .btn-success:hover {
            background-color: #218838;
        }
        
        .btn-danger {
            background-color: var(--danger-color);
        }
        
        .btn-danger:hover {
            background-color: #c82333;
        }
        
        .btn-warning {
            background-color: var(--warning-color);
            color: #212529;
        }
        
        .btn-warning:hover {
            background-color: #e0a800;
        }
        
        .btn-info {
            background-color: var(--info-color);
        }
        
        .btn-info:hover {
            background-color: #138496;
        }
        
        .btn-secondary {
            background-color: #6c757d;
        }
        
        .btn-secondary:hover {
            background-color: #5a6268;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 0.8rem;
        }
        
        .btn-icon {
            padding: 8px 12px;
            font-size: 0.9rem;
        }
        
        /* Table Styles */
        .table-container {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            overflow: hidden;
            margin-bottom: 20px;
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }
        
        thead {
            background-color: var(--primary-color);
            color: white;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        .actions {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        
        .badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .badge-success {
            background-color: rgba(40, 167, 69, 0.2);
            color: var(--success-color);
        }
        
        .badge-warning {
            background-color: rgba(255, 193, 7, 0.2);
            color: #e0a800;
        }
        
        .badge-danger {
            background-color: rgba(220, 53, 69, 0.2);
            color: var(--danger-color);
        }
        
        .badge-info {
            background-color: rgba(23, 162, 184, 0.2);
            color: var(--info-color);
        }
        
        .badge-primary {
            background-color: rgba(26, 95, 122, 0.2);
            color: var(--primary-color);
        }
        
        .table-footer {
            padding: 15px;
            background-color: #f8f9fa;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid #eee;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .total-amount {
            font-weight: 700;
            color: var(--primary-color);
            font-size: 1.1rem;
        }
        
        /* Form Styles */
        .form-container {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 25px;
            margin: 0 auto;
        }
        
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .form-group {
            flex: 1;
            min-width: 200px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .form-group label {
            font-weight: 600;
            color: #555;
            font-size: 0.9rem;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 0.9rem;
        }
        
        /* Fee Items Cards */
        .fee-items-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .fee-item-card {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--box-shadow);
            border-left: 4px solid var(--primary-color);
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .fee-item-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
        }
        
        .fee-item-card.required {
            border-left-color: var(--danger-color);
        }
        
        .fee-item-card.inactive {
            opacity: 0.8;
            border-left-color: #ccc;
        }
        
        .fee-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }
        
        .fee-item-name {
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--primary-color);
        }
        
        .fee-item-card.required .fee-item-name {
            color: var(--danger-color);
        }
        
        .fee-item-card.inactive .fee-item-name {
            color: #666;
        }
        
        .fee-item-amount {
            font-weight: 700;
            font-size: 1.2rem;
            color: var(--success-color);
        }
        
        .fee-item-details {
            margin: 10px 0;
            color: #666;
            font-size: 0.9rem;
            line-height: 1.4;
        }
        
        .fee-item-actions {
            display: flex;
            gap: 8px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        /* Fee Selection in Student Registration */
        .fee-selection-container {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #eee;
            border-radius: var(--border-radius);
            background-color: #f8f9fa;
        }
        
        .fee-selection-title {
            margin-bottom: 15px;
            color: var(--primary-color);
            font-size: 1.1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .fee-selection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .fee-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            background-color: white;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .fee-option:hover {
            border-color: var(--primary-color);
            background-color: #f8f9fa;
        }
        
        .fee-option.required {
            border-left: 4px solid var(--danger-color);
        }
        
        .fee-option input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .fee-option input[type="radio"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .fee-option label {
            flex: 1;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* Fee Payment Form - Multiple Fee Items */
        .fee-payment-container {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #eee;
            border-radius: var(--border-radius);
            background-color: #f8f9fa;
        }
        
        .fee-payment-title {
            margin-bottom: 15px;
            color: var(--primary-color);
            font-size: 1.1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .fee-payment-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
        }
        
        .fee-payment-item {
            background-color: white;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: var(--border-radius);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .fee-payment-item:hover {
            border-color: var(--primary-color);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .fee-payment-item.selected {
            border-color: var(--success-color);
            background-color: rgba(40, 167, 69, 0.05);
        }
        
        .fee-payment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .fee-payment-name {
            font-weight: 600;
            color: var(--primary-color);
            font-size: 1rem;
        }
        
        .fee-payment-amount {
            font-weight: 700;
            color: var(--success-color);
        }
        
        .fee-payment-details {
            color: #666;
            font-size: 0.85rem;
            margin-bottom: 10px;
        }
        
        .fee-payment-input {
            margin-top: 10px;
        }
        
        .fee-payment-input label {
            display: block;
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 5px;
        }
        
        .fee-payment-input input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 0.9rem;
        }
        
        .payment-summary {
            margin-top: 20px;
            padding: 15px;
            background-color: white;
            border-radius: var(--border-radius);
            border: 1px solid #eee;
        }
        
        .payment-total {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--primary-color);
            text-align: right;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background-color: white;
            border-radius: var(--border-radius);
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--primary-color);
            color: white;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
        }
        
        .modal-header h2 {
            color: white;
            font-size: 1.5rem;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: white;
            cursor: pointer;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 30px;
            height: 30px;
        }
        
        /* School Logo Styles */
        .school-logo-display {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: contain;
            border: 3px solid var(--primary-color);
            background-color: white;
            padding: 5px;
        }
        
        .logo-preview-small {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: contain;
            background-color: white;
            border: 1px solid #ddd;
        }
        
        .print-logo {
            width: 80px;
            height: 80px;
            object-fit: contain;
        }
        
        /* Print Styles */
        @media print {
            * {
                color: #000 !important;
                background: #fff !important;
                box-shadow: none !important;
                text-shadow: none !important;
            }
            
            .sidebar, .header, .filters, .actions, .table-footer button, .mobile-menu-toggle,
            .reminder-actions, .modal-footer, .close-modal, button, .no-print {
                display: none !important;
            }
            
            .container {
                display: block;
            }
            
            .main-content {
                padding: 0 !important;
                margin: 0 !important;
            }
            
            .table-container {
                box-shadow: none !important;
                border: 1px solid #000 !important;
            }
            
            table {
                border: 1px solid #000 !important;
            }
            
            th, td {
                border: 1px solid #000 !important;
                color: #000 !important;
            }
            
            th {
                background-color: #f2f2f2 !important;
                color: #000 !important;
                -webkit-print-color-adjust: exact !important;
            }
            
            .print-header {
                display: flex !important;
                flex-direction: column;
                align-items: center;
                text-align: center;
                margin-bottom: 30px;
                padding-bottom: 20px;
                border-bottom: 2px solid #000;
                page-break-after: avoid;
            }
            
            .print-footer {
                display: block !important;
                text-align: center;
                margin-top: 30px;
                padding-top: 20px;
                border-top: 2px solid #000;
                font-size: 0.8rem;
                color: #000 !important;
                page-break-before: avoid;
            }
            
            .print-logo-container {
                display: flex !important;
                align-items: center;
                justify-content: center;
                margin-bottom: 10px;
            }
            
            .print-title {
                font-size: 20px !important;
                font-weight: bold !important;
                margin: 10px 0 !important;
                color: #000 !important;
            }
            
            .print-date {
                font-size: 14px !important;
                margin-bottom: 20px !important;
            }
            
            /* Prevent page breaks inside important elements */
            .stat-card, .reminder-card, .fee-item-card {
                page-break-inside: avoid;
            }
            
            tr {
                page-break-inside: avoid;
            }
            
            /* Print-specific spacing */
            .content-area {
                margin-top: 0 !important;
            }
        }
        
        /* Reminder Cards */
        .reminder-card {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--box-shadow);
            margin-bottom: 20px;
            border-left: 4px solid var(--warning-color);
        }
        
        .reminder-card.overdue {
            border-left-color: var(--danger-color);
            animation: pulse-border 2s infinite;
        }
        
        @keyframes pulse-border {
            0% { border-left-color: var(--danger-color); }
            50% { border-left-color: #ff8a8a; }
            100% { border-left-color: var(--danger-color); }
        }
        
        .reminder-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .reminder-student {
            font-weight: 600;
            color: var(--primary-color);
        }
        
        .reminder-amount {
            font-weight: 700;
            color: var(--danger-color);
        }
        
        .reminder-details {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: var(--border-radius);
            margin: 15px 0;
        }
        
        .reminder-message {
            color: #666;
            line-height: 1.5;
            margin-bottom: 15px;
        }
        
        /* Fee Balance Details */
        .fee-balance-details {
            margin: 15px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: var(--border-radius);
        }
        
        .fee-balance-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        
        .fee-balance-item:last-child {
            border-bottom: none;
        }
        
        /* Data Management Styles */
        .data-management-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .sync-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
        }
        
        .sync-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        .sync-indicator.synced {
            background-color: var(--success-color);
        }
        
        .sync-indicator.pending {
            background-color: var(--warning-color);
            animation: pulse 1.5s infinite;
        }
        
        .sync-indicator.error {
            background-color: var(--danger-color);
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        /* Utility Classes */
        .currency {
            font-family: 'Courier New', monospace;
            font-weight: 600;
        }
        
        .text-center {
            text-align: center;
        }
        
        .mt-20 {
            margin-top: 20px;
        }
        
        .mb-20 {
            margin-bottom: 20px;
        }
        
        .hidden {
            display: none;
        }
        
        .print-header, .print-footer {
            display: none;
        }
        
        /* Receipt Styles */
        .receipt-container {
            padding: 30px;
            font-family: 'Arial', sans-serif;
        }
        
        .receipt-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 20px;
        }
        
        .receipt-logo {
            width: 100px;
            height: 100px;
            margin: 0 auto 15px;
            display: block;
            object-fit: contain;
        }
        
        .receipt-details {
            margin: 20px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: var(--border-radius);
        }
        
        .receipt-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        .receipt-table th {
            background-color: var(--primary-color);
            color: white;
            padding: 10px;
            text-align: left;
        }
        
        .receipt-table td {
            padding: 10px;
            border-bottom: 1px solid #ddd;
        }
        
        .receipt-totals {
            margin-top: 20px;
            text-align: right;
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .receipt-footer {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px dashed #ddd;
            text-align: center;
            font-size: 0.9rem;
            color: #666;
        }
        
        /* Reminder Receipt Styles */
        .reminder-receipt {
            padding: 25px;
            background-color: white;
            border: 2px solid var(--warning-color);
            border-radius: var(--border-radius);
        }
        
        .reminder-receipt.overdue {
            border-color: var(--danger-color);
            background-color: rgba(220, 53, 69, 0.03);
        }
        
        .reminder-receipt-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--primary-color);
        }
        
        .reminder-message-box {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: var(--border-radius);
            margin: 20px 0;
            border-left: 4px solid var(--warning-color);
        }
        
        .reminder-message-box.overdue {
            border-left-color: var(--danger-color);
            background-color: rgba(220, 53, 69, 0.05);
        }
        
        /* Hidden Form for Fee Items */
        .fee-form-container {
            display: none;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 25px;
            margin-bottom: 20px;
            animation: slideDown 0.3s ease;
        }
        
        .fee-form-container.active {
            display: block;
        }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Fee Item Status Badges */
        .fee-item-status {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        
        /* Cloud Sync Loading */
        .sync-loading {
            display: none;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
            color: var(--info-color);
        }
        
        .sync-loading.active {
            display: flex;
        }
        
        .spinner {
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--info-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Notification Badge for Overdue */
        .overdue-notification {
            position: fixed;
            top: 80px;
            right: 20px;
            background-color: var(--danger-color);
            color: white;
            padding: 12px 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            z-index: 1000;
            display: none;
            align-items: center;
            gap: 10px;
            animation: slideInRight 0.5s ease;
        }
        
        .overdue-notification.show {
            display: flex;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* Fee Payment Progress */
        .fee-progress {
            margin-top: 10px;
        }
        
        .fee-progress-bar {
            height: 8px;
            background-color: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .fee-progress-fill {
            height: 100%;
            background-color: var(--success-color);
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        
        .fee-progress-text {
            font-size: 0.8rem;
            color: #666;
            margin-top: 5px;
            display: flex;
            justify-content: space-between;
        }
        
        /* Responsive Styles */
        @media (max-width: 992px) {
            .sidebar {
                position: fixed;
                top: 0;
                left: 0;
                height: 100vh;
                transform: translateX(-100%);
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .mobile-menu-toggle {
                display: flex;
            }
            
            .main-content {
                padding-top: 80px;
            }
            
            .header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .fee-items-list {
                grid-template-columns: 1fr;
            }
            
            .fee-selection-grid {
                grid-template-columns: 1fr;
            }
            
            .fee-payment-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .filters {
                flex-direction: column;
            }
            
            .filter-group {
                min-width: 100%;
            }
            
            .actions {
                flex-direction: column;
            }
            
            .form-row {
                flex-direction: column;
            }
            
            .form-group {
                min-width: 100%;
            }
            
            .stats-container {
                grid-template-columns: 1fr;
            }
            
            .login-box {
                padding: 30px 20px;
            }
            
            .receipt-container {
                padding: 15px;
            }
            
            .fee-item-actions {
                flex-direction: column;
            }
            
            .fee-item-actions button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="login-screen" class="login-container">
        <div class="login-box">
            <div class="login-header">
                <div class="login-logo">
                    <i class="fas fa-graduation-cap"></i>
                </div>
                <h1>Edu-Track CBE Pro</h1>
                <p>School Fees Management System</p>
            </div>
            <form class="login-form" id="login-form">
                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" placeholder="Enter username" required>
                </div>
                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" placeholder="Enter password" required>
                </div>
                <button type="submit" class="login-btn" id="login-submit-btn">
                    <i class="fas fa-sign-in-alt"></i> Login
                    <span class="btn-notification"><i class="fas fa-check"></i></span>
                </button>
                <div class="form-group mt-20">
                    <p class="text-center">Default: admin / admin123</p>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Overdue Notification -->
    <div id="overdue-notification" class="overdue-notification">
        <i class="fas fa-exclamation-triangle"></i>
        <div>
            <strong>Overdue Fees Alert!</strong>
            <span id="overdue-count">0</span> students have overdue fees.
        </div>
        <button onclick="document.getElementById('overdue-notification').classList.remove('show')" style="background: none; border: none; color: white; margin-left: 10px;">
            <i class="fas fa-times"></i>
        </button>
    </div>
    
    <!-- Main Application -->
    <div id="app-container" class="container hidden">
        <!-- Mobile Menu Toggle -->
        <button class="mobile-menu-toggle" id="mobile-menu-toggle">
            <i class="fas fa-bars"></i>
            <span class="btn-notification"><i class="fas fa-check"></i></span>
        </button>
        
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="logo-area">
                <div class="logo">
                    <div class="logo-icon" style="display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; background-color: var(--secondary-color); color: white; border-radius: 50%;">
                        <i class="fas fa-graduation-cap"></i>
                    </div>
                    <div class="logo-text">
                        <h2>Edu-Track CBE Pro</h2>
                        <p>Fees Management</p>
                    </div>
                </div>
            </div>
            
            <div class="menu">
                <div class="menu-item active" data-target="dashboard">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </div>
                <div class="menu-item" data-target="student-register">
                    <i class="fas fa-user-graduate"></i>
                    <span>Student Register</span>
                </div>
                <div class="menu-item" data-target="fee-register">
                    <i class="fas fa-file-invoice-dollar"></i>
                    <span>Fee Register</span>
                </div>
                <div class="menu-item" data-target="fee-reminders">
                    <i class="fas fa-bell"></i>
                    <span>Fee Reminders</span>
                    <div class="alarm-badge">
                        <div class="alarm-count" id="alarm-count">0</div>
                    </div>
                </div>
                <div class="menu-item" data-target="fee-setting">
                    <i class="fas fa-cog"></i>
                    <span>Fee Setting</span>
                </div>
                <div class="menu-item" data-target="app-setting">
                    <i class="fas fa-sliders-h"></i>
                    <span>App Setting</span>
                </div>
                <div class="menu-item" data-target="data-management">
                    <i class="fas fa-database"></i>
                    <span>Data Management</span>
                </div>
            </div>
            
            <div class="user-area">
                <div class="user-avatar">AD</div>
                <div>
                    <div class="user-name">Administrator</div>
                    <div class="user-role">Administrator</div>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Print Header for All Pages -->
            <div class="print-header" id="print-header">
                <div class="print-logo-container">
                    <img id="print-logo" class="print-logo" src="" alt="School Logo">
                </div>
                <div class="print-title" id="print-school-name">Edu-Track Academy</div>
                <div id="print-school-address">P.O. Box 12345, Nairobi, Kenya</div>
                <div id="print-school-contact">Tel: +254 712 345 678 | Email: info@edutrack.ac.ke</div>
                <div class="print-date" id="print-current-date"></div>
                <hr style="border-top: 2px solid #000; margin: 10px 0;">
            </div>
            
            <div class="header">
                <h1 id="page-title">Dashboard Overview</h1>
                <div class="date-display" id="current-date"></div>
            </div>
            
            <!-- Dashboard Content -->
            <div id="dashboard" class="content-area active">
                <div class="sync-status" id="sync-status">
                    <div class="sync-indicator synced" id="sync-indicator"></div>
                    <span id="sync-message">All data synced locally</span>
                </div>
                
                <div class="stats-container">
                    <div class="stat-card stat-1">
                        <div class="stat-icon">
                            <i class="fas fa-user-graduate"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="total-students-count">0</h3>
                            <p>Total Students</p>
                        </div>
                    </div>
                    
                    <div class="stat-card stat-2">
                        <div class="stat-icon">
                            <i class="fas fa-hand-holding-usd"></i>
                        </div>
                        <div class="stat-info">
                            <h3 class="currency" id="total-fees-collected">KES 0</h3>
                            <p>Total Fees Collected</p>
                        </div>
                    </div>
                    
                    <div class="stat-card stat-3">
                        <div class="stat-icon">
                            <i class="fas fa-exclamation-circle"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="students-with-arrears">0</h3>
                            <p>Students with Arrears</p>
                        </div>
                    </div>
                    
                    <div class="stat-card stat-4">
                        <div class="stat-icon">
                            <i class="fas fa-credit-card"></i>
                        </div>
                        <div class="stat-info">
                            <h3 class="currency" id="total-arrears">KES 0</h3>
                            <p>Total Fee Arrears</p>
                        </div>
                    </div>
                </div>
                
                <div class="content-header">
                    <h2>Recent Fee Transactions</h2>
                    <button id="print-dashboard">
                        <i class="fas fa-print"></i> Print Report
                        <span class="btn-notification"><i class="fas fa-check"></i></span>
                    </button>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Receipt No</th>
                                <th>Student Name</th>
                                <th>Class</th>
                                <th>Fee Type</th>
                                <th>Amount (KES)</th>
                                <th>Date Paid</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="dashboard-table-body">
                            <!-- Data loaded dynamically -->
                        </tbody>
                    </table>
                    <div class="table-footer">
                        <div class="total-amount">Total Collected: <span class="currency" id="dashboard-total">KES 0</span></div>
                        <button id="print-dashboard-table">
                            <i class="fas fa-print"></i> Print Table
                            <span class="btn-notification"><i class="fas fa-check"></i></span>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Student Register Content -->
            <div id="student-register" class="content-area">
                <div class="content-header">
                    <h2>Student Register</h2>
                    <button id="add-student-btn">
                        <i class="fas fa-user-plus"></i> Add New Student
                        <span class="btn-notification"><i class="fas fa-check"></i></span>
                    </button>
                </div>
                
                <div class="filters">
                    <div class="filter-group">
                        <label for="student-class-filter">Filter by Class</label>
                        <select id="student-class-filter">
                            <option value="all">All Classes</option>
                            <option value="grade7">Grade 7</option>
                            <option value="grade8">Grade 8</option>
                            <option value="grade9">Grade 9</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="student-search">Search Student</label>
                        <input type="text" id="student-search" placeholder="Enter name or ID">
                    </div>
                    
                    <button id="apply-student-filter" class="btn-secondary">
                        <i class="fas fa-filter"></i> Apply Filter
                        <span class="btn-notification"><i class="fas fa-check"></i></span>
                    </button>
                </div>
                
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Student ID</th>
                                <th>Full Name</th>
                                <th>Class</th>
                                <th>Parent Name</th>
                                <th>Contact</th>
                                <th>Total Fees</th>
                                <th>Paid</th>
                                <th>Balance</th>
                                <th>Due Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="student-table-body">
                            <!-- Data loaded dynamically -->
                        </tbody>
                    </table>
                    <div class="table-footer">
                        <div>Total Students: <strong id="total-students">0</strong></div>
                        <button id="print-student-register">
                            <i class="fas fa-print"></i> Print Register
                            <span class="btn-notification"><i class="fas fa-check"></i></span>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Fee Register Content -->
            <div id="fee-register" class="content-area">
                <div class="content-header">
                    <h2>Fee Register</h2>
                    <button id="add-fee-transaction">
                        <i class="fas fa-plus-circle"></i> Add Fee Payment
                        <span class="btn-notification"><i class="fas fa-check"></i></span>
                    </button>
                </div>
                
                <div class="filters">
                    <div class="filter-group">
                        <label for="fee-class-filter">Filter by Class</label>
                        <select id="fee-class-filter">
                            <option value="all">All Classes</option>
                            <option value="grade7">Grade 7</option>
                            <option value="grade8">Grade 8</option>
                            <option value="grade9">Grade 9</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="fee-student-filter">Filter by Student</label>
                        <select id="fee-student-filter">
                            <option value="all">All Students</option>
                        </select>
                    </div>
                    
                    <button id="apply-fee-filter" class="btn-secondary">
                        <i class="fas fa-filter"></i> Apply Filter
                        <span class="btn-notification"><i class="fas fa-check"></i></span>
                    </button>
                </div>
                
                <div class="table-container">
                    <table id="fee-register-table">
                        <thead>
                            <tr id="fee-table-header">
                                <th>Student Name</th>
                                <th>Class</th>
                                <th>Total Fees</th>
                                <th>Total Paid</th>
                                <th>Balance</th>
                                <!-- Dynamic fee item headers will be added here -->
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="fee-table-body">
                            <!-- Data loaded dynamically -->
                        </tbody>
                        <tfoot id="fee-table-footer">
                            <!-- Footer totals loaded dynamically -->
                        </tfoot>
                    </table>
                    <div class="table-footer">
                        <div class="total-amount">Grand Total: <span class="currency" id="fee-grand-total">KES 0</span></div>
                        <div>
                            <button id="print-fee-register">
                                <i class="fas fa-print"></i> Print Register
                                <span class="btn-notification"><i class="fas fa-check"></i></span>
                            </button>
                            <button id="export-fee-register" class="btn-secondary">
                                <i class="fas fa-file-export"></i> Export
                                <span class="btn-notification"><i class="fas fa-check"></i></span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Fee Reminders Content -->
            <div id="fee-reminders" class="content-area">
                <div class="content-header">
                    <h2>Fee Reminders</h2>
                    <div>
                        <button id="print-all-reminders" class="btn-warning">
                            <i class="fas fa-print"></i> Print All Reminders
                            <span class="btn-notification"><i class="fas fa-check"></i></span>
                        </button>
                        <button id="print-overdue-reminders" class="btn-danger">
                            <i class="fas fa-print"></i> Print Overdue Only
                            <span class="btn-notification"><i class="fas fa-check"></i></span>
                        </button>
                        <button id="send-all-reminders">
                            <i class="fas fa-paper-plane"></i> Send All Reminders
                            <span class="btn-notification"><i class="fas fa-check"></i></span>
                        </button>
                    </div>
                </div>
                
                <div class="filters">
                    <div class="filter-group">
                        <label for="reminder-class-filter">Filter by Class</label>
                        <select id="reminder-class-filter">
                            <option value="all">All Classes</option>
                            <option value="grade7">Grade 7</option>
                            <option value="grade8">Grade 8</option>
                            <option value="grade9">Grade 9</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="reminder-student-filter">Filter by Student</label>
                        <select id="reminder-student-filter">
                            <option value="all">All Students</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="reminder-status-filter">Filter by Status</label>
                        <select id="reminder-status-filter">
                            <option value="all">All</option>
                            <option value="overdue">Overdue</option>
                            <option value="due_soon">Due Soon</option>
                            <option value="paid">Paid</option>
                        </select>
                    </div>
                    
                    <button id="apply-reminder-filter" class="btn-secondary">
                        <i class="fas fa-filter"></i> Apply Filter
                        <span class="btn-notification"><i class="fas fa-check"></i></span>
                    </button>
                </div>
                
                <div id="reminders-container">
                    <!-- Reminders loaded dynamically -->
                </div>
            </div>
            
            <!-- Fee Setting Content -->
            <div id="fee-setting" class="content-area">
                <div class="content-header">
                    <h2>Fee Structure Management</h2>
                    <div>
                        <button id="save-fee-settings" class="btn-success">
                            <i class="fas fa-save"></i> Save All Changes
                            <span class="btn-notification"><i class="fas fa-check"></i></span>
                        </button>
                        <button id="add-new-fee-item" class="btn-info">
                            <i class="fas fa-plus"></i> Add New Fee Item
                            <span class="btn-notification"><i class="fas fa-check"></i></span>
                        </button>
                    </div>
                </div>
                
                <!-- Fee Item Form -->
                <div id="fee-item-form-container" class="fee-form-container">
                    <h3 class="text-center mb-20">Add/Edit Fee Item</h3>
                    
                    <form id="fee-item-form">
                        <input type="hidden" id="fee-item-id">
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="fee-item-name">Fee Item Name *</label>
                                <input type="text" id="fee-item-name" placeholder="e.g., Admission Fee, Tuition Fee" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="fee-item-amount">Amount (KES) *</label>
                                <input type="number" id="fee-item-amount" placeholder="0" min="0" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="fee-item-category">Category</label>
                                <select id="fee-item-category">
                                    <option value="tuition">Tuition</option>
                                    <option value="admission">Admission</option>
                                    <option value="activity">Activity</option>
                                    <option value="uniform">Uniform & Equipment</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="fee-item-description">Description</label>
                                <input type="text" id="fee-item-description" placeholder="Brief description of the fee">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="fee-item-due-days">Due Days (After Registration)</label>
                                <input type="number" id="fee-item-due-days" placeholder="30" min="0">
                                <small style="color: #666;">Number of days after registration when fee is due</small>
                            </div>
                            
                            <div class="form-group">
                                <label for="fee-item-term">Term Applicable</label>
                                <select id="fee-item-term">
                                    <option value="all">All Terms</option>
                                    <option value="term1">Term 1 Only</option>
                                    <option value="term2">Term 2 Only</option>
                                    <option value="term3">Term 3 Only</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="fee-item-required">
                                    <input type="checkbox" id="fee-item-required">
                                    Mark as Required Fee
                                </label>
                                <small style="color: #666;">Required fees are automatically selected for all students</small>
                            </div>
                            
                            <div class="form-group">
                                <label for="fee-item-active">
                                    <input type="checkbox" id="fee-item-active" checked>
                                    Active (Available for selection)
                                </label>
                            </div>
                        </div>
                        
                        <div class="text-center mt-20">
                            <button type="submit" id="save-fee-item" class="btn-success">
                                <i class="fas fa-save"></i> Save Fee Item
                                <span class="btn-notification"><i class="fas fa-check"></i></span>
                            </button>
                            <button type="button" id="clear-fee-form" class="btn-secondary">
                                <i class="fas fa-times"></i> Clear Form
                                <span class="btn-notification"><i class="fas fa-times"></i></span>
                            </button>
                        </div>
                    </form>
                </div>
                
                <div class="mt-20">
                    <h3>Current Fee Items</h3>
                    <div class="fee-items-list" id="fee-items-list">
                        <!-- Fee items loaded dynamically -->
                    </div>
                </div>
            </div>
            
            <!-- App Setting Content -->
            <div id="app-setting" class="content-area">
                <div class="content-header">
                    <h2>Application Settings</h2>
                    <button id="save-app-settings" class="btn-success">
                        <i class="fas fa-save"></i> Save All Settings
                        <span class="btn-notification"><i class="fas fa-check"></i></span>
                    </button>
                </div>
                
                <div class="form-container">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="school-name">School Name</label>
                            <input type="text" id="school-name" value="Edu-Track Academy">
                        </div>
                        <div class="form-group">
                            <label for="school-address">School Address</label>
                            <input type="text" id="school-address" value="P.O. Box 12345, Nairobi, Kenya">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="school-phone">School Phone</label>
                            <input type="text" id="school-phone" value="+254 712 345 678">
                        </div>
                        <div class="form-group">
                            <label for="school-email">School Email</label>
                            <input type="email" id="school-email" value="info@edutrack.ac.ke">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="school-logo">School Logo URL</label>
                            <input type="text" id="school-logo" placeholder="Enter logo URL or upload">
                            <input type="file" id="logo-upload" accept="image/*" class="mt-10" style="display: none;">
                            <button type="button" id="upload-logo-btn" class="btn-secondary btn-small mt-10">
                                <i class="fas fa-upload"></i> Upload Logo
                                <span class="btn-notification"><i class="fas fa-check"></i></span>
                            </button>
                        </div>
                        <div class="form-group">
                            <label>Logo Preview</label>
                            <div id="logo-preview" class="school-logo-display">
                                <i class="fas fa-school" style="font-size: 3rem; color: #ccc;"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Data Management Content -->
            <div id="data-management" class="content-area">
                <div class="content-header">
                    <h2>Data Management</h2>
                    <div>
                        <button id="sync-to-cloud" class="btn-success">
                            <i class="fas fa-cloud-upload-alt"></i> Sync to Cloud
                            <span class="btn-notification"><i class="fas fa-check"></i></span>
                        </button>
                        <button id="backup-data" class="btn-info">
                            <i class="fas fa-download"></i> Backup Data
                            <span class="btn-notification"><i class="fas fa-check"></i></span>
                        </button>
                    </div>
                </div>
                
                <div class="sync-status">
                    <div class="sync-indicator" id="cloud-sync-indicator"></div>
                    <span id="cloud-sync-message">Cloud sync: Not configured</span>
                </div>
                
                <div class="sync-loading" id="sync-loading">
                    <div class="spinner"></div>
                    <span>Syncing with Google Sheets...</span>
                </div>
                
                <div class="form-container">
                    <h3>Google Sheets Integration</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="google-sheet-id">Google Sheet ID</label>
                            <input type="text" id="google-sheet-id" placeholder="Enter Google Sheet ID">
                            <small style="color: #666;">Get this from your Google Sheet URL</small>
                        </div>
                        <div class="form-group">
                            <label for="web-app-url">Web App URL</label>
                            <input type="text" id="web-app-url" placeholder="Enter Google Apps Script Web App URL">
                            <small style="color: #666;">Paste your deployed web app URL here</small>
                        </div>
                    </div>
                    
                    <div class="data-management-actions">
                        <button id="test-connection" class="btn-warning">
                            <i class="fas fa-plug"></i> Test Connection
                            <span class="btn-notification"><i class="fas fa-check"></i></span>
                        </button>
                        <button id="save-cloud-settings" class="btn-success">
                            <i class="fas fa-save"></i> Save Settings
                            <span class="btn-notification"><i class="fas fa-check"></i></span>
                        </button>
                        <button id="sync-now" class="btn-info">
                            <i class="fas fa-sync"></i> Sync Now
                            <span class="btn-notification"><i class="fas fa-check"></i></span>
                        </button>
                    </div>
                    
                    <div class="mt-20">
                        <h3>Data Operations</h3>
                        <div class="data-management-actions">
                            <button id="export-data" class="btn-secondary">
                                <i class="fas fa-file-export"></i> Export to JSON
                                <span class="btn-notification"><i class="fas fa-check"></i></span>
                            </button>
                            <button id="import-data" class="btn-secondary">
                                <i class="fas fa-file-import"></i> Import from JSON
                                <span class="btn-notification"><i class="fas fa-check"></i></span>
                            </button>
                            <button id="clear-data" class="btn-danger">
                                <i class="fas fa-trash"></i> Clear All Data
                                <span class="btn-notification"><i class="fas fa-times"></i></span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="mt-20">
                        <h3>System Information</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Local Storage Used</label>
                                <div id="storage-usage">0 KB</div>
                            </div>
                            <div class="form-group">
                                <label>Last Backup</label>
                                <div id="last-backup">Never</div>
                            </div>
                            <div class="form-group">
                                <label>Last Sync</label>
                                <div id="last-sync">Never</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Print Footer for All Pages -->
        <div class="print-footer" id="print-footer">
            <p>Generated by Edu-Track CBE Pro Fees Management System</p>
            <p>Date: <span id="print-date"></span> | Page <span class="page-number"></span></p>
        </div>
    </div>
    
    <!-- Student Modal -->
    <div id="student-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="student-modal-title">Add New Student</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="student-form">
                    <input type="hidden" id="student-id">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="first-name">First Name *</label>
                            <input type="text" id="first-name" required>
                        </div>
                        <div class="form-group">
                            <label for="last-name">Last Name *</label>
                            <input type="text" id="last-name" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="student-class">Class *</label>
                            <select id="student-class" required>
                                <option value="">Select Class</option>
                                <option value="grade7">Grade 7</option>
                                <option value="grade8">Grade 8</option>
                                <option value="grade9">Grade 9</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="student-dob">Date of Birth</label>
                            <input type="date" id="student-dob">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="parent-name">Parent/Guardian Name *</label>
                            <input type="text" id="parent-name" required>
                        </div>
                        <div class="form-group">
                            <label for="parent-phone">Parent Phone *</label>
                            <input type="tel" id="parent-phone" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="parent-email">Parent Email</label>
                            <input type="email" id="parent-email">
                        </div>
                        <div class="form-group">
                            <label for="parent-address">Address</label>
                            <input type="text" id="parent-address">
                        </div>
                    </div>
                    
                    <!-- Fee Selection Section -->
                    <div class="fee-selection-container">
                        <div class="fee-selection-title">
                            <span>Select Fee Items to Pay</span>
                            <small>Required fees are pre-selected</small>
                        </div>
                        <div class="fee-selection-grid" id="fee-selection-grid">
                            <!-- Fee items loaded dynamically -->
                        </div>
                    </div>
                    
                    <div class="text-center mt-20">
                        <button type="submit" class="btn-success" id="save-student-btn">
                            <i class="fas fa-save"></i> Save Student
                            <span class="btn-notification"><i class="fas fa-check"></i></span>
                        </button>
                        <button type="button" class="btn-secondary close-modal">
                            Cancel
                            <span class="btn-notification"><i class="fas fa-times"></i></span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Fee Payment Modal -->
    <div id="fee-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="fee-modal-title">Record Fee Payment</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="fee-form">
                    <input type="hidden" id="payment-id">
                    <input type="hidden" id="payment-student-id">
                    <input type="hidden" id="payment-total-amount" value="0">
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="payment-student">Student *</label>
                            <select id="payment-student" required>
                                <option value="">Select Student</option>
                                <!-- Students will be loaded dynamically -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="payment-date">Payment Date *</label>
                            <input type="date" id="payment-date" required>
                        </div>
                    </div>
                    
                    <!-- Multiple Fee Items Selection -->
                    <div class="fee-payment-container" id="fee-payment-container">
                        <div class="fee-payment-title">
                            <span>Select Fee Items to Pay</span>
                            <small>Click on fee items to select</small>
                        </div>
                        <div class="fee-payment-grid" id="fee-payment-grid">
                            <!-- Fee items loaded dynamically -->
                        </div>
                        
                        <div class="payment-summary">
                            <div class="payment-total">
                                Total Amount to Pay: <span id="payment-summary-total" class="currency">KES 0</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="payment-amount">Total Amount (KES) *</label>
                            <input type="number" id="payment-amount" placeholder="0" min="1" required readonly style="background-color: #f8f9fa;">
                            <small style="color: #666;">Automatically calculated from selected fee items</small>
                        </div>
                        
                        <div class="form-group">
                            <label for="payment-method">Payment Method *</label>
                            <select id="payment-method" required>
                                <option value="">Select Method</option>
                                <option value="cash">Cash</option>
                                <option value="mpesa">M-Pesa</option>
                                <option value="bank">Bank Transfer</option>
                                <option value="cheque">Cheque</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="payment-reference">Reference Number</label>
                            <input type="text" id="payment-reference" placeholder="Transaction/Cheque number">
                        </div>
                        
                        <div class="form-group">
                            <label for="payment-notes">Notes</label>
                            <textarea id="payment-notes" rows="3"></textarea>
                        </div>
                    </div>
                    
                    <div class="text-center mt-20">
                        <button type="submit" class="btn-success" id="save-payment-btn">
                            <i class="fas fa-save"></i> Record Payment
                            <span class="btn-notification"><i class="fas fa-check"></i></span>
                        </button>
                        <button type="button" class="btn-secondary close-modal">
                            Cancel
                            <span class="btn-notification"><i class="fas fa-times"></i></span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Receipt Modal -->
    <div id="receipt-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Payment Receipt</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="receipt-content">
                    <!-- Receipt content loaded dynamically -->
                </div>
            </div>
            <div class="modal-footer" style="padding: 15px 20px; border-top: 1px solid #eee; text-align: right;">
                <button id="print-receipt-btn" class="btn-secondary">
                    <i class="fas fa-print"></i> Print Receipt
                    <span class="btn-notification"><i class="fas fa-check"></i></span>
                </button>
                <button class="btn-secondary close-modal">
                    Close
                    <span class="btn-notification"><i class="fas fa-times"></i></span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Reminder Receipt Modal -->
    <div id="reminder-receipt-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Fee Reminder Receipt</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="reminder-receipt-content">
                    <!-- Reminder receipt content loaded dynamically -->
                </div>
            </div>
            <div class="modal-footer" style="padding: 15px 20px; border-top: 1px solid #eee; text-align: right;">
                <button id="print-reminder-receipt-btn" class="btn-secondary">
                    <i class="fas fa-print"></i> Print Reminder
                    <span class="btn-notification"><i class="fas fa-check"></i></span>
                </button>
                <button id="send-reminder-email-btn" class="btn-success">
                    <i class="fas fa-envelope"></i> Send as Email
                    <span class="btn-notification"><i class="fas fa-check"></i></span>
                </button>
                <button class="btn-secondary close-modal">
                    Close
                    <span class="btn-notification"><i class="fas fa-times"></i></span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 id="confirm-title">Confirm Action</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <p id="confirm-message">Are you sure you want to perform this action?</p>
            </div>
            <div class="modal-footer" style="padding: 15px 20px; border-top: 1px solid #eee; text-align: right;">
                <button id="confirm-cancel" class="btn-secondary">
                    Cancel
                    <span class="btn-notification"><i class="fas fa-times"></i></span>
                </button>
                <button id="confirm-ok" class="btn-danger">
                    Confirm
                    <span class="btn-notification"><i class="fas fa-check"></i></span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <script>
        // ============================================
        // EDU-TRACK CBE PRO - COMPLETE FEES MANAGEMENT SYSTEM
        // ============================================
        
        // Application Configuration
        const APP_CONFIG = {
            APP_NAME: 'Edu-Track CBE Pro',
            VERSION: '2.1.0',
            DEFAULT_CURRENCY: 'KES',
            STORAGE_PREFIX: 'edutrack_',
            NEXT_STUDENT_ID: 1001,
            NEXT_RECEIPT_NO: 1001,
            GOOGLE_SHEET_API: 'https://script.google.com/macros/s/AKfycbyyZLmMkHiyJcXfKZt9oWevQWjP8k8SfZY9B3-9pCeqfApz7axKv9CFZq8CgTVjHp-a/exec'
        };
        
        // Admin credentials
        const ADMIN_CREDENTIALS = {
            username: 'admin',
            password: 'admin123'
        };
        
        // Initial Data Structure
        let appData = {
            students: [],
            feePayments: [],
            feeItems: [],
            settings: {
                schoolName: 'Edu-Track Academy',
                schoolAddress: 'P.O. Box 12345, Nairobi, Kenya',
                schoolPhone: '+254 712 345 678',
                schoolEmail: 'info@edutrack.ac.ke',
                schoolLogo: '',
                cloudSettings: {
                    googleSheetId: '',
                    webAppUrl: APP_CONFIG.GOOGLE_SHEET_API
                }
            },
            lastBackup: null,
            lastSync: null
        };
        
        // Default Fee Items
        const DEFAULT_FEE_ITEMS = [
            { id: 'admission', name: 'Admission Fees', amount: 5000, category: 'admission', isRequired: true, active: true, dueDays: 7, term: 'all' },
            { id: 'caution', name: 'Caution Fees (Refundable)', amount: 3000, category: 'admission', isRequired: true, active: true, dueDays: 7, term: 'all' },
            { id: 'term1', name: 'Term 1 Tuition Fees', amount: 20000, category: 'tuition', isRequired: true, active: true, dueDays: 30, term: 'term1' },
            { id: 'term2', name: 'Term 2 Tuition Fees', amount: 20000, category: 'tuition', isRequired: true, active: true, dueDays: 30, term: 'term2' },
            { id: 'term3', name: 'Term 3 Tuition Fees', amount: 20000, category: 'tuition', isRequired: true, active: true, dueDays: 30, term: 'term3' },
            { id: 'pta', name: 'PTA Fees', amount: 1000, category: 'other', isRequired: true, active: true, dueDays: 14, term: 'all' },
            { id: 'assessment', name: 'Assessment Fees', amount: 2500, category: 'other', isRequired: false, active: true, dueDays: 21, term: 'all' },
            { id: 'project', name: 'Project Fees', amount: 1500, category: 'other', isRequired: false, active: true, dueDays: 21, term: 'all' },
            { id: 'badge', name: 'Badge & Tie', amount: 800, category: 'uniform', isRequired: true, active: true, dueDays: 14, term: 'all' },
            { id: 'school-id', name: 'School ID', amount: 500, category: 'uniform', isRequired: true, active: true, dueDays: 14, term: 'all' },
            { id: 'uniform', name: 'Uniform', amount: 7500, category: 'uniform', isRequired: true, active: true, dueDays: 14, term: 'all' },
            { id: 'academic-welfare', name: 'Academic Welfare', amount: 3000, category: 'other', isRequired: false, active: true, dueDays: 30, term: 'all' },
            { id: 'activity', name: 'Activity Fees', amount: 2500, category: 'activity', isRequired: true, active: true, dueDays: 21, term: 'all' }
        ];
        
        // DOM Elements
        const loginScreen = document.getElementById('login-screen');
        const appContainer = document.getElementById('app-container');
        const loginForm = document.getElementById('login-form');
        const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
        const sidebar = document.getElementById('sidebar');
        const menuItems = document.querySelectorAll('.menu-item');
        const contentAreas = document.querySelectorAll('.content-area');
        
        // Initialize Toastr
        toastr.options = {
            "closeButton": true,
            "progressBar": true,
            "positionClass": "toast-top-right",
            "timeOut": "3000",
            "showMethod": "slideDown",
            "hideMethod": "slideUp"
        };
        
        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        
        // Format currency
        function formatCurrency(amount) {
            if (amount === undefined || amount === null) return 'KES 0';
            return new Intl.NumberFormat('en-KE', {
                style: 'currency',
                currency: 'KES',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount).replace('KES', 'KES ');
        }
        
        // Generate student ID
        function generateStudentId() {
            let nextId = APP_CONFIG.NEXT_STUDENT_ID + appData.students.length;
            return `ETJA${nextId.toString().padStart(4, '0')}`;
        }
        
        // Generate receipt number
        function generateReceiptNo() {
            let nextNo = APP_CONFIG.NEXT_RECEIPT_NO + appData.feePayments.length;
            return `RCPT-${nextNo.toString().padStart(6, '0')}`;
        }
        
        // Format date
        function formatDate(date) {
            if (!date) return '';
            try {
                const d = new Date(date);
                return d.toLocaleDateString('en-GB', {
                    day: '2-digit',
                    month: 'short',
                    year: 'numeric'
                });
            } catch (e) {
                return '';
            }
        }
        
        // Get current date
        function getCurrentDate() {
            return new Date().toISOString().split('T')[0];
        }
        
        // Generate unique ID
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        }
        
        // Add days to date
        function addDaysToDate(date, days) {
            const result = new Date(date);
            result.setDate(result.getDate() + days);
            return result.toISOString().split('T')[0];
        }
        
        // Calculate total fees for a student
        function calculateTotalFees(student) {
            if (!student || !student.feeItems) return 0;
            
            let total = 0;
            student.feeItems.forEach(feeItemId => {
                const feeItem = appData.feeItems.find(f => f.id === feeItemId);
                if (feeItem && feeItem.active) {
                    total += feeItem.amount;
                }
            });
            
            return total;
        }
        
        // Calculate total paid for a student
        function calculateTotalPaid(studentId) {
            const feePayments = appData.feePayments.filter(p => p.studentId === studentId);
            return feePayments.reduce((sum, payment) => sum + payment.amount, 0);
        }
        
        // Calculate paid amount for specific fee item
        function calculatePaidForFeeItem(studentId, feeItemId) {
            const feePayments = appData.feePayments.filter(p => 
                p.studentId === studentId && p.feeItemId === feeItemId
            );
            return feePayments.reduce((sum, payment) => sum + payment.amount, 0);
        }
        
        // Calculate due date for fee item
        function calculateDueDate(student, feeItemId) {
            if (!student || !student.dateAdded) return null;
            
            const feeItem = appData.feeItems.find(f => f.id === feeItemId);
            if (!feeItem || !feeItem.dueDays) return null;
            
            return addDaysToDate(student.dateAdded, feeItem.dueDays);
        }
        
        // Check if fee is overdue
        function isFeeOverdue(dueDate) {
            if (!dueDate) return false;
            const today = new Date();
            const due = new Date(dueDate);
            return due < today;
        }
        
        // Calculate days remaining
        function calculateDaysRemaining(dueDate) {
            if (!dueDate) return null;
            const today = new Date();
            const due = new Date(dueDate);
            const diffTime = due - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            return diffDays;
        }
        
        // Get active fee items
        function getActiveFeeItems() {
            return appData.feeItems.filter(item => item.active !== false);
        }
        
        // Get required fee items
        function getRequiredFeeItems() {
            return appData.feeItems.filter(item => item.isRequired && item.active !== false);
        }
        
        // Show success message
        function showSuccess(message) {
            toastr.success(message);
        }
        
        // Show error message
        function showError(message) {
            toastr.error(message);
        }
        
        // Show info message
        function showInfo(message) {
            toastr.info(message);
        }
        
        // Show warning message
        function showWarning(message) {
            toastr.warning(message);
        }
        
        // Show button notification
        function showButtonNotification(button, success = true, message = null) {
            if (!button) return;
            
            let notification = button.querySelector('.btn-notification');
            if (!notification) {
                notification = document.createElement('span');
                notification.className = 'btn-notification';
                notification.innerHTML = success ? '<i class="fas fa-check"></i>' : '<i class="fas fa-times"></i>';
                button.appendChild(notification);
            }
            
            const icon = notification.querySelector('i');
            if (icon) {
                icon.className = success ? 'fas fa-check' : 'fas fa-times';
            }
            
            button.classList.add('btn-show-notification');
            if (success) {
                button.classList.add('btn-success');
                button.classList.remove('btn-danger');
            } else {
                button.classList.add('btn-danger');
                button.classList.remove('btn-success');
            }
            
            setTimeout(() => {
                button.classList.remove('btn-show-notification');
                button.classList.remove('btn-success', 'btn-danger');
                
                if (message) {
                    if (success) {
                        showSuccess(message);
                    } else {
                        showError(message);
                    }
                }
            }, 1000);
        }
        
        // Show overdue notification
        function showOverdueNotification(count) {
            const notification = document.getElementById('overdue-notification');
            const countElement = document.getElementById('overdue-count');
            
            if (count > 0) {
                countElement.textContent = count;
                notification.classList.add('show');
                
                // Auto-hide after 10 seconds
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 10000);
            } else {
                notification.classList.remove('show');
            }
        }
        
        // ============================================
        // STORAGE FUNCTIONS
        // ============================================
        
        // Save data to localStorage
        function saveToLocalStorage() {
            try {
                appData.lastBackup = new Date().toISOString();
                localStorage.setItem(APP_CONFIG.STORAGE_PREFIX + 'appData', JSON.stringify(appData));
                updateStorageInfo();
                return true;
            } catch (error) {
                console.error('Error saving to localStorage:', error);
                showError('Failed to save data. Check storage space.');
                return false;
            }
        }
        
        // Load data from localStorage
        function loadFromLocalStorage() {
            try {
                const savedData = localStorage.getItem(APP_CONFIG.STORAGE_PREFIX + 'appData');
                if (savedData) {
                    appData = JSON.parse(savedData);
                }
                
                if (!appData.feeItems || appData.feeItems.length === 0) {
                    appData.feeItems = DEFAULT_FEE_ITEMS;
                }
                
                if (!appData.settings) {
                    appData.settings = {
                        schoolName: 'Edu-Track Academy',
                        schoolAddress: 'P.O. Box 12345, Nairobi, Kenya',
                        schoolPhone: '+254 712 345 678',
                        schoolEmail: 'info@edutrack.ac.ke',
                        schoolLogo: '',
                        cloudSettings: {
                            googleSheetId: '',
                            webAppUrl: APP_CONFIG.GOOGLE_SHEET_API
                        }
                    };
                }
                
                updateStorageInfo();
                updateSyncStatus();
                return true;
            } catch (error) {
                console.error('Error loading from localStorage:', error);
                showWarning('Loading default data due to storage error');
                appData = {
                    students: [],
                    feePayments: [],
                    feeItems: DEFAULT_FEE_ITEMS,
                    settings: {
                        schoolName: 'Edu-Track Academy',
                        schoolAddress: 'P.O. Box 12345, Nairobi, Kenya',
                        schoolPhone: '+254 712 345 678',
                        schoolEmail: 'info@edutrack.ac.ke',
                        schoolLogo: '',
                        cloudSettings: {
                            googleSheetId: '',
                            webAppUrl: APP_CONFIG.GOOGLE_SHEET_API
                        }
                    },
                    lastBackup: null,
                    lastSync: null
                };
                saveToLocalStorage();
                return false;
            }
        }
        
        // Update storage usage info
        function updateStorageInfo() {
            try {
                const data = JSON.stringify(appData);
                const sizeInKB = (data.length / 1024).toFixed(2);
                document.getElementById('storage-usage').textContent = `${sizeInKB} KB`;
                
                document.getElementById('last-backup').textContent = 
                    appData.lastBackup ? formatDate(appData.lastBackup) : 'Never';
                document.getElementById('last-sync').textContent = 
                    appData.lastSync ? formatDate(appData.lastSync) : 'Never';
            } catch (error) {
                console.error('Error updating storage info:', error);
            }
        }
        
        // Update sync status
        function updateSyncStatus() {
            const indicator = document.getElementById('sync-indicator');
            const message = document.getElementById('sync-message');
            const cloudIndicator = document.getElementById('cloud-sync-indicator');
            const cloudMessage = document.getElementById('cloud-sync-message');
            
            indicator.className = 'sync-indicator synced';
            message.textContent = 'All data synced locally';
            
            if (appData.settings.cloudSettings.webAppUrl && appData.settings.cloudSettings.googleSheetId) {
                cloudIndicator.className = 'sync-indicator synced';
                cloudMessage.textContent = 'Cloud sync: Configured';
            } else {
                cloudIndicator.className = 'sync-indicator pending';
                cloudMessage.textContent = 'Cloud sync: Not configured';
            }
        }
        
        // Update alarm count
        function updateAlarmCount() {
            let overdueCount = 0;
            let overdueStudents = 0;
            const today = new Date();
            
            appData.students.forEach(student => {
                let studentHasOverdue = false;
                
                student.feeItems.forEach(feeItemId => {
                    const dueDate = calculateDueDate(student, feeItemId);
                    if (dueDate && isFeeOverdue(dueDate)) {
                        const paidAmount = calculatePaidForFeeItem(student.id, feeItemId);
                        const feeItem = appData.feeItems.find(f => f.id === feeItemId);
                        if (feeItem && paidAmount < feeItem.amount) {
                            overdueCount++;
                            studentHasOverdue = true;
                        }
                    }
                });
                
                if (studentHasOverdue) {
                    overdueStudents++;
                }
            });
            
            const alarmCountElement = document.getElementById('alarm-count');
            alarmCountElement.textContent = overdueStudents;
            if (overdueStudents > 0) {
                alarmCountElement.style.display = 'flex';
                
                // Show notification for overdue fees
                if (document.getElementById('dashboard').classList.contains('active')) {
                    showOverdueNotification(overdueStudents);
                }
            } else {
                alarmCountElement.style.display = 'none';
            }
        }
        
        // ============================================
        // GOOGLE SHEETS INTEGRATION FUNCTIONS - FIXED
        // ============================================
        
        // Test Google Sheets connection
        async function testCloudConnection() {
            try {
                const webAppUrl = appData.settings.cloudSettings.webAppUrl || APP_CONFIG.GOOGLE_SHEET_API;
                if (!webAppUrl) {
                    showError('Please enter Web App URL first');
                    return false;
                }
                
                document.getElementById('sync-loading').classList.add('active');
                
                // Test with a simple request
                const response = await fetch(webAppUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'test',
                        sheetId: appData.settings.cloudSettings.googleSheetId || 'test',
                        timestamp: new Date().toISOString()
                    })
                });
                
                const result = await response.json();
                
                document.getElementById('sync-loading').classList.remove('active');
                
                if (result.success) {
                    showSuccess('Connection successful!');
                    return true;
                } else {
                    showError(`Connection failed: ${result.error || 'Unknown error'}`);
                    return false;
                }
            } catch (error) {
                document.getElementById('sync-loading').classList.remove('active');
                console.error('Connection error:', error);
                showError('Connection test failed. Please check your URL and try again.');
                return false;
            }
        }
        
        // Sync data to Google Sheets
        async function syncToCloud() {
            try {
                const webAppUrl = appData.settings.cloudSettings.webAppUrl || APP_CONFIG.GOOGLE_SHEET_API;
                const sheetId = appData.settings.cloudSettings.googleSheetId;
                
                if (!webAppUrl) {
                    showError('Please configure Google Sheets integration first');
                    return false;
                }
                
                if (!sheetId) {
                    showError('Please enter Google Sheet ID');
                    return false;
                }
                
                document.getElementById('sync-loading').classList.add('active');
                
                // Prepare data for sync
                const syncData = {
                    action: 'sync',
                    sheetId: sheetId,
                    data: {
                        students: appData.students,
                        feePayments: appData.feePayments,
                        feeItems: appData.feeItems,
                        settings: appData.settings,
                        timestamp: new Date().toISOString()
                    }
                };
                
                console.log('Sending sync data:', syncData);
                
                const response = await fetch(webAppUrl, {
                    method: 'POST',
                    mode: 'no-cors', // Try no-cors mode
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(syncData)
                });
                
                // With no-cors, we can't read the response
                // But we'll assume success if no error is thrown
                
                document.getElementById('sync-loading').classList.remove('active');
                
                appData.lastSync = new Date().toISOString();
                saveToLocalStorage();
                showSuccess('Data synced to Google Sheets successfully!');
                return true;
                
            } catch (error) {
                document.getElementById('sync-loading').classList.remove('active');
                console.error('Sync error:', error);
                showError('Sync failed: ' + error.message);
                return false;
            }
        }
        
        // Load data from Google Sheets
        async function loadFromCloud() {
            try {
                const webAppUrl = appData.settings.cloudSettings.webAppUrl || APP_CONFIG.GOOGLE_SHEET_API;
                const sheetId = appData.settings.cloudSettings.googleSheetId;
                
                if (!webAppUrl) {
                    showError('Please configure Google Sheets integration first');
                    return false;
                }
                
                if (!sheetId) {
                    showError('Please enter Google Sheet ID');
                    return false;
                }
                
                document.getElementById('sync-loading').classList.add('active');
                
                const response = await fetch(webAppUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: 'load',
                        sheetId: sheetId
                    })
                });
                
                const result = await response.json();
                
                document.getElementById('sync-loading').classList.remove('active');
                
                if (result.success && result.data) {
                    // Merge cloud data with local
                    if (result.data.students) appData.students = result.data.students;
                    if (result.data.feePayments) appData.feePayments = result.data.feePayments;
                    if (result.data.feeItems) appData.feeItems = result.data.feeItems;
                    if (result.data.settings) appData.settings = result.data.settings;
                    
                    saveToLocalStorage();
                    initializeUI();
                    showSuccess('Data loaded from Google Sheets successfully!');
                    return true;
                } else {
                    showError(`Load failed: ${result.error || 'Unknown error'}`);
                    return false;
                }
            } catch (error) {
                document.getElementById('sync-loading').classList.remove('active');
                console.error('Load error:', error);
                showError('Load failed: ' + error.message);
                return false;
            }
        }
        
        // ============================================
        // DASHBOARD FUNCTIONS
        // ============================================
        
        // Update dashboard stats
        function updateDashboardStats() {
            const totalStudents = appData.students.length;
            const totalCollected = appData.feePayments.reduce((sum, payment) => sum + payment.amount, 0);
            
            let studentsWithArrears = 0;
            let totalArrears = 0;
            
            appData.students.forEach(student => {
                const totalFees = calculateTotalFees(student);
                const totalPaid = calculateTotalPaid(student.id);
                const balance = totalFees - totalPaid;
                
                if (balance > 0) {
                    studentsWithArrears++;
                    totalArrears += balance;
                }
            });
            
            document.getElementById('total-students-count').textContent = totalStudents;
            document.getElementById('total-fees-collected').textContent = formatCurrency(totalCollected);
            document.getElementById('students-with-arrears').textContent = studentsWithArrears;
            document.getElementById('total-arrears').textContent = formatCurrency(totalArrears);
            
            updateRecentTransactions();
            updateAlarmCount();
        }
        
        // Update recent transactions table
        function updateRecentTransactions() {
            const tbody = document.getElementById('dashboard-table-body');
            const recentPayments = [...appData.feePayments]
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 10);
            
            let totalCollected = 0;
            tbody.innerHTML = '';
            
            recentPayments.forEach(payment => {
                const student = appData.students.find(s => s.id === payment.studentId);
                const feeItem = appData.feeItems.find(f => f.id === payment.feeItemId);
                
                if (student && feeItem) {
                    totalCollected += payment.amount;
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${payment.receiptNo}</td>
                        <td>${student.firstName} ${student.lastName}</td>
                        <td>${student.class.toUpperCase()}</td>
                        <td>${feeItem.name}</td>
                        <td class="currency">${formatCurrency(payment.amount)}</td>
                        <td>${formatDate(payment.date)}</td>
                        <td><span class="badge badge-success">Paid</span></td>
                    `;
                    tbody.appendChild(row);
                }
            });
            
            document.getElementById('dashboard-total').textContent = formatCurrency(totalCollected);
        }
        
        // ============================================
        // STUDENT REGISTER FUNCTIONS
        // ============================================
        
        // Load students table
        function loadStudentsTable(filterClass = 'all', searchTerm = '') {
            const tbody = document.getElementById('student-table-body');
            let students = [...appData.students];
            
            if (filterClass !== 'all') {
                students = students.filter(student => student.class === filterClass);
            }
            
            if (searchTerm) {
                const term = searchTerm.toLowerCase();
                students = students.filter(student => 
                    student.firstName.toLowerCase().includes(term) ||
                    student.lastName.toLowerCase().includes(term) ||
                    student.id.toLowerCase().includes(term) ||
                    student.parentName.toLowerCase().includes(term)
                );
            }
            
            document.getElementById('total-students').textContent = students.length;
            tbody.innerHTML = '';
            
            students.forEach(student => {
                const totalFees = calculateTotalFees(student);
                const totalPaid = calculateTotalPaid(student.id);
                const balance = totalFees - totalPaid;
                
                let earliestDueDate = null;
                student.feeItems.forEach(feeItemId => {
                    const dueDate = calculateDueDate(student, feeItemId);
                    if (dueDate && (!earliestDueDate || new Date(dueDate) < new Date(earliestDueDate))) {
                        earliestDueDate = dueDate;
                    }
                });
                
                let status = 'success';
                let statusText = 'Paid';
                
                if (balance > 0) {
                    status = totalPaid > 0 ? 'warning' : 'danger';
                    statusText = totalPaid > 0 ? 'Partial' : 'Unpaid';
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${student.id}</td>
                    <td>${student.firstName} ${student.lastName}</td>
                    <td>${student.class.toUpperCase()}</td>
                    <td>${student.parentName}</td>
                    <td>${student.parentPhone}</td>
                    <td class="currency">${formatCurrency(totalFees)}</td>
                    <td class="currency">${formatCurrency(totalPaid)}</td>
                    <td class="currency">${formatCurrency(balance)}</td>
                    <td>${earliestDueDate ? formatDate(earliestDueDate) : 'N/A'}</td>
                    <td><span class="badge badge-${status}">${statusText}</span></td>
                    <td class="actions">
                        <button class="btn-icon btn-info btn-small view-student" data-id="${student.id}">
                            <i class="fas fa-eye"></i>
                            <span class="btn-notification"><i class="fas fa-check"></i></span>
                        </button>
                        <button class="btn-icon btn-secondary btn-small edit-student" data-id="${student.id}">
                            <i class="fas fa-edit"></i>
                            <span class="btn-notification"><i class="fas fa-check"></i></span>
                        </button>
                        <button class="btn-icon btn-success btn-small add-payment" data-id="${student.id}">
                            <i class="fas fa-money-bill-wave"></i>
                            <span class="btn-notification"><i class="fas fa-check"></i></span>
                        </button>
                        <button class="btn-icon btn-danger btn-small delete-student" data-id="${student.id}">
                            <i class="fas fa-trash"></i>
                            <span class="btn-notification"><i class="fas fa-times"></i></span>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            addStudentActionListeners();
        }
        
        // Load fee selection for student registration
        function loadFeeSelection() {
            const container = document.getElementById('fee-selection-grid');
            const activeFeeItems = getActiveFeeItems();
            const requiredFeeItems = getRequiredFeeItems();
            
            container.innerHTML = '';
            
            activeFeeItems.forEach(feeItem => {
                const isRequired = requiredFeeItems.some(f => f.id === feeItem.id);
                const optionDiv = document.createElement('div');
                optionDiv.className = `fee-option ${isRequired ? 'required' : ''}`;
                
                optionDiv.innerHTML = `
                    <input type="checkbox" id="fee-${feeItem.id}" value="${feeItem.id}" 
                        ${isRequired ? 'checked disabled' : ''}>
                    <label for="fee-${feeItem.id}">
                        <span>${feeItem.name} ${isRequired ? '<small style="color: var(--danger-color);">(Required)</small>' : ''}</span>
                        <span class="currency">${formatCurrency(feeItem.amount)}</span>
                    </label>
                `;
                
                container.appendChild(optionDiv);
            });
        }
        
        // Load fee payment selection (multiple fee items with selection)
        function loadFeePaymentSelection(studentId = null) {
            const container = document.getElementById('fee-payment-grid');
            
            container.innerHTML = '';
            
            if (!studentId) {
                container.innerHTML = '<div class="text-center" style="grid-column: 1 / -1; padding: 20px; color: #666;">Please select a student first</div>';
                return;
            }
            
            const student = appData.students.find(s => s.id === studentId);
            if (!student) {
                container.innerHTML = '<div class="text-center" style="grid-column: 1 / -1; padding: 20px; color: #666;">Student not found</div>';
                return;
            }
            
            const unpaidFeeItems = [];
            
            // Get all fee items assigned to the student
            student.feeItems.forEach(feeItemId => {
                const feeItem = appData.feeItems.find(f => f.id === feeItemId);
                if (feeItem && feeItem.active) {
                    const paidAmount = calculatePaidForFeeItem(student.id, feeItemId);
                    const balance = feeItem.amount - paidAmount;
                    
                    if (balance > 0) {
                        unpaidFeeItems.push({
                            ...feeItem,
                            paidAmount: paidAmount,
                            balance: balance,
                            progress: (paidAmount / feeItem.amount) * 100
                        });
                    }
                }
            });
            
            if (unpaidFeeItems.length === 0) {
                container.innerHTML = '<div class="text-center" style="grid-column: 1 / -1; padding: 20px; color: #666;">No outstanding fees for this student</div>';
                return;
            }
            
            unpaidFeeItems.forEach(feeItem => {
                const feeItemDiv = document.createElement('div');
                feeItemDiv.className = 'fee-payment-item';
                feeItemDiv.setAttribute('data-id', feeItem.id);
                feeItemDiv.setAttribute('data-amount', feeItem.balance);
                
                let details = '';
                if (feeItem.category) details += `Category: ${feeItem.category}`;
                if (feeItem.description) details += details ? ` | ${feeItem.description}` : feeItem.description;
                
                feeItemDiv.innerHTML = `
                    <div class="fee-payment-header">
                        <div class="fee-payment-name">${feeItem.name}</div>
                        <div class="fee-payment-amount">${formatCurrency(feeItem.balance)}</div>
                    </div>
                    <div class="fee-payment-details">
                        ${details || 'No additional details'}
                        <div class="fee-progress">
                            <div class="fee-progress-bar">
                                <div class="fee-progress-fill" style="width: ${feeItem.progress}%"></div>
                            </div>
                            <div class="fee-progress-text">
                                <span>Paid: ${formatCurrency(feeItem.paidAmount)}</span>
                                <span>Balance: ${formatCurrency(feeItem.balance)}</span>
                            </div>
                        </div>
                    </div>
                    <div class="fee-payment-input">
                        <label>Amount to Pay (KES)</label>
                        <input type="number" class="fee-amount-input" 
                               data-id="${feeItem.id}" 
                               placeholder="Enter amount" 
                               min="1" 
                               max="${feeItem.balance}"
                               value="${feeItem.balance}">
                    </div>
                `;
                
                container.appendChild(feeItemDiv);
            });
            
            // Add click event to fee items
            document.querySelectorAll('.fee-payment-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    if (e.target.classList.contains('fee-amount-input')) {
                        e.stopPropagation();
                        return;
                    }
                    
                    this.classList.toggle('selected');
                    updatePaymentSummary();
                });
            });
            
            // Add input event to fee amount inputs
            document.querySelectorAll('.fee-amount-input').forEach(input => {
                input.addEventListener('input', function() {
                    const maxAmount = parseFloat(this.getAttribute('max'));
                    const currentValue = parseFloat(this.value) || 0;
                    
                    if (currentValue > maxAmount) {
                        this.value = maxAmount;
                        showWarning(`Maximum amount is ${formatCurrency(maxAmount)}`);
                    }
                    
                    updatePaymentSummary();
                });
            });
            
            updatePaymentSummary();
        }
        
        // Update payment summary
        function updatePaymentSummary() {
            let totalAmount = 0;
            
            document.querySelectorAll('.fee-payment-item.selected').forEach(item => {
                const feeItemId = item.getAttribute('data-id');
                const input = item.querySelector('.fee-amount-input');
                const amount = parseFloat(input.value) || 0;
                totalAmount += amount;
            });
            
            document.getElementById('payment-amount').value = totalAmount;
            document.getElementById('payment-total-amount').value = totalAmount;
            document.getElementById('payment-summary-total').textContent = formatCurrency(totalAmount);
        }
        
        // Add student
        function addStudent(studentData) {
            try {
                const studentId = generateStudentId();
                
                const feeCheckboxes = document.querySelectorAll('#fee-selection-grid input[type="checkbox"]:checked, #fee-selection-grid input[type="checkbox"]:disabled:checked');
                const selectedFeeItems = Array.from(feeCheckboxes).map(cb => cb.value);
                
                if (selectedFeeItems.length === 0) {
                    showError('Please select at least one fee item for the student');
                    return null;
                }
                
                const newStudent = {
                    id: studentId,
                    ...studentData,
                    feeItems: selectedFeeItems,
                    dateAdded: new Date().toISOString()
                };
                
                appData.students.push(newStudent);
                saveToLocalStorage();
                
                loadStudentsTable();
                loadFeeRegisterTable();
                updateDashboardStats();
                populateStudentDropdowns();
                populateReminderDropdowns();
                
                showSuccess(`Student ${studentData.firstName} ${studentData.lastName} added successfully`);
                return studentId;
            } catch (error) {
                console.error('Error adding student:', error);
                showError('Failed to add student');
                return null;
            }
        }
        
        // Edit student
        function editStudent(studentId, studentData) {
            try {
                const index = appData.students.findIndex(s => s.id === studentId);
                if (index !== -1) {
                    const feeCheckboxes = document.querySelectorAll('#fee-selection-grid input[type="checkbox"]:checked, #fee-selection-grid input[type="checkbox"]:disabled:checked');
                    const selectedFeeItems = Array.from(feeCheckboxes).map(cb => cb.value);
                    
                    if (selectedFeeItems.length === 0) {
                        showError('Please select at least one fee item for the student');
                        return false;
                    }
                    
                    appData.students[index] = {
                        ...appData.students[index],
                        ...studentData,
                        feeItems: selectedFeeItems
                    };
                    
                    saveToLocalStorage();
                    
                    loadStudentsTable();
                    loadFeeRegisterTable();
                    updateDashboardStats();
                    populateStudentDropdowns();
                    populateReminderDropdowns();
                    
                    showSuccess('Student updated successfully');
                    return true;
                }
                showError('Student not found');
                return false;
            } catch (error) {
                console.error('Error editing student:', error);
                showError('Failed to update student');
                return false;
            }
        }
        
        // Delete student
        function deleteStudent(studentId) {
            try {
                const index = appData.students.findIndex(s => s.id === studentId);
                if (index !== -1) {
                    const student = appData.students[index];
                    
                    const hasPayments = appData.feePayments.some(p => p.studentId === studentId);
                    if (hasPayments) {
                        showError('Cannot delete student with payment history');
                        return false;
                    }
                    
                    appData.students.splice(index, 1);
                    saveToLocalStorage();
                    
                    loadStudentsTable();
                    loadFeeRegisterTable();
                    updateDashboardStats();
                    populateStudentDropdowns();
                    populateReminderDropdowns();
                    
                    showSuccess('Student deleted successfully');
                    return true;
                }
                showError('Student not found');
                return false;
            } catch (error) {
                console.error('Error deleting student:', error);
                showError('Failed to delete student');
                return false;
            }
        }
        
        // ============================================
        // FEE REGISTER FUNCTIONS - FIXED
        // ============================================
        
        // Load fee register table with dynamic columns
        function loadFeeRegisterTable(filterClass = 'all', filterStudent = 'all') {
            const table = document.getElementById('fee-register-table');
            const tbody = document.getElementById('fee-table-body');
            const thead = document.getElementById('fee-table-header');
            const tfoot = document.getElementById('fee-table-footer');
            
            // Clear existing data
            tbody.innerHTML = '';
            tfoot.innerHTML = '';
            
            // Get active fee items for dynamic columns
            const activeFeeItems = getActiveFeeItems();
            
            // Clear existing fee item headers (keep first 5 columns and actions column)
            while (thead.children.length > 6) {
                thead.removeChild(thead.lastChild);
            }
            
            // Add dynamic fee item headers
            activeFeeItems.forEach(feeItem => {
                const th = document.createElement('th');
                th.textContent = feeItem.name;
                th.setAttribute('data-fee-id', feeItem.id);
                th.setAttribute('title', `Amount: ${formatCurrency(feeItem.amount)}`);
                // Insert before actions column (last column)
                thead.insertBefore(th, thead.lastElementChild);
            });
            
            let students = [...appData.students];
            
            if (filterClass !== 'all') {
                students = students.filter(student => student.class === filterClass);
            }
            
            if (filterStudent !== 'all') {
                students = students.filter(student => student.id === filterStudent);
            }
            
            const totals = {
                totalFees: 0,
                totalPaid: 0,
                totalBalance: 0,
                feeItems: {}
            };
            
            // Initialize fee item totals
            activeFeeItems.forEach(feeItem => {
                totals.feeItems[feeItem.id] = 0;
            });
            
            students.forEach(student => {
                const totalFees = calculateTotalFees(student);
                const totalPaid = calculateTotalPaid(student.id);
                const balance = totalFees - totalPaid;
                
                totals.totalFees += totalFees;
                totals.totalPaid += totalPaid;
                totals.totalBalance += balance;
                
                const row = document.createElement('tr');
                const cells = [
                    `<td>${student.firstName} ${student.lastName}</td>`,
                    `<td>${student.class.toUpperCase()}</td>`,
                    `<td class="currency">${formatCurrency(totalFees)}</td>`,
                    `<td class="currency">${formatCurrency(totalPaid)}</td>`,
                    `<td class="currency">${formatCurrency(balance)}</td>`
                ];
                
                // Add fee item columns
                activeFeeItems.forEach(feeItem => {
                    const paidAmount = calculatePaidForFeeItem(student.id, feeItem.id);
                    totals.feeItems[feeItem.id] += paidAmount;
                    
                    cells.push(`<td class="currency">${formatCurrency(paidAmount)}</td>`);
                });
                
                // Add actions column
                cells.push(`
                    <td class="actions">
                        <button class="btn-icon btn-info btn-small view-receipts" data-id="${student.id}">
                            <i class="fas fa-receipt"></i>
                            <span class="btn-notification"><i class="fas fa-check"></i></span>
                        </button>
                        <button class="btn-icon btn-success btn-small add-student-payment" data-id="${student.id}">
                            <i class="fas fa-plus"></i>
                            <span class="btn-notification"><i class="fas fa-check"></i></span>
                        </button>
                    </td>
                `);
                
                row.innerHTML = cells.join('');
                tbody.appendChild(row);
            });
            
            // Create footer row with totals
            const footerRow = document.createElement('tr');
            footerRow.style.backgroundColor = '#f8f9fa';
            footerRow.style.fontWeight = 'bold';
            
            const footerCells = [
                '<td colspan="2">TOTALS</td>',
                `<td class="currency">${formatCurrency(totals.totalFees)}</td>`,
                `<td class="currency">${formatCurrency(totals.totalPaid)}</td>`,
                `<td class="currency">${formatCurrency(totals.totalBalance)}</td>`
            ];
            
            // Add fee item totals
            activeFeeItems.forEach(feeItem => {
                footerCells.push(`<td class="currency">${formatCurrency(totals.feeItems[feeItem.id])}</td>`);
            });
            
            // Add empty cell for actions column
            footerCells.push('<td></td>');
            
            footerRow.innerHTML = footerCells.join('');
            tfoot.appendChild(footerRow);
            
            document.getElementById('fee-grand-total').textContent = formatCurrency(totals.totalPaid);
            addFeeRegisterActionListeners();
        }
        
        // Add fee payment for multiple fee items
        function addFeePayment(paymentData) {
            try {
                const receiptNo = generateReceiptNo();
                const studentId = paymentData.studentId;
                const selectedFeeItems = paymentData.selectedFeeItems || [];
                
                if (selectedFeeItems.length === 0) {
                    showError('Please select at least one fee item to pay');
                    return null;
                }
                
                // Create individual payments for each selected fee item
                const paymentIds = [];
                let totalAmount = 0;
                
                selectedFeeItems.forEach(item => {
                    const newPayment = {
                        id: generateId(),
                        receiptNo: receiptNo,
                        studentId: studentId,
                        feeItemId: item.feeItemId,
                        amount: parseFloat(item.amount),
                        date: paymentData.date || getCurrentDate(),
                        paymentMethod: paymentData.paymentMethod,
                        reference: paymentData.reference,
                        notes: paymentData.notes,
                        recordedBy: 'Admin',
                        timestamp: new Date().toISOString()
                    };
                    
                    appData.feePayments.push(newPayment);
                    paymentIds.push(newPayment.id);
                    totalAmount += newPayment.amount;
                });
                
                saveToLocalStorage();
                
                updateDashboardStats();
                loadFeeRegisterTable();
                loadStudentsTable();
                loadFeeReminders();
                
                generateReceipt({
                    receiptNo: receiptNo,
                    studentId: studentId,
                    date: paymentData.date,
                    paymentMethod: paymentData.paymentMethod,
                    reference: paymentData.reference,
                    notes: paymentData.notes,
                    selectedFeeItems: selectedFeeItems,
                    totalAmount: totalAmount
                });
                
                showSuccess(`Payment of ${formatCurrency(totalAmount)} recorded successfully for ${selectedFeeItems.length} fee item(s)`);
                return paymentIds;
            } catch (error) {
                console.error('Error adding fee payment:', error);
                showError('Failed to record payment');
                return null;
            }
        }
        
        // Generate receipt
        function generateReceipt(payment) {
            try {
                const student = appData.students.find(s => s.id === payment.studentId);
                
                if (!student) {
                    showError('Student not found');
                    return;
                }
                
                const logoHtml = appData.settings.schoolLogo ? 
                    `<img src="${appData.settings.schoolLogo}" class="receipt-logo" alt="School Logo">` :
                    `<div class="receipt-logo" style="background-color: var(--primary-color); color: white; display: flex; align-items: center; justify-content: center; border-radius: 50%;">
                        <i class="fas fa-school" style="font-size: 3rem;"></i>
                    </div>`;
                
                let feeItemsHTML = '';
                let totalAmount = 0;
                
                payment.selectedFeeItems.forEach(item => {
                    const feeItem = appData.feeItems.find(f => f.id === item.feeItemId);
                    if (feeItem) {
                        feeItemsHTML += `
                            <tr>
                                <td>${feeItem.name}</td>
                                <td class="currency">${formatCurrency(item.amount)}</td>
                            </tr>
                        `;
                        totalAmount += parseFloat(item.amount);
                    }
                });
                
                const receiptContent = document.getElementById('receipt-content');
                receiptContent.innerHTML = `
                    <div class="receipt-container">
                        <div class="receipt-header">
                            ${logoHtml}
                            <h2 style="color: var(--primary-color); margin: 10px 0;">${appData.settings.schoolName}</h2>
                            <p>${appData.settings.schoolAddress}</p>
                            <p>Tel: ${appData.settings.schoolPhone} | Email: ${appData.settings.schoolEmail}</p>
                            <h3 style="margin-top: 20px; border-top: 2px solid var(--primary-color); padding-top: 10px;">OFFICIAL PAYMENT RECEIPT</h3>
                        </div>
                        
                        <div class="receipt-details">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                                <div>
                                    <strong>Receipt No:</strong> ${payment.receiptNo}<br>
                                    <strong>Date:</strong> ${formatDate(payment.date)}
                                </div>
                                <div>
                                    <strong>Student ID:</strong> ${student.id}<br>
                                    <strong>Class:</strong> ${student.class.toUpperCase()}
                                </div>
                            </div>
                            
                            <div>
                                <strong>Student:</strong> ${student.firstName} ${student.lastName}<br>
                                <strong>Parent/Guardian:</strong> ${student.parentName}<br>
                                <strong>Contact:</strong> ${student.parentPhone}
                            </div>
                        </div>
                        
                        <table class="receipt-table">
                            <thead>
                                <tr>
                                    <th>Description</th>
                                    <th>Amount (KES)</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${feeItemsHTML}
                                <tr>
                                    <td colspan="2" style="text-align: right; padding-top: 20px;">
                                        <strong>Payment Method:</strong> ${payment.paymentMethod}<br>
                                        ${payment.reference ? `<strong>Reference:</strong> ${payment.reference}<br>` : ''}
                                        ${payment.notes ? `<strong>Notes:</strong> ${payment.notes}` : ''}
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        
                        <div class="receipt-totals">
                            <div style="font-size: 1.2rem; color: var(--success-color);">
                                TOTAL AMOUNT PAID: ${formatCurrency(totalAmount)}
                            </div>
                            <div style="margin-top: 10px; font-size: 1.5rem; font-weight: bold;">
                                ${formatCurrency(totalAmount)}
                            </div>
                        </div>
                        
                        <div class="receipt-footer">
                            <div>Thank you for your payment</div>
                            <div style="margin-top: 10px;">
                                <strong>Received by:</strong> Admin<br>
                                <strong>Date & Time:</strong> ${formatDate(new Date())} ${new Date().toLocaleTimeString()}
                            </div>
                            <div style="margin-top: 20px; font-size: 0.8rem; color: #999;">
                                Generated by Edu-Track CBE Pro Fees Management System
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('receipt-modal').classList.add('active');
            } catch (error) {
                console.error('Error generating receipt:', error);
                showError('Failed to generate receipt');
            }
        }
        
        // Generate reminder receipt
        function generateReminderReceipt(studentId) {
            try {
                const student = appData.students.find(s => s.id === studentId);
                if (!student) {
                    showError('Student not found');
                    return;
                }
                
                const totalFees = calculateTotalFees(student);
                const totalPaid = calculateTotalPaid(studentId);
                const balance = totalFees - totalPaid;
                
                const feeBalances = [];
                let hasOverdue = false;
                let totalOverdue = 0;
                
                student.feeItems.forEach(feeItemId => {
                    const feeItem = appData.feeItems.find(f => f.id === feeItemId);
                    if (feeItem) {
                        const paidAmount = calculatePaidForFeeItem(studentId, feeItemId);
                        const feeBalance = feeItem.amount - paidAmount;
                        
                        if (feeBalance > 0) {
                            const dueDate = calculateDueDate(student, feeItemId);
                            const overdue = dueDate && isFeeOverdue(dueDate);
                            const daysRemaining = dueDate ? calculateDaysRemaining(dueDate) : null;
                            
                            if (overdue) {
                                hasOverdue = true;
                                totalOverdue += feeBalance;
                            }
                            
                            feeBalances.push({
                                name: feeItem.name,
                                amount: feeItem.amount,
                                paid: paidAmount,
                                balance: feeBalance,
                                dueDate: dueDate,
                                overdue: overdue,
                                daysRemaining: daysRemaining
                            });
                        }
                    }
                });
                
                if (feeBalances.length === 0) {
                    showInfo('No outstanding fees for this student');
                    return;
                }
                
                const logoHtml = appData.settings.schoolLogo ? 
                    `<img src="${appData.settings.schoolLogo}" class="receipt-logo" alt="School Logo">` :
                    `<div class="receipt-logo" style="background-color: var(--primary-color); color: white; display: flex; align-items: center; justify-content: center; border-radius: 50%;">
                        <i class="fas fa-school" style="font-size: 3rem;"></i>
                    </div>`;
                
                let feeItemsHTML = '';
                feeBalances.forEach(fee => {
                    let statusText = '';
                    if (fee.overdue) {
                        statusText = `<span style="color: var(--danger-color); font-weight: bold;">OVERDUE</span>`;
                    } else if (fee.daysRemaining !== null && fee.daysRemaining <= 7) {
                        statusText = `<span style="color: var(--warning-color); font-weight: bold;">DUE IN ${fee.daysRemaining} DAYS</span>`;
                    }
                    
                    feeItemsHTML += `
                        <tr>
                            <td>${fee.name}</td>
                            <td class="currency">${formatCurrency(fee.amount)}</td>
                            <td class="currency">${formatCurrency(fee.paid)}</td>
                            <td class="currency">${formatCurrency(fee.balance)}</td>
                            <td>${fee.dueDate ? formatDate(fee.dueDate) : 'N/A'} ${statusText}</td>
                        </tr>
                    `;
                });
                
                const reminderClass = hasOverdue ? 'overdue' : '';
                const messageClass = hasOverdue ? 'overdue' : '';
                
                const reminderMessage = hasOverdue ? 
                    `URGENT REMINDER: Your child has OVERDUE fees totaling ${formatCurrency(totalOverdue)}. Please clear the balance immediately to avoid inconveniences.` :
                    `Gentle reminder: Your child has outstanding fees totaling ${formatCurrency(balance)}. Kindly clear the balance by the due dates to avoid late payment penalties.`;
                
                const reminderContent = document.getElementById('reminder-receipt-content');
                reminderContent.innerHTML = `
                    <div class="reminder-receipt ${reminderClass}">
                        <div class="reminder-receipt-header">
                            ${logoHtml}
                            <h2 style="color: var(--primary-color); margin: 10px 0;">${appData.settings.schoolName}</h2>
                            <p>${appData.settings.schoolAddress}</p>
                            <p>Tel: ${appData.settings.schoolPhone} | Email: ${appData.settings.schoolEmail}</p>
                            <h3 style="margin-top: 20px; border-top: 2px solid var(--primary-color); padding-top: 10px;">FEE REMINDER NOTICE</h3>
                            <p style="margin-top: 10px; font-weight: bold;">Date: ${formatDate(new Date())}</p>
                        </div>
                        
                        <div class="receipt-details">
                            <div style="margin-bottom: 15px;">
                                <strong>Student:</strong> ${student.firstName} ${student.lastName}<br>
                                <strong>Student ID:</strong> ${student.id}<br>
                                <strong>Class:</strong> ${student.class.toUpperCase()}
                            </div>
                            
                            <div>
                                <strong>Parent/Guardian:</strong> ${student.parentName}<br>
                                <strong>Contact:</strong> ${student.parentPhone}<br>
                                ${student.parentEmail ? `<strong>Email:</strong> ${student.parentEmail}<br>` : ''}
                                ${student.parentAddress ? `<strong>Address:</strong> ${student.parentAddress}` : ''}
                            </div>
                            
                            <div style="margin-top: 15px; padding: 10px; background-color: white; border-radius: var(--border-radius);">
                                <div style="display: flex; justify-content: space-between;">
                                    <div>
                                        <strong>Total Fees:</strong> <span class="currency">${formatCurrency(totalFees)}</span>
                                    </div>
                                    <div>
                                        <strong>Total Paid:</strong> <span class="currency">${formatCurrency(totalPaid)}</span>
                                    </div>
                                    <div>
                                        <strong>Total Balance:</strong> <span class="currency">${formatCurrency(balance)}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="reminder-message-box ${messageClass}">
                            <h4 style="margin-bottom: 10px; color: var(--primary-color);">MESSAGE TO PARENT/GUARDIAN:</h4>
                            <p style="line-height: 1.6;">
                                Dear ${student.parentName},<br><br>
                                ${reminderMessage}<br><br>
                                Please visit the school accounts office or use our approved payment methods to clear the outstanding balance. 
                                For any queries or payment arrangements, please contact the accounts department.<br><br>
                                Thank you for your cooperation.
                            </p>
                        </div>
                        
                        <h4 style="margin: 20px 0 10px 0; color: var(--primary-color);">OUTSTANDING FEE DETAILS:</h4>
                        <table class="receipt-table">
                            <thead>
                                <tr>
                                    <th>Fee Item</th>
                                    <th>Total Amount</th>
                                    <th>Amount Paid</th>
                                    <th>Balance Due</th>
                                    <th>Due Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${feeItemsHTML}
                            </tbody>
                        </table>
                        
                        <div class="receipt-footer">
                            <div style="margin-top: 20px;">
                                <strong>Bank Details:</strong><br>
                                Bank: Kenya Commercial Bank<br>
                                Account Name: ${appData.settings.schoolName}<br>
                                Account Number: 1234567890<br>
                                Branch: Nairobi Main Branch
                            </div>
                            <div style="margin-top: 20px; font-size: 0.8rem; color: #999;">
                                This is a computer-generated reminder. Please ignore if payment has already been made.<br>
                                Generated by Edu-Track CBE Pro Fees Management System
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('reminder-receipt-modal').classList.add('active');
                
                // Set up email button
                document.getElementById('send-reminder-email-btn').onclick = function() {
                    sendReminderEmail(student, feeBalances, totalFees, totalPaid, balance, hasOverdue, totalOverdue);
                };
                
            } catch (error) {
                console.error('Error generating reminder receipt:', error);
                showError('Failed to generate reminder receipt');
            }
        }
        
        // Send reminder email
        function sendReminderEmail(student, feeBalances, totalFees, totalPaid, balance, hasOverdue, totalOverdue) {
            try {
                if (!student.parentEmail) {
                    showError('No email address found for this parent');
                    return;
                }
                
                const subject = `Fee Reminder for ${student.firstName} ${student.lastName} - ${appData.settings.schoolName}`;
                
                let feeDetails = '';
                feeBalances.forEach(fee => {
                    let status = '';
                    if (fee.overdue) {
                        status = ' (OVERDUE!)';
                    } else if (fee.daysRemaining !== null && fee.daysRemaining <= 7) {
                        status = ` (Due in ${fee.daysRemaining} days)`;
                    }
                    
                    feeDetails += ` ${fee.name}: ${formatCurrency(fee.amount)} | Paid: ${formatCurrency(fee.paid)} | Balance: ${formatCurrency(fee.balance)} | Due: ${fee.dueDate ? formatDate(fee.dueDate) : 'N/A'}${status}\n`;
                });
                
                const body = `Dear ${student.parentName},\n\n` +
                            `This is a fee reminder notice for your child ${student.firstName} ${student.lastName} (${student.class.toUpperCase()}).\n\n` +
                            `SUMMARY:\n` +
                            `Total Fees: ${formatCurrency(totalFees)}\n` +
                            `Total Paid: ${formatCurrency(totalPaid)}\n` +
                            `Total Balance: ${formatCurrency(balance)}\n` +
                            `${hasOverdue ? `OVERDUE AMOUNT: ${formatCurrency(totalOverdue)}\n\n` : '\n'}` +
                            `DETAILED BREAKDOWN:\n${feeDetails}\n` +
                            `MESSAGE:\n` +
                            `${hasOverdue ? 
                                `URGENT REMINDER: Your child has OVERDUE fees totaling ${formatCurrency(totalOverdue)}. Please clear the balance immediately to avoid inconveniences.` :
                                `Gentle reminder: Your child has outstanding fees totaling ${formatCurrency(balance)}. Kindly clear the balance by the due dates to avoid late payment penalties.`}\n\n` +
                            `PAYMENT METHODS:\n` +
                            `1. Cash payment at school accounts office\n` +
                            `2. M-Pesa Paybill: 123456\n` +
                            `3. Bank Transfer:\n` +
                            `   Bank: Kenya Commercial Bank\n` +
                            `   Account: ${appData.settings.schoolName}\n` +
                            `   Account No: 1234567890\n\n` +
                            `For any queries, please contact the accounts office at ${appData.settings.schoolPhone}.\n\n` +
                            `Thank you for your cooperation.\n\n` +
                            `Sincerely,\n` +
                            `${appData.settings.schoolName}\n` +
                            `${appData.settings.schoolAddress}\n` +
                            `Tel: ${appData.settings.schoolPhone}\n` +
                            `Email: ${appData.settings.schoolEmail}`;
                
                const mailtoLink = `mailto:${student.parentEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                window.open(mailtoLink, '_blank');
                
                showInfo(`Email prepared for: ${student.parentEmail}`);
                
                const button = document.getElementById('send-reminder-email-btn');
                showButtonNotification(button, true, 'Email prepared');
                
            } catch (error) {
                console.error('Error sending reminder email:', error);
                showError('Failed to prepare email');
                const button = document.getElementById('send-reminder-email-btn');
                showButtonNotification(button, false, 'Failed to prepare email');
            }
        }
        
        // ============================================
        // FEE REMINDERS FUNCTIONS
        // ============================================
        
        // Load fee reminders
        function loadFeeReminders(filterClass = 'all', filterStudent = 'all', filterStatus = 'all') {
            const container = document.getElementById('reminders-container');
            let students = [...appData.students];
            
            if (filterClass !== 'all') {
                students = students.filter(student => student.class === filterClass);
            }
            
            if (filterStudent !== 'all') {
                students = students.filter(student => student.id === filterStudent);
            }
            
            container.innerHTML = '';
            
            let hasReminders = false;
            
            students.forEach(student => {
                const totalFees = calculateTotalFees(student);
                const totalPaid = calculateTotalPaid(student.id);
                const balance = totalFees - totalPaid;
                
                if (balance <= 0 && filterStatus !== 'paid') {
                    return;
                }
                
                const feeBalances = [];
                let hasOverdue = false;
                let totalOverdue = 0;
                
                student.feeItems.forEach(feeItemId => {
                    const feeItem = appData.feeItems.find(f => f.id === feeItemId);
                    if (feeItem) {
                        const paidAmount = calculatePaidForFeeItem(student.id, feeItemId);
                        const feeBalance = feeItem.amount - paidAmount;
                        
                        if (feeBalance > 0) {
                            const dueDate = calculateDueDate(student, feeItemId);
                            const overdue = dueDate && isFeeOverdue(dueDate);
                            const dueSoon = dueDate && new Date(dueDate) - new Date() <= 7 * 24 * 60 * 60 * 1000;
                            
                            if (overdue) {
                                hasOverdue = true;
                                totalOverdue += feeBalance;
                            }
                            
                            if (filterStatus === 'overdue' && !overdue) return;
                            if (filterStatus === 'due_soon' && !dueSoon) return;
                            if (filterStatus === 'paid' && feeBalance > 0) return;
                            
                            feeBalances.push({
                                name: feeItem.name,
                                amount: feeItem.amount,
                                paid: paidAmount,
                                balance: feeBalance,
                                dueDate: dueDate,
                                overdue: overdue,
                                dueSoon: dueSoon
                            });
                        }
                    }
                });
                
                if (feeBalances.length === 0 && filterStatus !== 'paid') return;
                
                hasReminders = true;
                
                const reminderCard = document.createElement('div');
                reminderCard.className = `reminder-card ${hasOverdue ? 'overdue' : ''}`;
                
                let feeBalanceHTML = '';
                feeBalances.forEach(fee => {
                    let statusBadge = '';
                    if (fee.overdue) {
                        statusBadge = '<span class="badge badge-danger" style="margin-left: 10px;">OVERDUE</span>';
                    } else if (fee.dueSoon) {
                        statusBadge = '<span class="badge badge-warning" style="margin-left: 10px;">DUE SOON</span>';
                    }
                    
                    feeBalanceHTML += `
                        <div class="fee-balance-item">
                            <div>
                                <strong>${fee.name}</strong><br>
                                <small>Due: ${fee.dueDate ? formatDate(fee.dueDate) : 'N/A'} ${statusBadge}</small>
                            </div>
                            <div style="text-align: right;">
                                <div>Amount: <span class="currency">${formatCurrency(fee.amount)}</span></div>
                                <div>Paid: <span class="currency">${formatCurrency(fee.paid)}</span></div>
                                <div>Balance: <span class="currency">${formatCurrency(fee.balance)}</span></div>
                            </div>
                        </div>
                    `;
                });
                
                reminderCard.innerHTML = `
                    <div class="reminder-header">
                        <div class="reminder-student">
                            <strong>${student.firstName} ${student.lastName} (${student.class.toUpperCase()})</strong><br>
                            Parent: ${student.parentName} | Phone: ${student.parentPhone}
                            ${student.parentEmail ? `| Email: ${student.parentEmail}` : ''}
                        </div>
                        <div class="reminder-amount">
                            Total Fees: <span class="currency">${formatCurrency(totalFees)}</span><br>
                            Paid: <span class="currency">${formatCurrency(totalPaid)}</span><br>
                            Balance: <span class="currency">${formatCurrency(balance)}</span><br>
                            ${hasOverdue ? `Overdue: <span class="currency" style="color: var(--danger-color);">${formatCurrency(totalOverdue)}</span>` : ''}
                        </div>
                    </div>
                    
                    <div class="fee-balance-details">
                        <h4 style="margin-bottom: 10px; color: var(--primary-color);">Outstanding Fee Items:</h4>
                        ${feeBalanceHTML}
                    </div>
                    
                    <div class="reminder-message">
                        <strong>Reminder Message:</strong><br>
                        Dear Parent/Guardian,<br><br>
                        This is to remind you that your child <strong>${student.firstName} ${student.lastName}</strong> 
                        has ${hasOverdue ? `<strong>OVERDUE fees of ${formatCurrency(totalOverdue)}</strong>` : `outstanding fees totaling ${formatCurrency(balance)}`}.<br><br>
                        Kindly clear the balance at your earliest convenience to avoid inconveniences. 
                        Contact the accounts office for any clarification.<br><br>
                        Thank you.
                    </div>
                    <div class="actions">
                        <button class="btn-icon btn-info btn-small view-reminder-receipt" data-id="${student.id}">
                            <i class="fas fa-file-invoice"></i> View Reminder
                            <span class="btn-notification"><i class="fas fa-check"></i></span>
                        </button>
                        <button class="btn-icon btn-success btn-small send-email" data-id="${student.id}">
                            <i class="fas fa-envelope"></i> Email
                            <span class="btn-notification"><i class="fas fa-check"></i></span>
                        </button>
                        <button class="btn-icon btn-success btn-small send-sms" data-id="${student.id}">
                            <i class="fas fa-sms"></i> SMS
                            <span class="btn-notification"><i class="fas fa-check"></i></span>
                        </button>
                        <button class="btn-icon btn-secondary btn-small print-reminder" data-id="${student.id}">
                            <i class="fas fa-print"></i> Print
                            <span class="btn-notification"><i class="fas fa-check"></i></span>
                        </button>
                        <button class="btn-icon btn-success btn-small add-payment" data-id="${student.id}">
                            <i class="fas fa-money-bill-wave"></i> Add Payment
                            <span class="btn-notification"><i class="fas fa-check"></i></span>
                        </button>
                    </div>
                `;
                container.appendChild(reminderCard);
            });
            
            if (!hasReminders) {
                container.innerHTML = '<div class="text-center" style="padding: 40px; color: #666; background-color: white; border-radius: var(--border-radius);"><i class="fas fa-check-circle" style="font-size: 3rem; color: var(--success-color); margin-bottom: 15px;"></i><h3>No Fee Reminders</h3><p>All fees are up to date!</p></div>';
            }
            
            addReminderActionListeners();
        }
        
        // ============================================
        // FEE SETTING FUNCTIONS
        // ============================================
        
        // Load fee items list
        function loadFeeItemsList() {
            const container = document.getElementById('fee-items-list');
            container.innerHTML = '';
            
            appData.feeItems.forEach(feeItem => {
                const card = document.createElement('div');
                card.className = `fee-item-card ${feeItem.isRequired ? 'required' : ''} ${!feeItem.active ? 'inactive' : ''}`;
                card.setAttribute('data-id', feeItem.id);
                
                let categoryBadge = '';
                switch(feeItem.category) {
                    case 'tuition': categoryBadge = '<span class="badge badge-primary">Tuition</span>'; break;
                    case 'admission': categoryBadge = '<span class="badge badge-info">Admission</span>'; break;
                    case 'activity': categoryBadge = '<span class="badge badge-success">Activity</span>'; break;
                    case 'uniform': categoryBadge = '<span class="badge badge-warning">Uniform</span>'; break;
                    default: categoryBadge = '<span class="badge badge-secondary">Other</span>';
                }
                
                let termBadge = '';
                switch(feeItem.term) {
                    case 'term1': termBadge = '<span class="badge badge-info">Term 1</span>'; break;
                    case 'term2': termBadge = '<span class="badge badge-info">Term 2</span>'; break;
                    case 'term3': termBadge = '<span class="badge badge-info">Term 3</span>'; break;
                    default: termBadge = '<span class="badge badge-primary">All Terms</span>';
                }
                
                card.innerHTML = `
                    <div class="fee-item-header">
                        <div class="fee-item-name">${feeItem.name}</div>
                        <div class="fee-item-amount">${formatCurrency(feeItem.amount)}</div>
                    </div>
                    <div class="fee-item-status">
                        ${feeItem.isRequired ? '<span class="badge badge-danger">Required</span>' : '<span class="badge badge-secondary">Optional</span>'}
                        ${categoryBadge}
                        ${termBadge}
                        ${feeItem.active ? '<span class="badge badge-success">Active</span>' : '<span class="badge badge-secondary">Inactive</span>'}
                        ${feeItem.dueDays ? `<span class="badge badge-warning">Due in ${feeItem.dueDays} days</span>` : ''}
                    </div>
                    <div class="fee-item-details">
                        ${feeItem.description || 'No description provided'}
                    </div>
                    <div class="fee-item-actions">
                        <button class="btn-icon btn-secondary btn-small edit-fee-item" data-id="${feeItem.id}">
                            <i class="fas fa-edit"></i> Edit
                            <span class="btn-notification"><i class="fas fa-check"></i></span>
                        </button>
                        <button class="btn-icon btn-danger btn-small delete-fee-item" data-id="${feeItem.id}">
                            <i class="fas fa-trash"></i> Delete
                            <span class="btn-notification"><i class="fas fa-times"></i></span>
                        </button>
                    </div>
                `;
                container.appendChild(card);
            });
            
            addFeeItemActionListeners();
        }
        
        // Add/edit fee item
        function saveFeeItem(feeItemData) {
            try {
                const feeItemId = document.getElementById('fee-item-id').value;
                
                if (feeItemId) {
                    // Edit existing fee item
                    const index = appData.feeItems.findIndex(f => f.id === feeItemId);
                    if (index !== -1) {
                        appData.feeItems[index] = {
                            ...appData.feeItems[index],
                            ...feeItemData
                        };
                        showSuccess('Fee item updated successfully');
                    }
                } else {
                    // Add new fee item
                    const newFeeItem = {
                        id: generateId(),
                        ...feeItemData
                    };
                    appData.feeItems.push(newFeeItem);
                    showSuccess('Fee item added successfully');
                }
                
                saveToLocalStorage();
                loadFeeItemsList();
                loadFeeSelection();
                loadFeeRegisterTable();
                
                document.getElementById('fee-item-form-container').classList.remove('active');
                document.getElementById('fee-item-form').reset();
                document.getElementById('fee-item-id').value = '';
                
                return true;
            } catch (error) {
                console.error('Error saving fee item:', error);
                showError('Failed to save fee item');
                return false;
            }
        }
        
        // Delete fee item
        function deleteFeeItem(feeItemId) {
            try {
                // Check if fee item is used by any student
                const isUsed = appData.students.some(student => 
                    student.feeItems.includes(feeItemId)
                );
                
                if (isUsed) {
                    showError('Cannot delete fee item that is assigned to students');
                    return false;
                }
                
                const index = appData.feeItems.findIndex(f => f.id === feeItemId);
                if (index !== -1) {
                    appData.feeItems.splice(index, 1);
                    saveToLocalStorage();
                    loadFeeItemsList();
                    loadFeeSelection();
                    loadFeeRegisterTable();
                    showSuccess('Fee item deleted successfully');
                    return true;
                }
                showError('Fee item not found');
                return false;
            } catch (error) {
                console.error('Error deleting fee item:', error);
                showError('Failed to delete fee item');
                return false;
            }
        }
        
        // ============================================
        // APP SETTING FUNCTIONS
        // ============================================
        
        // Load app settings
        function loadAppSettings() {
            document.getElementById('school-name').value = appData.settings.schoolName;
            document.getElementById('school-address').value = appData.settings.schoolAddress;
            document.getElementById('school-phone').value = appData.settings.schoolPhone;
            document.getElementById('school-email').value = appData.settings.schoolEmail;
            document.getElementById('school-logo').value = appData.settings.schoolLogo;
            
            // Update print header
            document.getElementById('print-school-name').textContent = appData.settings.schoolName;
            document.getElementById('print-school-address').textContent = appData.settings.schoolAddress;
            document.getElementById('print-school-contact').textContent = `Tel: ${appData.settings.schoolPhone} | Email: ${appData.settings.schoolEmail}`;
            
            if (appData.settings.schoolLogo) {
                document.getElementById('logo-preview').innerHTML = `<img src="${appData.settings.schoolLogo}" class="school-logo-display" alt="School Logo">`;
                document.getElementById('print-logo').src = appData.settings.schoolLogo;
            }
        }
        
        // Save app settings
        function saveAppSettings() {
            try {
                appData.settings.schoolName = document.getElementById('school-name').value;
                appData.settings.schoolAddress = document.getElementById('school-address').value;
                appData.settings.schoolPhone = document.getElementById('school-phone').value;
                appData.settings.schoolEmail = document.getElementById('school-email').value;
                appData.settings.schoolLogo = document.getElementById('school-logo').value;
                
                saveToLocalStorage();
                loadAppSettings();
                showSuccess('Application settings saved successfully');
                return true;
            } catch (error) {
                console.error('Error saving app settings:', error);
                showError('Failed to save application settings');
                return false;
            }
        }
        
        // ============================================
        // DATA MANAGEMENT FUNCTIONS
        // ============================================
        
        // Load cloud settings
        function loadCloudSettings() {
            document.getElementById('google-sheet-id').value = appData.settings.cloudSettings.googleSheetId || '';
            document.getElementById('web-app-url').value = appData.settings.cloudSettings.webAppUrl || APP_CONFIG.GOOGLE_SHEET_API;
        }
        
        // Save cloud settings
        function saveCloudSettings() {
            try {
                appData.settings.cloudSettings.googleSheetId = document.getElementById('google-sheet-id').value;
                appData.settings.cloudSettings.webAppUrl = document.getElementById('web-app-url').value || APP_CONFIG.GOOGLE_SHEET_API;
                
                saveToLocalStorage();
                updateSyncStatus();
                showSuccess('Cloud settings saved successfully');
                return true;
            } catch (error) {
                console.error('Error saving cloud settings:', error);
                showError('Failed to save cloud settings');
                return false;
            }
        }
        
        // Export data to JSON
        function exportDataToJson() {
            try {
                const dataStr = JSON.stringify(appData, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const exportFileDefaultName = `edutrack-backup-${new Date().toISOString().split('T')[0]}.json`;
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
                
                showSuccess('Data exported successfully');
                return true;
            } catch (error) {
                console.error('Error exporting data:', error);
                showError('Failed to export data');
                return false;
            }
        }
        
        // Import data from JSON
        function importDataFromJson(file) {
            try {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        
                        // Validate imported data structure
                        if (!importedData.students || !importedData.feePayments || !importedData.feeItems) {
                            showError('Invalid data file format');
                            return;
                        }
                        
                        appData = importedData;
                        saveToLocalStorage();
                        initializeUI();
                        showSuccess('Data imported successfully');
                    } catch (error) {
                        console.error('Error parsing imported data:', error);
                        showError('Invalid data file');
                    }
                };
                
                reader.readAsText(file);
                return true;
            } catch (error) {
                console.error('Error importing data:', error);
                showError('Failed to import data');
                return false;
            }
        }
        
        // Clear all data
        function clearAllData() {
            try {
                appData = {
                    students: [],
                    feePayments: [],
                    feeItems: DEFAULT_FEE_ITEMS,
                    settings: {
                        schoolName: 'Edu-Track Academy',
                        schoolAddress: 'P.O. Box 12345, Nairobi, Kenya',
                        schoolPhone: '+254 712 345 678',
                        schoolEmail: 'info@edutrack.ac.ke',
                        schoolLogo: '',
                        cloudSettings: {
                            googleSheetId: '',
                            webAppUrl: APP_CONFIG.GOOGLE_SHEET_API
                        }
                    },
                    lastBackup: null,
                    lastSync: null
                };
                
                saveToLocalStorage();
                initializeUI();
                showSuccess('All data cleared successfully');
                return true;
            } catch (error) {
                console.error('Error clearing data:', error);
                showError('Failed to clear data');
                return false;
            }
        }
        
        // ============================================
        // UI INITIALIZATION FUNCTIONS
        // ============================================
        
        // Initialize UI
        function initializeUI() {
            // Update current date
            const now = new Date();
            document.getElementById('current-date').textContent = now.toLocaleDateString('en-GB', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            document.getElementById('print-current-date').textContent = now.toLocaleDateString('en-GB', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            document.getElementById('print-date').textContent = formatDate(now);
            
            // Load settings
            loadAppSettings();
            loadCloudSettings();
            
            // Load data
            loadFeeItemsList();
            loadStudentsTable();
            loadFeeRegisterTable();
            loadFeeReminders();
            
            // Update dashboard
            updateDashboardStats();
            
            // Populate dropdowns
            populateStudentDropdowns();
            populateReminderDropdowns();
            
            // Set default dates
            document.getElementById('payment-date').value = getCurrentDate();
            document.getElementById('student-dob').value = getCurrentDate();
        }
        
        // Populate student dropdowns
        function populateStudentDropdowns() {
            const studentSelects = [
                document.getElementById('fee-student-filter'),
                document.getElementById('reminder-student-filter'),
                document.getElementById('payment-student')
            ];
            
            studentSelects.forEach(select => {
                if (!select) return;
                
                const currentValue = select.value;
                select.innerHTML = '<option value="all">All Students</option>';
                
                appData.students.forEach(student => {
                    const option = document.createElement('option');
                    option.value = student.id;
                    option.textContent = `${student.firstName} ${student.lastName} (${student.class.toUpperCase()})`;
                    select.appendChild(option);
                });
                
                if (currentValue) {
                    select.value = currentValue;
                }
            });
        }
        
        // Populate reminder dropdowns
        function populateReminderDropdowns() {
            const studentSelect = document.getElementById('reminder-student-filter');
            if (studentSelect) {
                const currentValue = studentSelect.value;
                studentSelect.innerHTML = '<option value="all">All Students</option>';
                
                appData.students.forEach(student => {
                    const option = document.createElement('option');
                    option.value = student.id;
                    option.textContent = `${student.firstName} ${student.lastName} (${student.class.toUpperCase()})`;
                    studentSelect.appendChild(option);
                });
                
                if (currentValue) {
                    studentSelect.value = currentValue;
                }
            }
        }
        
        // ============================================
        // EVENT LISTENER SETUP FUNCTIONS
        // ============================================
        
        // Add student action listeners
        function addStudentActionListeners() {
            document.querySelectorAll('.view-student').forEach(button => {
                button.addEventListener('click', function() {
                    const studentId = this.getAttribute('data-id');
                    viewStudent(studentId);
                });
            });
            
            document.querySelectorAll('.edit-student').forEach(button => {
                button.addEventListener('click', function() {
                    const studentId = this.getAttribute('data-id');
                    editStudentModal(studentId);
                });
            });
            
            document.querySelectorAll('.add-payment').forEach(button => {
                button.addEventListener('click', function() {
                    const studentId = this.getAttribute('data-id');
                    addPaymentForStudent(studentId);
                });
            });
            
            document.querySelectorAll('.delete-student').forEach(button => {
                button.addEventListener('click', function() {
                    const studentId = this.getAttribute('data-id');
                    deleteStudentConfirmation(studentId);
                });
            });
        }
        
        // Add fee register action listeners
        function addFeeRegisterActionListeners() {
            document.querySelectorAll('.view-receipts').forEach(button => {
                button.addEventListener('click', function() {
                    const studentId = this.getAttribute('data-id');
                    viewStudentReceipts(studentId);
                });
            });
            
            document.querySelectorAll('.add-student-payment').forEach(button => {
                button.addEventListener('click', function() {
                    const studentId = this.getAttribute('data-id');
                    addPaymentForStudent(studentId);
                });
            });
        }
        
        // Add fee item action listeners
        function addFeeItemActionListeners() {
            document.querySelectorAll('.edit-fee-item').forEach(button => {
                button.addEventListener('click', function() {
                    const feeItemId = this.getAttribute('data-id');
                    editFeeItem(feeItemId);
                });
            });
            
            document.querySelectorAll('.delete-fee-item').forEach(button => {
                button.addEventListener('click', function() {
                    const feeItemId = this.getAttribute('data-id');
                    deleteFeeItemConfirmation(feeItemId);
                });
            });
        }
        
        // Add reminder action listeners
        function addReminderActionListeners() {
            document.querySelectorAll('.view-reminder-receipt').forEach(button => {
                button.addEventListener('click', function() {
                    const studentId = this.getAttribute('data-id');
                    generateReminderReceipt(studentId);
                });
            });
            
            document.querySelectorAll('.send-email').forEach(button => {
                button.addEventListener('click', function() {
                    const studentId = this.getAttribute('data-id');
                    const student = appData.students.find(s => s.id === studentId);
                    if (student && student.parentEmail) {
                        generateReminderReceipt(studentId);
                        setTimeout(() => {
                            document.getElementById('send-reminder-email-btn').click();
                        }, 500);
                    } else {
                        showError('No email address found for this parent');
                    }
                });
            });
            
            document.querySelectorAll('.send-sms').forEach(button => {
                button.addEventListener('click', function() {
                    const studentId = this.getAttribute('data-id');
                    const student = appData.students.find(s => s.id === studentId);
                    if (student) {
                        sendSMSReminder(student);
                    }
                });
            });
            
            document.querySelectorAll('.print-reminder').forEach(button => {
                button.addEventListener('click', function() {
                    const studentId = this.getAttribute('data-id');
                    generateReminderReceipt(studentId);
                    setTimeout(() => {
                        document.getElementById('print-reminder-receipt-btn').click();
                    }, 500);
                });
            });
            
            document.querySelectorAll('.add-payment').forEach(button => {
                button.addEventListener('click', function() {
                    const studentId = this.getAttribute('data-id');
                    addPaymentForStudent(studentId);
                });
            });
        }
        
        // Send SMS reminder
        function sendSMSReminder(student) {
            try {
                const totalFees = calculateTotalFees(student);
                const totalPaid = calculateTotalPaid(student.id);
                const balance = totalFees - totalPaid;
                
                if (balance <= 0) {
                    showInfo('No outstanding fees for this student');
                    return;
                }
                
                const message = `Dear ${student.parentName}, your child ${student.firstName} ${student.lastName} has outstanding fees of KES ${balance}. Kindly clear by due date. From ${appData.settings.schoolName}`;
                
                const smsLink = `sms:${student.parentPhone}?body=${encodeURIComponent(message)}`;
                window.open(smsLink, '_blank');
                
                showInfo(`SMS prepared for: ${student.parentPhone}`);
            } catch (error) {
                console.error('Error sending SMS:', error);
                showError('Failed to prepare SMS');
            }
        }
        
        // ============================================
        // MODAL FUNCTIONS
        // ============================================
        
        // View student details
        function viewStudent(studentId) {
            const student = appData.students.find(s => s.id === studentId);
            if (!student) {
                showError('Student not found');
                return;
            }
            
            const totalFees = calculateTotalFees(student);
            const totalPaid = calculateTotalPaid(studentId);
            const balance = totalFees - totalPaid;
            
            let feeItemsHTML = '';
            student.feeItems.forEach(feeItemId => {
                const feeItem = appData.feeItems.find(f => f.id === feeItemId);
                if (feeItem) {
                    const paidAmount = calculatePaidForFeeItem(studentId, feeItemId);
                    const feeBalance = feeItem.amount - paidAmount;
                    const dueDate = calculateDueDate(student, feeItemId);
                    const overdue = dueDate && isFeeOverdue(dueDate);
                    
                    feeItemsHTML += `
                        <div class="fee-balance-item">
                            <div>
                                <strong>${feeItem.name}</strong><br>
                                <small>Due: ${dueDate ? formatDate(dueDate) : 'N/A'} ${overdue ? '<span class="badge badge-danger">OVERDUE</span>' : ''}</small>
                            </div>
                            <div style="text-align: right;">
                                <div>Amount: <span class="currency">${formatCurrency(feeItem.amount)}</span></div>
                                <div>Paid: <span class="currency">${formatCurrency(paidAmount)}</span></div>
                                <div>Balance: <span class="currency">${formatCurrency(feeBalance)}</span></div>
                            </div>
                        </div>
                    `;
                }
            });
            
            const modalContent = `
                <div style="padding: 20px;">
                    <h3 style="color: var(--primary-color); margin-bottom: 20px;">Student Details</h3>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Student ID</label>
                            <div style="padding: 10px; background-color: #f8f9fa; border-radius: var(--border-radius);">${student.id}</div>
                        </div>
                        <div class="form-group">
                            <label>Full Name</label>
                            <div style="padding: 10px; background-color: #f8f9fa; border-radius: var(--border-radius);">${student.firstName} ${student.lastName}</div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Class</label>
                            <div style="padding: 10px; background-color: #f8f9fa; border-radius: var(--border-radius);">${student.class.toUpperCase()}</div>
                        </div>
                        <div class="form-group">
                            <label>Date of Birth</label>
                            <div style="padding: 10px; background-color: #f8f9fa; border-radius: var(--border-radius);">${student.dob ? formatDate(student.dob) : 'Not specified'}</div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Parent/Guardian</label>
                            <div style="padding: 10px; background-color: #f8f9fa; border-radius: var(--border-radius);">${student.parentName}</div>
                        </div>
                        <div class="form-group">
                            <label>Parent Phone</label>
                            <div style="padding: 10px; background-color: #f8f9fa; border-radius: var(--border-radius);">${student.parentPhone}</div>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Parent Email</label>
                            <div style="padding: 10px; background-color: #f8f9fa; border-radius: var(--border-radius);">${student.parentEmail || 'Not specified'}</div>
                        </div>
                        <div class="form-group">
                            <label>Address</label>
                            <div style="padding: 10px; background-color: #f8f9fa; border-radius: var(--border-radius);">${student.parentAddress || 'Not specified'}</div>
                        </div>
                    </div>
                    
                    <div style="margin: 20px 0; padding: 15px; background-color: #f8f9fa; border-radius: var(--border-radius);">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <div>
                                <strong>Total Fees:</strong> <span class="currency">${formatCurrency(totalFees)}</span>
                            </div>
                            <div>
                                <strong>Total Paid:</strong> <span class="currency">${formatCurrency(totalPaid)}</span>
                            </div>
                            <div>
                                <strong>Balance:</strong> <span class="currency">${formatCurrency(balance)}</span>
                            </div>
                        </div>
                    </div>
                    
                    <h4 style="margin: 20px 0 10px 0; color: var(--primary-color);">Fee Items</h4>
                    <div class="fee-balance-details">
                        ${feeItemsHTML}
                    </div>
                    
                    <div class="text-center mt-20">
                        <button class="btn-secondary close-modal">
                            Close
                            <span class="btn-notification"><i class="fas fa-times"></i></span>
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('confirm-title').textContent = 'Student Details';
            document.getElementById('confirm-message').innerHTML = modalContent;
            document.getElementById('confirm-ok').style.display = 'none';
            document.getElementById('confirm-cancel').textContent = 'Close';
            
            document.getElementById('confirm-modal').classList.add('active');
        }
        
        // Edit student modal
        function editStudentModal(studentId) {
            const student = appData.students.find(s => s.id === studentId);
            if (!student) {
                showError('Student not found');
                return;
            }
            
            document.getElementById('student-modal-title').textContent = 'Edit Student';
            document.getElementById('student-id').value = studentId;
            document.getElementById('first-name').value = student.firstName;
            document.getElementById('last-name').value = student.lastName;
            document.getElementById('student-class').value = student.class;
            document.getElementById('student-dob').value = student.dob || '';
            document.getElementById('parent-name').value = student.parentName;
            document.getElementById('parent-phone').value = student.parentPhone;
            document.getElementById('parent-email').value = student.parentEmail || '';
            document.getElementById('parent-address').value = student.parentAddress || '';
            
            loadFeeSelection();
            
            // Pre-select fee items
            setTimeout(() => {
                student.feeItems.forEach(feeItemId => {
                    const checkbox = document.getElementById(`fee-${feeItemId}`);
                    if (checkbox) {
                        checkbox.checked = true;
                    }
                });
            }, 100);
            
            document.getElementById('student-modal').classList.add('active');
        }
        
        // Add payment for student
        function addPaymentForStudent(studentId) {
            const student = appData.students.find(s => s.id === studentId);
            if (!student) {
                showError('Student not found');
                return;
            }
            
            document.getElementById('fee-modal-title').textContent = `Record Payment for ${student.firstName} ${student.lastName}`;
            document.getElementById('payment-student-id').value = studentId;
            document.getElementById('payment-student').value = studentId;
            
            loadFeePaymentSelection(studentId);
            document.getElementById('fee-modal').classList.add('active');
        }
        
        // View student receipts
        function viewStudentReceipts(studentId) {
            const student = appData.students.find(s => s.id === studentId);
            if (!student) {
                showError('Student not found');
                return;
            }
            
            const studentPayments = appData.feePayments.filter(p => p.studentId === studentId);
            
            if (studentPayments.length === 0) {
                showInfo('No payment history found for this student');
                return;
            }
            
            let receiptsHTML = '';
            const groupedPayments = {};
            
            // Group payments by receipt number
            studentPayments.forEach(payment => {
                if (!groupedPayments[payment.receiptNo]) {
                    groupedPayments[payment.receiptNo] = [];
                }
                groupedPayments[payment.receiptNo].push(payment);
            });
            
            Object.keys(groupedPayments).forEach(receiptNo => {
                const payments = groupedPayments[receiptNo];
                const totalAmount = payments.reduce((sum, p) => sum + p.amount, 0);
                const firstPayment = payments[0];
                
                receiptsHTML += `
                    <div style="padding: 15px; background-color: white; border-radius: var(--border-radius); margin-bottom: 15px; border: 1px solid #eee;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div>
                                <strong>Receipt No:</strong> ${receiptNo}<br>
                                <strong>Date:</strong> ${formatDate(firstPayment.date)}<br>
                                <strong>Method:</strong> ${firstPayment.paymentMethod}
                            </div>
                            <div style="text-align: right;">
                                <div class="currency" style="font-size: 1.2rem; font-weight: bold; color: var(--success-color);">${formatCurrency(totalAmount)}</div>
                                <button class="btn-icon btn-secondary btn-small view-receipt-details" data-receipt="${receiptNo}">
                                    <i class="fas fa-eye"></i> View Details
                                    <span class="btn-notification"><i class="fas fa-check"></i></span>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            const modalContent = `
                <div style="padding: 20px;">
                    <h3 style="color: var(--primary-color); margin-bottom: 20px;">Payment History for ${student.firstName} ${student.lastName}</h3>
                    <div style="margin-bottom: 20px; padding: 15px; background-color: #f8f9fa; border-radius: var(--border-radius);">
                        <div style="display: flex; justify-content: space-between;">
                            <div>
                                <strong>Student:</strong> ${student.firstName} ${student.lastName}<br>
                                <strong>Class:</strong> ${student.class.toUpperCase()}<br>
                                <strong>Total Paid:</strong> <span class="currency">${formatCurrency(calculateTotalPaid(studentId))}</span>
                            </div>
                            <div style="text-align: right;">
                                <strong>Total Fees:</strong> <span class="currency">${formatCurrency(calculateTotalFees(student))}</span><br>
                                <strong>Balance:</strong> <span class="currency">${formatCurrency(calculateTotalFees(student) - calculateTotalPaid(studentId))}</span>
                            </div>
                        </div>
                    </div>
                    <h4 style="margin: 20px 0 10px 0; color: var(--primary-color);">Payment Receipts</h4>
                    ${receiptsHTML}
                    <div class="text-center mt-20">
                        <button class="btn-secondary close-modal">
                            Close
                            <span class="btn-notification"><i class="fas fa-times"></i></span>
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('confirm-title').textContent = 'Payment History';
            document.getElementById('confirm-message').innerHTML = modalContent;
            document.getElementById('confirm-ok').style.display = 'none';
            document.getElementById('confirm-cancel').textContent = 'Close';
            
            document.getElementById('confirm-modal').classList.add('active');
            
            // Add event listeners to view receipt details buttons
            setTimeout(() => {
                document.querySelectorAll('.view-receipt-details').forEach(button => {
                    button.addEventListener('click', function() {
                        const receiptNo = this.getAttribute('data-receipt');
                        viewReceiptDetails(receiptNo);
                    });
                });
            }, 100);
        }
        
        // View receipt details
        function viewReceiptDetails(receiptNo) {
            const payments = appData.feePayments.filter(p => p.receiptNo === receiptNo);
            
            if (payments.length === 0) {
                showError('Receipt not found');
                return;
            }
            
            const firstPayment = payments[0];
            const student = appData.students.find(s => s.id === firstPayment.studentId);
            
            if (!student) {
                showError('Student not found');
                return;
            }
            
            const selectedFeeItems = payments.map(payment => ({
                feeItemId: payment.feeItemId,
                amount: payment.amount
            }));
            
            generateReceipt({
                receiptNo: receiptNo,
                studentId: firstPayment.studentId,
                date: firstPayment.date,
                paymentMethod: firstPayment.paymentMethod,
                reference: firstPayment.reference,
                notes: firstPayment.notes,
                selectedFeeItems: selectedFeeItems,
                totalAmount: payments.reduce((sum, p) => sum + p.amount, 0)
            });
        }
        
        // Delete student confirmation
        function deleteStudentConfirmation(studentId) {
            const student = appData.students.find(s => s.id === studentId);
            if (!student) {
                showError('Student not found');
                return;
            }
            
            document.getElementById('confirm-title').textContent = 'Delete Student';
            document.getElementById('confirm-message').textContent = `Are you sure you want to delete ${student.firstName} ${student.lastName}? This action cannot be undone.`;
            document.getElementById('confirm-ok').style.display = 'inline-flex';
            document.getElementById('confirm-cancel').textContent = 'Cancel';
            
            document.getElementById('confirm-modal').classList.add('active');
            
            document.getElementById('confirm-ok').onclick = function() {
                deleteStudent(studentId);
                document.getElementById('confirm-modal').classList.remove('active');
            };
        }
        
        // Delete fee item confirmation
        function deleteFeeItemConfirmation(feeItemId) {
            const feeItem = appData.feeItems.find(f => f.id === feeItemId);
            if (!feeItem) {
                showError('Fee item not found');
                return;
            }
            
            document.getElementById('confirm-title').textContent = 'Delete Fee Item';
            document.getElementById('confirm-message').textContent = `Are you sure you want to delete "${feeItem.name}"? This action cannot be undone.`;
            document.getElementById('confirm-ok').style.display = 'inline-flex';
            document.getElementById('confirm-cancel').textContent = 'Cancel';
            
            document.getElementById('confirm-modal').classList.add('active');
            
            document.getElementById('confirm-ok').onclick = function() {
                deleteFeeItem(feeItemId);
                document.getElementById('confirm-modal').classList.remove('active');
            };
        }
        
        // Edit fee item
        function editFeeItem(feeItemId) {
            const feeItem = appData.feeItems.find(f => f.id === feeItemId);
            if (!feeItem) {
                showError('Fee item not found');
                return;
            }
            
            document.getElementById('fee-item-id').value = feeItemId;
            document.getElementById('fee-item-name').value = feeItem.name;
            document.getElementById('fee-item-amount').value = feeItem.amount;
            document.getElementById('fee-item-category').value = feeItem.category || 'tuition';
            document.getElementById('fee-item-description').value = feeItem.description || '';
            document.getElementById('fee-item-due-days').value = feeItem.dueDays || '';
            document.getElementById('fee-item-term').value = feeItem.term || 'all';
            document.getElementById('fee-item-required').checked = feeItem.isRequired || false;
            document.getElementById('fee-item-active').checked = feeItem.active !== false;
            
            document.getElementById('fee-item-form-container').classList.add('active');
            document.getElementById('fee-item-form-container').scrollIntoView({ behavior: 'smooth' });
        }
        
        // ============================================
        // PRINT FUNCTIONS
        // ============================================
        
        // Print dashboard report
        function printDashboardReport() {
            const originalTitle = document.getElementById('page-title').textContent;
            document.getElementById('page-title').textContent = 'Dashboard Overview Report';
            
            window.print();
            
            document.getElementById('page-title').textContent = originalTitle;
        }
        
        // Print student register
        function printStudentRegister() {
            const originalTitle = document.getElementById('page-title').textContent;
            document.getElementById('page-title').textContent = 'Student Register Report';
            
            window.print();
            
            document.getElementById('page-title').textContent = originalTitle;
        }
        
        // Print fee register
        function printFeeRegister() {
            const originalTitle = document.getElementById('page-title').textContent;
            document.getElementById('page-title').textContent = 'Fee Register Report';
            
            window.print();
            
            document.getElementById('page-title').textContent = originalTitle;
        }
        
        // Print all reminders
        function printAllReminders() {
            const originalTitle = document.getElementById('page-title').textContent;
            document.getElementById('page-title').textContent = 'Fee Reminders Report';
            
            window.print();
            
            document.getElementById('page-title').textContent = originalTitle;
        }
        
        // Print overdue reminders
        function printOverdueReminders() {
            const originalTitle = document.getElementById('page-title').textContent;
            document.getElementById('page-title').textContent = 'Overdue Fee Reminders Report';
            
            // Temporarily filter to show only overdue
            const originalFilter = document.getElementById('reminder-status-filter').value;
            document.getElementById('reminder-status-filter').value = 'overdue';
            loadFeeReminders('all', 'all', 'overdue');
            
            setTimeout(() => {
                window.print();
                
                // Restore original filter
                document.getElementById('reminder-status-filter').value = originalFilter;
                loadFeeReminders('all', 'all', originalFilter);
                document.getElementById('page-title').textContent = originalTitle;
            }, 500);
        }
        
        // Print receipt
        function printReceipt() {
            const printWindow = window.open('', '_blank');
            const receiptContent = document.getElementById('receipt-content').innerHTML;
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Payment Receipt</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        .receipt-container { max-width: 800px; margin: 0 auto; }
                        .receipt-header { text-align: center; margin-bottom: 30px; }
                        .receipt-logo { width: 100px; height: 100px; margin: 0 auto 15px; }
                        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        th, td { padding: 10px; border: 1px solid #000; }
                        th { background-color: #f2f2f2; }
                        .currency { font-family: 'Courier New', monospace; }
                        @media print {
                            body { padding: 0; }
                            .no-print { display: none; }
                        }
                    </style>
                </head>
                <body>
                    ${receiptContent}
                    <div class="no-print" style="text-align: center; margin-top: 30px;">
                        <button onclick="window.print()" style="padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">Print Receipt</button>
                        <button onclick="window.close()" style="padding: 10px 20px; background-color: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer; margin-left: 10px;">Close</button>
                    </div>
                </body>
                </html>
            `);
            
            printWindow.document.close();
        }
        
        // Print reminder receipt
        function printReminderReceipt() {
            const printWindow = window.open('', '_blank');
            const receiptContent = document.getElementById('reminder-receipt-content').innerHTML;
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Fee Reminder</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        .reminder-receipt { max-width: 800px; margin: 0 auto; }
                        .reminder-receipt-header { text-align: center; margin-bottom: 30px; }
                        .receipt-logo { width: 100px; height: 100px; margin: 0 auto 15px; }
                        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        th, td { padding: 10px; border: 1px solid #000; }
                        th { background-color: #f2f2f2; }
                        .currency { font-family: 'Courier New', monospace; }
                        @media print {
                            body { padding: 0; }
                            .no-print { display: none; }
                        }
                    </style>
                </head>
                <body>
                    ${receiptContent}
                    <div class="no-print" style="text-align: center; margin-top: 30px;">
                        <button onclick="window.print()" style="padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">Print Reminder</button>
                        <button onclick="window.close()" style="padding: 10px 20px; background-color: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer; margin-left: 10px;">Close</button>
                    </div>
                </body>
                </html>
            `);
            
            printWindow.document.close();
        }
        
        // ============================================
        // EVENT LISTENERS
        // ============================================
        
        // Login form submission
        loginForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const loginButton = document.getElementById('login-submit-btn');
            
            if (username === ADMIN_CREDENTIALS.username && password === ADMIN_CREDENTIALS.password) {
                showButtonNotification(loginButton, true, 'Login successful!');
                
                setTimeout(() => {
                    loginScreen.style.display = 'none';
                    appContainer.classList.remove('hidden');
                    
                    loadFromLocalStorage();
                    initializeUI();
                    
                    showSuccess('Welcome to Edu-Track CBE Pro!');
                }, 1000);
            } else {
                showButtonNotification(loginButton, false, 'Invalid credentials');
                showError('Invalid username or password');
            }
        });
        
        // Mobile menu toggle
        mobileMenuToggle.addEventListener('click', function() {
            sidebar.classList.toggle('active');
            showButtonNotification(this, true, 'Menu toggled');
        });
        
        // Menu item clicks
        menuItems.forEach(item => {
            item.addEventListener('click', function() {
                const target = this.getAttribute('data-target');
                
                // Update active menu item
                menuItems.forEach(mi => mi.classList.remove('active'));
                this.classList.add('active');
                
                // Update active content area
                contentAreas.forEach(area => area.classList.remove('active'));
                document.getElementById(target).classList.add('active');
                
                // Update page title
                const pageTitle = document.getElementById('page-title');
                switch(target) {
                    case 'dashboard':
                        pageTitle.textContent = 'Dashboard Overview';
                        updateDashboardStats();
                        break;
                    case 'student-register':
                        pageTitle.textContent = 'Student Register';
                        break;
                    case 'fee-register':
                        pageTitle.textContent = 'Fee Register';
                        break;
                    case 'fee-reminders':
                        pageTitle.textContent = 'Fee Reminders';
                        break;
                    case 'fee-setting':
                        pageTitle.textContent = 'Fee Structure Management';
                        break;
                    case 'app-setting':
                        pageTitle.textContent = 'Application Settings';
                        break;
                    case 'data-management':
                        pageTitle.textContent = 'Data Management';
                        break;
                }
                
                // Close mobile menu if open
                if (window.innerWidth <= 992) {
                    sidebar.classList.remove('active');
                }
                
                showButtonNotification(this, true, 'Section loaded');
            });
        });
        
        // Close modal buttons
        document.querySelectorAll('.close-modal').forEach(button => {
            button.addEventListener('click', function() {
                this.closest('.modal').classList.remove('active');
            });
        });
        
        // Student form submission
        document.getElementById('student-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const studentId = document.getElementById('student-id').value;
            const studentData = {
                firstName: document.getElementById('first-name').value,
                lastName: document.getElementById('last-name').value,
                class: document.getElementById('student-class').value,
                dob: document.getElementById('student-dob').value || null,
                parentName: document.getElementById('parent-name').value,
                parentPhone: document.getElementById('parent-phone').value,
                parentEmail: document.getElementById('parent-email').value || null,
                parentAddress: document.getElementById('parent-address').value || null
            };
            
            const saveButton = document.getElementById('save-student-btn');
            
            if (studentId) {
                // Edit existing student
                if (editStudent(studentId, studentData)) {
                    showButtonNotification(saveButton, true, 'Student updated');
                    document.getElementById('student-modal').classList.remove('active');
                } else {
                    showButtonNotification(saveButton, false, 'Update failed');
                }
            } else {
                // Add new student
                const newStudentId = addStudent(studentData);
                if (newStudentId) {
                    showButtonNotification(saveButton, true, 'Student added');
                    document.getElementById('student-modal').classList.remove('active');
                } else {
                    showButtonNotification(saveButton, false, 'Add failed');
                }
            }
        });
        
        // Fee form submission
        document.getElementById('fee-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const studentId = document.getElementById('payment-student').value;
            const selectedFeeItems = [];
            
            document.querySelectorAll('.fee-payment-item.selected').forEach(item => {
                const feeItemId = item.getAttribute('data-id');
                const input = item.querySelector('.fee-amount-input');
                const amount = parseFloat(input.value) || 0;
                
                if (amount > 0) {
                    selectedFeeItems.push({
                        feeItemId: feeItemId,
                        amount: amount
                    });
                }
            });
            
            if (selectedFeeItems.length === 0) {
                showError('Please select at least one fee item to pay');
                return;
            }
            
            const paymentData = {
                studentId: studentId,
                date: document.getElementById('payment-date').value,
                paymentMethod: document.getElementById('payment-method').value,
                reference: document.getElementById('payment-reference').value || null,
                notes: document.getElementById('payment-notes').value || null,
                selectedFeeItems: selectedFeeItems
            };
            
            const saveButton = document.getElementById('save-payment-btn');
            
            if (addFeePayment(paymentData)) {
                showButtonNotification(saveButton, true, 'Payment recorded');
                document.getElementById('fee-modal').classList.remove('active');
                document.getElementById('fee-form').reset();
                document.getElementById('payment-date').value = getCurrentDate();
            } else {
                showButtonNotification(saveButton, false, 'Payment failed');
            }
        });
        
        // Fee item form submission
        document.getElementById('fee-item-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const feeItemData = {
                name: document.getElementById('fee-item-name').value,
                amount: parseFloat(document.getElementById('fee-item-amount').value),
                category: document.getElementById('fee-item-category').value,
                description: document.getElementById('fee-item-description').value || '',
                dueDays: document.getElementById('fee-item-due-days').value ? parseInt(document.getElementById('fee-item-due-days').value) : null,
                term: document.getElementById('fee-item-term').value,
                isRequired: document.getElementById('fee-item-required').checked,
                active: document.getElementById('fee-item-active').checked
            };
            
            const saveButton = document.getElementById('save-fee-item');
            
            if (saveFeeItem(feeItemData)) {
                showButtonNotification(saveButton, true, 'Fee item saved');
            } else {
                showButtonNotification(saveButton, false, 'Save failed');
            }
        });
        
        // Add new student button
        document.getElementById('add-student-btn').addEventListener('click', function() {
            document.getElementById('student-modal-title').textContent = 'Add New Student';
            document.getElementById('student-form').reset();
            document.getElementById('student-id').value = '';
            
            loadFeeSelection();
            document.getElementById('student-modal').classList.add('active');
            showButtonNotification(this, true, 'Add student form opened');
        });
        
        // Add new fee transaction button
        document.getElementById('add-fee-transaction').addEventListener('click', function() {
            document.getElementById('fee-modal-title').textContent = 'Record Fee Payment';
            document.getElementById('fee-form').reset();
            document.getElementById('payment-id').value = '';
            document.getElementById('payment-student-id').value = '';
            document.getElementById('payment-date').value = getCurrentDate();
            
            loadFeePaymentSelection();
            document.getElementById('fee-modal').classList.add('active');
            showButtonNotification(this, true, 'Add payment form opened');
        });
        
        // Add new fee item button
        document.getElementById('add-new-fee-item').addEventListener('click', function() {
            document.getElementById('fee-item-form').reset();
            document.getElementById('fee-item-id').value = '';
            document.getElementById('fee-item-active').checked = true;
            
            document.getElementById('fee-item-form-container').classList.add('active');
            document.getElementById('fee-item-form-container').scrollIntoView({ behavior: 'smooth' });
            showButtonNotification(this, true, 'Add fee item form opened');
        });
        
        // Clear fee form button
        document.getElementById('clear-fee-form').addEventListener('click', function() {
            document.getElementById('fee-item-form').reset();
            document.getElementById('fee-item-id').value = '';
            showButtonNotification(this, true, 'Form cleared');
        });
        
        // Save app settings button
        document.getElementById('save-app-settings').addEventListener('click', function() {
            if (saveAppSettings()) {
                showButtonNotification(this, true, 'Settings saved');
            } else {
                showButtonNotification(this, false, 'Save failed');
            }
        });
        
        // Save fee settings button
        document.getElementById('save-fee-settings').addEventListener('click', function() {
            saveToLocalStorage();
            showButtonNotification(this, true, 'All changes saved');
        });
        
        // Test cloud connection button
        document.getElementById('test-connection').addEventListener('click', async function() {
            if (await testCloudConnection()) {
                showButtonNotification(this, true, 'Connection successful');
            } else {
                showButtonNotification(this, false, 'Connection failed');
            }
        });
        
        // Save cloud settings button
        document.getElementById('save-cloud-settings').addEventListener('click', function() {
            if (saveCloudSettings()) {
                showButtonNotification(this, true, 'Cloud settings saved');
            } else {
                showButtonNotification(this, false, 'Save failed');
            }
        });
        
        // Sync now button
        document.getElementById('sync-now').addEventListener('click', async function() {
            if (await syncToCloud()) {
                showButtonNotification(this, true, 'Sync successful');
            } else {
                showButtonNotification(this, false, 'Sync failed');
            }
        });
        
        // Sync to cloud button
        document.getElementById('sync-to-cloud').addEventListener('click', async function() {
            if (await syncToCloud()) {
                showButtonNotification(this, true, 'Sync successful');
            } else {
                showButtonNotification(this, false, 'Sync failed');
            }
        });
        
        // Backup data button
        document.getElementById('backup-data').addEventListener('click', function() {
            if (exportDataToJson()) {
                showButtonNotification(this, true, 'Backup created');
            } else {
                showButtonNotification(this, false, 'Backup failed');
            }
        });
        
        // Export data button
        document.getElementById('export-data').addEventListener('click', function() {
            if (exportDataToJson()) {
                showButtonNotification(this, true, 'Data exported');
            } else {
                showButtonNotification(this, false, 'Export failed');
            }
        });
        
        // Import data button
        document.getElementById('import-data').addEventListener('click', function() {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.json';
            
            fileInput.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    importDataFromJson(file);
                }
            };
            
            fileInput.click();
            showButtonNotification(this, true, 'Import dialog opened');
        });
        
        // Clear data button
        document.getElementById('clear-data').addEventListener('click', function() {
            document.getElementById('confirm-title').textContent = 'Clear All Data';
            document.getElementById('confirm-message').textContent = 'Are you sure you want to clear ALL data? This action cannot be undone and will delete all students, payments, and settings.';
            document.getElementById('confirm-ok').style.display = 'inline-flex';
            document.getElementById('confirm-cancel').textContent = 'Cancel';
            
            document.getElementById('confirm-modal').classList.add('active');
            
            document.getElementById('confirm-ok').onclick = function() {
                clearAllData();
                document.getElementById('confirm-modal').classList.remove('active');
            };
            
            showButtonNotification(this, false, 'Warning: This will delete all data');
        });
        
        // Print buttons
        document.getElementById('print-dashboard').addEventListener('click', function() {
            printDashboardReport();
            showButtonNotification(this, true, 'Printing dashboard report');
        });
        
        document.getElementById('print-dashboard-table').addEventListener('click', function() {
            printDashboardReport();
            showButtonNotification(this, true, 'Printing dashboard table');
        });
        
        document.getElementById('print-student-register').addEventListener('click', function() {
            printStudentRegister();
            showButtonNotification(this, true, 'Printing student register');
        });
        
        document.getElementById('print-fee-register').addEventListener('click', function() {
            printFeeRegister();
            showButtonNotification(this, true, 'Printing fee register');
        });
        
        document.getElementById('print-all-reminders').addEventListener('click', function() {
            printAllReminders();
            showButtonNotification(this, true, 'Printing all reminders');
        });
        
        document.getElementById('print-overdue-reminders').addEventListener('click', function() {
            printOverdueReminders();
            showButtonNotification(this, true, 'Printing overdue reminders');
        });
        
        document.getElementById('print-receipt-btn').addEventListener('click', function() {
            printReceipt();
            showButtonNotification(this, true, 'Printing receipt');
        });
        
        document.getElementById('print-reminder-receipt-btn').addEventListener('click', function() {
            printReminderReceipt();
            showButtonNotification(this, true, 'Printing reminder');
        });
        
        // Send all reminders button
        document.getElementById('send-all-reminders').addEventListener('click', function() {
            const studentsWithBalance = appData.students.filter(student => {
                const totalFees = calculateTotalFees(student);
                const totalPaid = calculateTotalPaid(student.id);
                return totalFees - totalPaid > 0;
            });
            
            if (studentsWithBalance.length === 0) {
                showInfo('No students with outstanding fees');
                return;
            }
            
            document.getElementById('confirm-title').textContent = 'Send All Reminders';
            document.getElementById('confirm-message').textContent = `Send fee reminders to ${studentsWithBalance.length} student(s) with outstanding fees?`;
            document.getElementById('confirm-ok').style.display = 'inline-flex';
            document.getElementById('confirm-cancel').textContent = 'Cancel';
            
            document.getElementById('confirm-modal').classList.add('active');
            
            document.getElementById('confirm-ok').onclick = function() {
                let sentCount = 0;
                studentsWithBalance.forEach(student => {
                    if (student.parentEmail) {
                        generateReminderReceipt(student.id);
                        setTimeout(() => {
                            document.getElementById('send-reminder-email-btn').click();
                        }, 100 * sentCount);
                        sentCount++;
                    }
                });
                
                if (sentCount > 0) {
                    showSuccess(`Prepared ${sentCount} email(s) for sending`);
                } else {
                    showInfo('No email addresses found for students with outstanding fees');
                }
                
                document.getElementById('confirm-modal').classList.remove('active');
            };
            
            showButtonNotification(this, true, 'Preparing to send reminders');
        });
        
        // Student filter apply button
        document.getElementById('apply-student-filter').addEventListener('click', function() {
            const filterClass = document.getElementById('student-class-filter').value;
            const searchTerm = document.getElementById('student-search').value;
            loadStudentsTable(filterClass, searchTerm);
            showButtonNotification(this, true, 'Filters applied');
        });
        
        // Fee filter apply button
        document.getElementById('apply-fee-filter').addEventListener('click', function() {
            const filterClass = document.getElementById('fee-class-filter').value;
            const filterStudent = document.getElementById('fee-student-filter').value;
            loadFeeRegisterTable(filterClass, filterStudent);
            showButtonNotification(this, true, 'Filters applied');
        });
        
        // Reminder filter apply button
        document.getElementById('apply-reminder-filter').addEventListener('click', function() {
            const filterClass = document.getElementById('reminder-class-filter').value;
            const filterStudent = document.getElementById('reminder-student-filter').value;
            const filterStatus = document.getElementById('reminder-status-filter').value;
            loadFeeReminders(filterClass, filterStudent, filterStatus);
            showButtonNotification(this, true, 'Filters applied');
        });
        
        // Student search input
        document.getElementById('student-search').addEventListener('keyup', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('apply-student-filter').click();
            }
        });
        
        // Payment student select change
        document.getElementById('payment-student').addEventListener('change', function() {
            const studentId = this.value;
            loadFeePaymentSelection(studentId);
        });
        
        // Upload logo button
        document.getElementById('upload-logo-btn').addEventListener('click', function() {
            document.getElementById('logo-upload').click();
        });
        
        // Logo upload
        document.getElementById('logo-upload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    // For simplicity, we'll just set the URL input
                    // In a real app, you would upload to a server
                    document.getElementById('school-logo').value = e.target.result;
                    document.getElementById('logo-preview').innerHTML = `<img src="${e.target.result}" class="school-logo-display" alt="School Logo">`;
                    showInfo('Logo loaded locally. Save settings to apply.');
                };
                reader.readAsDataURL(file);
            }
        });
        
        // Confirm cancel button
        document.getElementById('confirm-cancel').addEventListener('click', function() {
            document.getElementById('confirm-modal').classList.remove('active');
            showButtonNotification(this, false, 'Action cancelled');
        });
        
        // ============================================
        // INITIALIZATION
        // ============================================
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Set current date in date inputs
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('payment-date').value = today;
            document.getElementById('student-dob').value = today;
            
            // Load initial data
            loadFromLocalStorage();
            
            // Show login screen
            loginScreen.style.display = 'flex';
            appContainer.classList.add('hidden');
            
            // Set focus to username field
            document.getElementById('username').focus();
            
            console.log(`${APP_CONFIG.APP_NAME} v${APP_CONFIG.VERSION} loaded successfully`);
        });
        
        // ============================================
        // WINDOW EVENT LISTENERS
        // ============================================
        
        // Close modals when clicking outside
        window.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                e.target.classList.remove('active');
            }
        });
        
        // Handle window resize for responsive sidebar
        window.addEventListener('resize', function() {
            if (window.innerWidth > 992) {
                sidebar.classList.remove('active');
            }
        });
    </script>
</body>
</html>